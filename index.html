<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>é«˜ä¸­è·å°è«–æ–‡æ ¼å¼è‡ªæª¢ç³»çµ±</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
:root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--ok:#059669;--bad:#b91c1c;--bdr:#e5e7eb}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
.wrap{max-width:980px;margin:auto;padding:24px}
header h1{margin:0 0 6px;font-size:clamp(22px,4vw,28px)}
header .meta{margin:0 0 12px;color:var(--muted);font-size:13px}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.hint{color:var(--muted);font-size:13px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
button{padding:.7rem 1.05rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:transparent}
button:disabled{opacity:.5;cursor:not-allowed}
a.btn-gpt{background:#f3e8ff;border:1px solid #e9d5ff;border-radius:10px;color:#3b0764;padding:.7rem 1.05rem;text-decoration:none;font-weight:600}
button.danger{background:#dc2626;color:#fff;border-color:#b91c1c}
a.btn-violet{background:#f3e8ff;border:1.5px solid #c4b5fd;color:#4c1d95;border-radius:10px;padding:.7rem 1.05rem;text-decoration:none;font-weight:700}
a.btn-violet:hover{background:#ede9fe;border-color:#a78bfa}
.step{display:grid;grid-template-columns:34px 1fr;gap:10px;align-items:start}
.step .no{display:flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:999px;background:#eef2ff;border:1px solid var(--bdr);font-weight:700}
.drop{border:2px dashed #cbd5e1;border-radius:12px;padding:22px;text-align:center;background:#fafafa;margin-top:8px}
.drop[aria-disabled="true"]{opacity:.7;filter:grayscale(.1)}
input[type=file]{display:none}
label.file{display:inline-flex;gap:.6rem;padding:.65rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid var(--bdr);padding:8px 10px;text-align:left;vertical-align:top}
th{background:#f9fafb}
.badge-ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.15rem .5rem;border-radius:999px;font-size:12px}
.badge-bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.15rem .5rem;border-radius:999px;font-size:12px}
.num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:6px;border-radius:999px;background:#eef2ff;border:1px solid var(--bdr);font-size:12px;color:#374151;font-weight:600}
footer{margin-top:24px;text-align:center;color:#6b7280;font-size:13px}
.margin-preview{margin-top:8px}
.margin-preview .legend{display:flex;gap:10px;align-items:center;font-size:12px;color:#374151;margin:6px 0}
.margin-preview .dot{display:inline-block;width:10px;height:10px;border-radius:2px;border:2px solid #111}
.margin-preview .dot.red{border-color:#be123c;border-style:dashed}
.margin-preview .dot.blue{border-color:#1d4ed8;border-style:dashed}
.extsearch{margin-top:14px;border-top:1px dashed #e5e7eb;padding-top:12px}
.extsearch .row{gap:8px}
.extsearch a[data-extlink]{text-decoration:none}
</style>

<!-- pdf.js å‚™æ´ -->
<script type="module">
  window.loadPdfjs = async () => {
    const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
    const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
    GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
    return { getDocument };
  };
</script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>é«˜ä¸­è·å°è«–æ–‡æ ¼å¼è‡ªæª¢ç³»çµ±</h1>
    <p class="meta">
      ç›®å‰ç´¯ç©è‡ªæª¢äººæ¬¡ï¼š<b id="counter">è¼‰å…¥ä¸­â€¦</b>
      <span class="mono">ï½œv=2025-11-03a</span>
      ï½œÂ© 2025 CTVS å‡¡äº‹çš†æ­£é¢
    </p>
  </header>

  <!-- Step 1 -->
  <section class="card">
    <div class="step">
      <div class="no">1</div>
      <div>
        <h3 style="margin:4px 0 8px">åŒæ„èˆ‡ä¸Šå‚³</h3>
        <div class="row" style="margin-top:8px">
          <input id="consent" type="checkbox"/>
          <label for="consent">æˆ‘å·²é–±è®€ä¸¦åŒæ„ï¼Œä¸”ç¢ºèªæª”æ¡ˆä¸å« <span class="mono">æ ¡å/å§“å</span>ã€‚</label>
        </div>
        <div id="drop" class="drop" aria-disabled="true">
          <p><strong>æ‹–æ‹‰ PDF åˆ°é€™è£¡</strong></p>
          <label for="file" class="file">é¸æ“‡æª”æ¡ˆ</label>
          <input id="file" type="file" accept=".pdf" disabled/>
          <p class="hint" id="status">è«‹å…ˆå‹¾é¸åŒæ„ã€‚</p>
        </div>
        <p class="hint" style="color:#444;font-size:14px;margin-top:6px;line-height:1.6;">
          ğŸ’¡ å»ºè­°ï¼šå„ªå…ˆç”¨ <b>Cloud Run é€é é‚Šç•Œ</b>ï¼Œå¤±æ•—æ™‚æ‰å•Ÿç”¨<b>å‰ç«¯å‚™æ´</b>ï¼›å†ç”¨ <b>å­—é«”é€²éš</b> èˆ‡ <b>GPT B å…¨é¢åˆ†æ</b> äº¤å‰é©—è­‰ã€‚
        </p>
      </div>
    </div>
  </section>

  <!-- Step 2 -->
  <section class="card">
    <div class="step">
      <div class="no">2</div>
      <div>
        <h3 style="margin:4px 0 8px">åŸ·è¡Œæª¢æŸ¥</h3>
        <div class="row">
          <button id="start" class="primary" disabled>é–‹å§‹æª¢æŸ¥ï¼ˆé‚Šç•Œï¼šServer å„ªå…ˆï¼‰</button>
          <button id="fontCheckBtn" disabled>å­—é«”å­—å‹é€²éšæª¢æŸ¥ï¼ˆCloud Runï¼‰</button>
          <label style="display:inline-flex;gap:6px;align-items:center;margin-left:6px">
            <input id="strictMode" type="checkbox"/>
            è©•å¯©åš´æ ¼æ¨¡å¼ï¼ˆåªèªæ–°ç´°æ˜é«”/Timesï¼‰
          </label>
          <a id="gptB" class="btn-gpt" target="_blank" rel="noopener" href="#">å–®ç¨ GPT æª¢æŸ¥ PDFï¼ˆGPT Bï¼‰</a>
          <a id="gptA" class="btn-violet" target="_blank" rel="noopener" href="#">AI å°åŠ©æ‰‹ï¼ˆGPT Aï¼‰</a>
          <button id="clearTop" class="danger">æ¸…é™¤</button>
        </div>
        <p class="hint">ğŸ” å«ã€Œå°è«–æ–‡è©•åˆ†è¡¨ã€ä¹‹é å°‡è¢«<strong>å®Œæ•´ç•¥é</strong>ï¼šä¸ç´å…¥å…¨æ–‡ã€é æ•¸ã€é ç¢¼èˆ‡é‚Šç•Œç­‰ä»»ä½•æª¢æŸ¥ã€‚</p>
      </div>
    </div>
  </section>

  <!-- Step 3 -->
  <section class="card" id="resultCard" style="display:none">
    <div class="step">
      <div class="no">3</div>
      <div>
        <h3 style="margin:4px 0 8px">æª¢æŸ¥çµæœ</h3>
        <div id="fileTag" class="hint" style="margin:6px 0 12px"></div>
        <table>
          <thead><tr><th>è¦å‰‡</th><th>çµæœ</th><th>è­‰æ“š / èªªæ˜</th><th>å»ºè­°</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>

        <div id="extSearchPanel" class="extsearch" style="display:none">
          <h4 style="margin:10px 0 6px">#4 å¤–éƒ¨æª¢ç´¢åŠ©æ‰‹ï¼ˆçµ¦ AI å°åŠ©æ‰‹ï¼‰</h4>
          <div class="row">
            <button id="btnOpenAllSearch">ä¸€éµé–‹å•Ÿæ‰€æœ‰æœå°‹</button>
            <button id="btnCopyGptPrompt" class="btn-violet">è¤‡è£½æŸ¥æ ¸æç¤ºï¼ˆçµ¦ AI å°åŠ©æ‰‹ï¼‰</button>
          </div>
          <ol id="searchLinks" style="margin:10px 0 6px;padding-left:20px"></ol>
          <details style="margin-top:6px">
            <summary>é¡¯ç¤ºæœ¬æ¬¡æª¢æŸ¥æ‘˜è¦ JSONï¼ˆæœƒä¸€ä½µè¤‡è£½çµ¦ GPTï¼‰</summary>
            <pre id="jsonPreview" class="mono" style="white-space:pre-wrap;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:10px;max-height:280px;overflow:auto"></pre>
          </details>
          <details open style="margin-top:10px;border-top:1px dashed #ddd;padding-top:8px">
            <summary><b>AI å°åŠ©æ‰‹çµæœæ‘˜è¦ï¼ˆè§£é‡‹ç‰ˆï¼‰</b></summary>
            <div id="aiSummaryReadable" style="white-space:pre-wrap;font-size:13px;line-height:1.6;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px;"></div>
          </details>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="downloadHtml">ä¸‹è¼‰æª¢æŸ¥çµæœï¼ˆç¶²é ï¼‰</button>
          <button id="clearAll" class="danger">æ¸…é™¤ï¼ˆå›åˆ°åˆå§‹ç•«é¢ï¼‰</button>
        </div>
      </div>
    </div>
  </section>

  <footer>Â© 2025 CTVS å‡¡äº‹çš†æ­£é¢ Â· v=2025-11-03a</footer>
</div>

<script>
/* ====== ä¾ä½ å¯¦éš›éƒ¨ç½²èª¿æ•´ ====== */
const MARGIN_API = "https://margin-check-service-xxxxx.asia-east1.run.app/check";
const FONT_API   = "https://font-check-api-xxxxx.asia-east1.run.app/check";
const GAS_WEB_APP_URL = ""; // è‹¥ä¸ç”¨äººæ¬¡çµ±è¨ˆå¯ç•™ç©º
const ENABLE_COUNTER = false;

/* å°å·¥å…· */
async function fetchWithTimeout(url, options = {}, timeoutMs = 20000){
  const c = new AbortController(); const id = setTimeout(()=>c.abort(), timeoutMs);
  try{ return await fetch(url,{...options,signal:c.signal}); } finally{ clearTimeout(id); }
}
const CM_TO_PT = cm => cm * 72 / 2.54;
const PT_TO_CM = pt => pt * 2.54 / 72;
const fmtCM = v => (isFinite(v) ? PT_TO_CM(v).toFixed(3) : 'â€”');
const BASE_CM=2.0, TOL_CM=0.2, MICRO_TOL_PT=0.8;
const RANGE_MIN_PT=CM_TO_PT(BASE_CM - TOL_CM), RANGE_MAX_PT=CM_TO_PT(BASE_CM + TOL_CM);
const within = v => isFinite(v) && v >= (RANGE_MIN_PT - MICRO_TOL_PT) && v <= (RANGE_MAX_PT + MICRO_TOL_PT);

/* å­—é«”ä¸­æ–‡åˆ¥åï¼ˆå‰ç«¯é¡¯ç¤ºç”¨ï¼‰ */
const FONT_ZH_ALIAS = {
  "PMingLiU":"æ–°ç´°æ˜é«”","PMingLiU-ExtB":"æ–°ç´°æ˜é«”-æ“´å±•B","MingLiU":"ç´°æ˜é«”","MingLiU-ExtB":"ç´°æ˜é«”-æ“´å±•B",
  "Microsoft JhengHei":"å¾®è»Ÿæ­£é»‘é«”","MicrosoftJhengHeiRegular":"å¾®è»Ÿæ­£é»‘é«”","MicrosoftJhengHeiBold":"å¾®è»Ÿæ­£é»‘é«”-ç²—é«”",
  "ArialMT":"Arialï¼ˆè‹±æ–‡å­—é«”ï¼‰","Arial":"Arialï¼ˆè‹±æ–‡å­—é«”ï¼‰","TimesNewRomanPSMT":"Times New Romanï¼ˆè‹±æ–‡å­—é«”ï¼‰","Times New Roman":"Times New Romanï¼ˆè‹±æ–‡å­—é«”ï¼‰",
  "Calibri":"Calibriï¼ˆè‹±æ–‡å­—é«”ï¼‰","Cambria":"Cambriaï¼ˆè‹±æ–‡å­—é«”ï¼‰","CambriaMath":"Cambria Mathï¼ˆæ•¸å­¸å­—é«”ï¼‰",
  "MS-Gothic":"MS Gothicï¼ˆæ—¥æ–‡ç­‰å¯¬ï¼‰","MS-Mincho":"MS æ˜æœï¼ˆæ—¥æ–‡å­—é«”ï¼‰","Noto Sans CJK TC":"æ€æºé»‘é«”ï¼ˆç¹ï¼‰","Noto Serif CJK TC":"æ€æºå®‹é«”ï¼ˆç¹ï¼‰"
};
function withZhFontAlias(str){
  return Object.entries(FONT_ZH_ALIAS).reduce((acc,[en,zh])=>{
    const esc=en.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&'); const re=new RegExp(`\\b${esc}\\b`,'g');
    return acc.replace(re, `${en}ï¼ˆ${zh}ï¼‰`);
  }, String(str||''));
}

/* DOM */
const consent=document.getElementById('consent');
const fileInput=document.getElementById('file');
const drop=document.getElementById('drop');
const statusEl=document.getElementById('status');
const startBtn=document.getElementById('start');
const fontBtn=document.getElementById('fontCheckBtn');
const strictBox=document.getElementById('strictMode');
const resultCard=document.getElementById('resultCard');
const tbody=document.getElementById('tbody');
const fileTag=document.getElementById('fileTag');
const downloadHtmlBtn=document.getElementById('downloadHtml');
const gptALink=document.getElementById('gptA');
const gptBLink=document.getElementById('gptB');
const extPanel=document.getElementById('extSearchPanel');
const searchLinksEl=document.getElementById('searchLinks');
const jsonPreviewEl=document.getElementById('jsonPreview');

let arrayBuffer=null, fileName='', lastSummaryJSON=null;

function setEnabled(ok){
  fileInput.disabled = !ok;
  startBtn.disabled  = !ok || !arrayBuffer;
  fontBtn.disabled   = !ok || !arrayBuffer;
  drop.setAttribute('aria-disabled', ok ? 'false' : 'true');
  statusEl.textContent = ok ? (arrayBuffer ? 'å·²é¸æ“‡æª”æ¡ˆï¼Œæº–å‚™é–‹å§‹ã€‚' : 'å·²åŒæ„ï¼Œå¯é¸æª”ã€‚') : 'è«‹å…ˆå‹¾é¸åŒæ„ã€‚';
}
window.addEventListener('DOMContentLoaded', ()=>{
  setEnabled(false);
  consent.addEventListener('change', ()=>{
    setEnabled(consent.checked);
    if(consent.checked && arrayBuffer){ startBtn.disabled=false; fontBtn.disabled=false; }
  });
});
document.querySelector('label.file')?.addEventListener('click', (e)=>{
  e.preventDefault(); if(!fileInput.disabled) fileInput.click();
});
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();if(!fileInput.disabled)drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');}));
drop.addEventListener('drop',e=>{ if(fileInput.disabled)return; const f=e.dataTransfer.files?.[0]; if(f)handleFile(f); });
fileInput.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f)handleFile(f); });

async function handleFile(f){
  if((f.name.split('.').pop()||'').toLowerCase()!=='pdf'){statusEl.textContent='åƒ…æ”¯æ´ PDF';return;}
  if(f.size>10*1024*1024){statusEl.textContent='è¶…é 10MB ä¸Šé™';return;}
  arrayBuffer = await f.arrayBuffer(); fileName = f.name; setEnabled(consent.checked);

  // GPT éµå…¥é è¨­æç¤ºï¼ˆç°¡åŒ–ï¼‰
  const baseA="https://chat.openai.com/"; gptALink.href=baseA;
  const baseB="https://chat.openai.com/"; gptBLink.href=baseB;

  initExternalSearchAssist((fileName||'å°è«–æ–‡ç¯‡å').replace(/\.[^.]+$/,''));
  buildExternalSearchEvidence((fileName||'å°è«–æ–‡ç¯‡å').replace(/\.[^.]+$/,''));
  extPanel.style.display='block';
}

/* é‚Šç•Œï¼šè¦–è¦ºå°ºè¦åœ– */
function marginPreviewSVG({W,H,left,right,top,bottom}){
  const thumbW=240, scale=thumbW/W, th=Math.round(H*scale);
  const insetBlack=CM_TO_PT(2.0)*scale, insetRed=CM_TO_PT(2.2)*scale, insetBlue=CM_TO_PT(1.8)*scale;
  const mL=Math.max(0,(left??0)*scale), mR=Math.max(0,(right??0)*scale), mT=Math.max(0,(top??0)*scale), mB=Math.max(0,(bottom??0)*scale);
  return `
<div class="margin-preview">
<svg width="${thumbW}" height="${th}" viewBox="0 0 ${thumbW} ${th}" xmlns="http://www.w3.org/2000/svg" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px">
  <rect x="0.5" y="0.5" width="${thumbW-1}" height="${th-1}" fill="white" stroke="#9ca3af"/>
  <rect x="${insetBlack}" y="${insetBlack}" width="${thumbW-2*insetBlack}" height="${th-2*insetBlack}" fill="none" stroke="#111" stroke-width="2"/>
  <rect x="${insetRed}" y="${insetRed}" width="${thumbW-2*insetRed}" height="${th-2*insetRed}" fill="none" stroke="#be123c" stroke-width="2" stroke-dasharray="6 4"/>
  <rect x="${insetBlue}" y="${insetBlue}" width="${thumbW-2*insetBlue}" height="${th-2*insetBlue}" fill="none" stroke="#1d4ed8" stroke-width="2" stroke-dasharray="6 4"/>
  ${Number.isFinite(mL)?`<line x1="${mL}" y1="0" x2="${mL}" y2="${th}" stroke="#16a34a" stroke-width="2"/>`:''}
  ${Number.isFinite(mR)?`<line x1="${thumbW-mR}" y1="0" x2="${thumbW-mR}" y2="${th}" stroke="#16a34a" stroke-width="2"/>`:''}
  ${Number.isFinite(mT)?`<line x1="0" y1="${mT}" x2="${thumbW}" y2="${mT}" stroke="#16a34a" stroke-width="2"/>`:''}
  ${Number.isFinite(mB)?`<line x1="0" y1="${th-mB}" x2="${thumbW}" y2="${th-mB}" stroke="#16a34a" stroke-width="2"/>`:''}
</svg>
<div class="legend">
  <span class="dot"></span><span>é»‘ï¼š2.0 cm</span>
  <span class="dot red"></span><span>ç´…ï¼š2.2 cmï¼ˆä¸Šé™ï¼‰</span>
  <span class="dot blue"></span><span>è—ï¼š1.8 cmï¼ˆä¸‹é™ï¼‰</span>
</div>
</div>`;
}

let _ruleCounter=0;
function addRow(rule, pass, evidenceHtml, suggestionHtml){
  const tr=document.createElement('tr');
  const badge = pass ? '<span class="badge-ok">é€šé</span>' : '<span class="badge-bad">æœªé€šé</span>';
  tr.innerHTML = `<td><span class="num">${++_ruleCounter}</span>${rule}</td>
                  <td>${badge}</td>
                  <td>${evidenceHtml||''}</td>
                  <td>${suggestionHtml||''}</td>`;
  tbody.appendChild(tr);
}

/* é‚Šç•Œï¼šServer-first */
startBtn.addEventListener('click', async ()=>{
  if(!arrayBuffer) return;
  tbody.innerHTML=''; _ruleCounter=0; resultCard.style.display='none'; extPanel.style.display='none';
  statusEl.textContent='ä¸Šå‚³è‡³ Cloud Run é€²è¡Œé€é é‚Šç•Œæª¢æŸ¥â€¦';

  let serverOK=false; lastSummaryJSON=null;

  try{
    const fd = new FormData();
    const blob = new Blob([arrayBuffer], {type:"application/pdf"});
    fd.append('file', blob, fileName || 'upload.pdf');

    const res = await fetchWithTimeout(MARGIN_API + "?v=" + Date.now(), {
      method:'POST', mode:'cors', cache:'no-store', body:fd
    }, 20000);

    const txt = await res.text();
    if(!res.ok) throw new Error(`API ${res.status} ${res.statusText} ${txt}`);
    const data = (()=>{ try{return JSON.parse(txt);}catch{return { ok:true, raw:txt }; } })();

    const per = data?.layout?.per_page_margins || data?.per_page || [];
    const pages = Number(data?.summary?.pages || data?.pages || per.length || 0);
    const skip = new Set(Array.isArray(data?.skip_pages)?data.skip_pages:[]);
    const effPages = [...Array(pages).keys()].map(i=>i+1).filter(p=>!skip.has(p));

    if(per.length>0 && pages>0){
      serverOK=true;

      const badPages=[];
      const globalMin={left:Infinity,right:Infinity,top:Infinity,bottom:Infinity};
      per.forEach((pg,i)=>{
        const pno=i+1; if(skip.has(pno)) return;
        const {left:L,right:R,top:T,bottom:B}=pg;
        if(isFinite(L)&&L<globalMin.left)globalMin.left=L;
        if(isFinite(R)&&R<globalMin.right)globalMin.right=R;
        if(isFinite(T)&&T<globalMin.top)globalMin.top=T;
        if(isFinite(B)&&B<globalMin.bottom)globalMin.bottom=B;
        const fail=(isFinite(L)&&!within(L))||(isFinite(R)&&!within(R))||(isFinite(T)&&!within(T))||(isFinite(B)&&!within(B));
        if(fail)badPages.push(pno);
      });

      let svg=''; if(per[0]?.page_size?.width&&per[0]?.page_size?.height){
        svg=marginPreviewSVG({W:per[0].page_size.width,H:per[0].page_size.height,left:per[0].left,right:per[0].right,top:per[0].top,bottom:per[0].bottom});
      }

      const passAll = badPages.length===0;
      const ev1 = `é€é æœ€å°å€¼ï¼ˆcmï¼‰ï¼šå·¦ ${fmtCM(globalMin.left)}ã€å³ ${fmtCM(globalMin.right)}ã€ä¸Š ${fmtCM(globalMin.top)}ã€ä¸‹ ${fmtCM(globalMin.bottom)}`
        + (badPages.length ? `<br/>ä¸åˆæ ¼é æ¬¡ï¼š<span class="mono">${badPages.join(', ')}</span>` : '<br/>å…¨æ•¸é é¢æ–¼ 2.0Â±0.2 cmï¼ˆå« Â±0.8pt å¾®èª¤å·®ï¼‰å…§ã€‚');
      addRow('å››å‘¨é‚Šç•Œ 2 å…¬åˆ†ï¼ˆé€é åš´æ ¼ Â· Cloud Runï¼‰', passAll, ev1, 'ä»¥ä¼ºæœå™¨å¹¾ä½•é‡æ¸¬ç‚ºæº–ï¼›è‹¥æœ‰ä¸åˆæ ¼é è«‹å› Word ç‰ˆé¢èª¿æ•´ã€‚');

      const ev2 = `ç¬¬ 1 é é‡æ¸¬ï¼ˆcmï¼‰ï¼šå·¦ ${fmtCM(per[0]?.left)}ï½œå³ ${fmtCM(per[0]?.right)}ï½œä¸Š ${fmtCM(per[0]?.top)}ï½œä¸‹ ${fmtCM(per[0]?.bottom)}`;
      addRow('ç¬¬ 1 é è¦–è¦ºå°ºè¦ï¼ˆåƒè€ƒåœ–ï¼‰', true, `<div>${ev2}</div>${svg||''}`, 'é»‘=2.0cmã€ç´…=2.2cmã€è—=1.8cmã€‚');

      if(Array.isArray(data?.per_page) && data.per_page.length){
        const ev3 = data.per_page.map(p=>`ç¬¬ ${p.page} é ï¼šå·¦ ${fmtCM(p.left)} cm${p.top ? `ï½œä¸Š ${fmtCM(p.top)} cm` : "ï¼ˆç„¡ä¸Šé‚Šè·æª¢æ¸¬ï¼‰"}`).join('<br/>');
        addRow('æ­£æ–‡èµ·ç®—é‚Šç•Œæª¢æŸ¥ï¼ˆç« ç¯€æ¨¡å¼ï¼‰', true, ev3, 'ç¬¬ 1 é æª¢æŸ¥å·¦ï¼‹ä¸Šï¼Œå…¶é¤˜é åƒ…æª¢æŸ¥å·¦ã€‚');
      }

      lastSummaryJSON = {
        file:{ name:fileName||'(æœªå‘½å)', pages_total:pages, pages_effective:effPages.length, skipped_pages:[...skip] },
        margins:{
          base_cm:2.0,tol_cm:0.2,micro_tol_pt:0.8,
          global_min_pt:{
            left:isFinite(globalMin.left)?+globalMin.left.toFixed(2):null,
            right:isFinite(globalMin.right)?+globalMin.right.toFixed(2):null,
            top:isFinite(globalMin.top)?+globalMin.top.toFixed(2):null,
            bottom:isFinite(globalMin.bottom)?+globalMin.bottom.toFixed(2):null
          },
          bad_pages:badPages
        }
      };
      jsonPreviewEl.textContent = JSON.stringify(lastSummaryJSON,null,2);
      buildExternalSearchEvidence((fileName||'å°è«–æ–‡ç¯‡å').replace(/\.[^.]+$/,'')); extPanel.style.display='block';

      const skipped = skip.size ? `ï¼ˆç•¥éé ï¼š${[...skip].join(', ') }ï¼‰` : '';
      resultCard.style.display='block';
      fileTag.textContent = `æ­¤æ¬¡æª¢æŸ¥æª”æ¡ˆï¼š${fileName||'(æœªå‘½å)'}ï¼›ç¸½é æ•¸ï¼š${pages}ï¼›æœ‰æ•ˆé æ•¸ï¼š${effPages.length}${skipped}`;
      statusEl.textContent = 'Cloud Run æª¢æŸ¥å®Œæˆã€‚';
      updateAiReadableSummary();
    }
  }catch(e){ console.warn('Cloud Run é‚Šç•Œæª¢æŸ¥å¤±æ•—ï¼Œå•Ÿç”¨å‰ç«¯å‚™æ´ã€‚',e); }

  if(serverOK){ bumpCounterEveryTime(); fetchCounter(); return; }

  // å‚™æ´ï¼ˆç•¥ï¼‰ï¼šå¯ä¿ç•™ä½ åŸå…ˆçš„ pdf.js é¦–é æ¨ä¼°ç¨‹å¼ï¼›æ­¤è™•çœç•¥
  statusEl.textContent='Cloud Run ä¸å¯ç”¨ï¼ˆæœ¬æ¬¡ç•¥éå‚™æ´ï¼‰ã€‚';
  resultCard.style.display='block';
});

/* å­—é«”å­—å‹é€²éšæª¢æŸ¥ï¼ˆç›¸å®¹æ–°èˆŠæ¬„ä½ + åš´æ ¼æ¨¡å¼é–‹é—œï¼‰ */
fontBtn.addEventListener('click', async ()=>{
  const blob = arrayBuffer ? new Blob([arrayBuffer], {type:"application/pdf"}) : null;
  if(!blob){ alert('è«‹å…ˆé¸æ“‡ PDF æª”'); return; }
  statusEl.textContent = 'ä¸Šå‚³è‡³ Cloud Runï¼ˆå­—é«”ä½”æ¯”ï¼‰æª¢æŸ¥ä¸­â€¦';
  try{
    const fd = new FormData(); fd.append('file', blob, fileName||'upload.pdf');
    const strict = strictBox?.checked ? '1' : '0';
    const res = await fetch(FONT_API + `?threshold=80&size=12&tol=1&strict=${strict}&v=${Date.now()}`, {
      method:'POST', mode:'cors', cache:'no-store', body:fd
    });
    const data = await res.json();

    // coverageï¼ˆæ–°èˆŠç›¸å®¹ï¼‰
    let zh=0,en=0,combined=0;
    const covNew = data?.summary?.coverage_main;
    const covOldPct = data?.summary?.main_coverage_pct;
    if (covNew && typeof covNew.combined === 'number'){
      zh = (covNew.zh_main ?? 0) * 100; en = (covNew.en_main ?? 0) * 100; combined = (covNew.combined ?? 0) * 100;
    } else if (typeof covOldPct === 'number'){
      combined = covOldPct;
      const dist = Array.isArray(data?.distribution) ? data.distribution : [];
      const isZh = name => /\bPMingLiU|MingLiU\b/i.test(name);
      const isEn = name => /\bTimes\s?New\s?Roman|TimesNewRomanPS\b/i.test(name);
      for (const r of dist){
        const fam = r.family || ''; const sz = +r.size || 0; const pct = +r.percent || 0;
        if (sz>=11 && sz<=13){ if(isZh(fam)) zh+=pct; if(isEn(fam)) en+=pct; }
      }
      if (zh+en > combined && combined>0){ const s=combined/(zh+en); zh*=s; en*=s; }
    }
    const zhStr=zh.toFixed(2), enStr=en.toFixed(2), combinedStr=combined.toFixed(2);

    // top æ¸…å–®ï¼ˆæ–°èˆŠç›¸å®¹ï¼‰
    let topList = '';
    if (Array.isArray(data?.top_fonts) && data.top_fonts.length){
      topList = data.top_fonts.slice(0,10).map(x=>`â€¢ ${x.name}ï¼š${(x.pct*100).toFixed(2)}%`).join('<br/>');
    }else if (Array.isArray(data?.distribution) && data.distribution.length){
      topList = data.distribution.slice(0,10).map(r=>`â€¢ ${r.family} ${r.size}ptï¼š${(+r.percent||0).toFixed(2)}%`).join('<br/>');
    }

    const families = (data?.rules?.families_considered_main?.length ? data.rules.families_considered_main.join('ã€') : 'æ–°ç´°æ˜é«”ï¼‹Times New Roman');
    const pagesEff = data?.file?.pages_effective ?? data?.file?.pages ?? null;
    const prod = data?.diagnosis?.producer || ''; const cre = data?.diagnosis?.creator || '';
    const modeDesc = data?.strict_mode ? 'åš´æ ¼æ¨¡å¼ï¼ˆæ¯”è³½é€å¯©ï¼‰' : 'å‹å–„æ¨¡å¼ï¼ˆæ•™å­¸/è‡ªæª¢ï¼‰';
    const pass = covNew ? (covNew.combined >= 0.80) : (typeof covOldPct==='number' ? (covOldPct >= 80) : false);

    const lines = [
      pagesEff?`æœ‰æ•ˆé æ•¸ï¼š${pagesEff}`:null,
      `ä¸»å­—é«” coverageï¼ˆ12Â±1ptï¼›${families}ï¼‰ï¼š${combinedStr}%`,
      `â€§ æ–°ç´°æ˜é«”ï¼ˆä¸­æ–‡ 12 ç´šï¼‰ï¼š${zhStr}%`,
      `â€§ Times New Romanï¼ˆè‹±æ–‡ 12ptï¼‰ï¼š${enStr}%`,
      `æ¨¡å¼ï¼š${modeDesc}${(prod||cre)?`ï½œè¼¸å‡ºä¾†æºï¼šProducer=${prod}ï½œCreator=${cre}`:''}`
    ].filter(Boolean).join('ï½œ');

    const detailHtml = withZhFontAlias(lines) + (topList?('<br/>'+withZhFontAlias(topList)):'');
    addRow('Cloud Run å­—é«”å­—å‹æª¢æŸ¥ï¼ˆå­—é«”ä½”æ¯”ï¼‰', pass,
      detailHtml.replace(/</g,'&lt;').replace(/>/g,'&gt;'),
      pass ? 'ä¸»è¦å­—é«” coverage é”æ¨™ï¼ˆâ‰¥80%ï¼‰' : 'ä¸»è¦å­—é«” coverage æœªé” 80%ï¼Œè«‹èª¿æ•´å­—é«”èˆ‡å­—ç´šã€‚'
    );

    lastSummaryJSON = lastSummaryJSON || {};
    lastSummaryJSON.fonts = {
      main_pass: pass,
      coverage_main: covNew || { zh_main: zh/100, en_main: en/100, combined: combined/100 },
      top_fonts: (data?.top_fonts || []),
      strict_mode: !!data?.strict_mode
    };
    lastSummaryJSON.file = lastSummaryJSON.file || { name:fileName||'(æœªå‘½å)' };
    lastSummaryJSON.diagnosis = data?.diagnosis || {};

    jsonPreviewEl.textContent = JSON.stringify(lastSummaryJSON, null, 2);
    resultCard.style.display='block';
    fileTag.textContent = `æ­¤æ¬¡æª¢æŸ¥æª”æ¡ˆï¼š${fileName||'(æœªå‘½å)'}`;
    statusEl.textContent = 'å­—é«”ä½”æ¯”æª¢æŸ¥å®Œæˆã€‚';
    updateAiReadableSummary();

  }catch(err){
    addRow('Cloud Run å­—é«”å­—å‹æª¢æŸ¥ï¼ˆå­—é«”ä½”æ¯”ï¼‰', false,
      (err?.message || String(err)).replace(/</g,'&lt;').replace(/>/g,'&gt;'),
      'è«‹ç¢ºèªå¾Œç«¯å…è¨±åŒ¿åã€å·²é–‹ CORSï¼Œä¸”å‰ç«¯ç¢ºå¯¦é€å‡ºæª”æ¡ˆã€‚');
    resultCard.style.display='block';
    statusEl.textContent = 'å­—é«”ä½”æ¯”æª¢æŸ¥å¤±æ•—ã€‚';
  }
});

/* AI å°åŠ©æ‰‹å¯è®€æ‘˜è¦ */
function updateAiReadableSummary(){
  const box=document.getElementById('aiSummaryReadable');
  if(!box) return; if(!lastSummaryJSON){ box.textContent='å°šç„¡çµæœã€‚'; return; }
  try{
    const j=lastSummaryJSON; let txt=`ğŸ“„ å°è«–æ–‡æª¢æŸ¥æ‘˜è¦ï¼š${j?.file?.name||'(æœªå‘½å)'}\n`;
    if(j.margins){
      const bads=j.margins.bad_pages||[];
      txt+=`\nã€é‚Šç•Œæª¢æŸ¥ã€‘\nã€€åŸºæº–é‚Šç•Œï¼š2.0Â±0.2 å…¬åˆ†ï¼ˆå®¹è¨± Â±0.8ptï¼‰\n`;
      txt+=`ã€€é€é æœ€å°é‚Šç•Œï¼ˆptï¼‰ï¼šå·¦ ${j.margins.global_min_pt?.left??'â€”'}ã€å³ ${j.margins.global_min_pt?.right??'â€”'}ã€ä¸Š ${j.margins.global_min_pt?.top??'â€”'}ã€ä¸‹ ${j.margins.global_min_pt?.bottom??'â€”'}ã€‚\n`;
      txt+=bads.length?`ã€€âŒ ä¸åˆæ ¼é æ¬¡ï¼š${bads.join(', ')}ã€‚\n`:`ã€€âœ… æ‰€æœ‰é é¢çš†ç¬¦åˆ 2 å…¬åˆ† Â±0.2 çš„è¦æ±‚ã€‚\n`;
    }
    if(j.fonts){
      const cov=j.fonts.coverage_main||{};
      txt+=`\nã€å­—é«”å­—å‹æª¢æŸ¥ã€‘\n`;
      txt+=`ã€€ä¸»å­—é«”è¦†è“‹ç‡ï¼š${((cov.combined??0)*100).toFixed(2)}%ï¼ˆåˆæ ¼é–€æª»ï¼šâ‰¥80%ï¼‰\n`;
      txt+=`ã€€æ–°ç´°æ˜é«”ï¼ˆä¸­æ–‡ 12 ç´šï¼‰ï¼š${((cov.zh_main??0)*100).toFixed(2)}%ï½œTimes New Romanï¼ˆè‹±æ–‡ 12ptï¼‰ï¼š${((cov.en_main??0)*100).toFixed(2)}%\n`;
      txt+=j.fonts.main_pass?`ã€€âœ… ä¸»è¦å­—é«”è¦†è“‹ç‡é”æ¨™ã€‚\n`:`ã€€âŒ æœªé€šéã€‚è«‹åœ¨ Word å…¨é¸æ–‡å­—å¾Œï¼Œè¨­å®šã€Œä¸­æ–‡ï¼šæ–°ç´°æ˜é«”ã€ã€Œè‹±æ–‡ï¼šTimes New Romanã€ä¸¦é‡åŒ¯ PDFã€‚\n`;
    }
    const diag=j.diagnosis||{}; if(diag.producer||diag.creator){
      txt+=`\nã€è¼¸å‡ºæ–¹å¼ã€‘\nã€€Producer=${diag.producer||''}ï½œCreator=${diag.creator||''}\nã€€èªªæ˜ï¼šåˆ—å°ç‚º PDF å¸¸è¦‹æœªåµŒå­—/ä»£ç”¨ï¼›å¦å­˜ PDF/XPS å¤šåŠæœƒåµŒå­—ï¼›Google/WPS å¸¸è¦‹ Heisei/MSung/Cambria æ›¿ä»£ã€‚\n`;
    }
    const strictFlag = j.fonts?.strict_mode;
    if (typeof strictFlag === 'boolean'){
      txt += `\nã€å­—é«”å­—å‹æª¢æŸ¥æ¨¡å¼ã€‘\nã€€ç›®å‰ç‚ºï¼š${strictFlag?'åš´æ ¼æ¨¡å¼ï¼ˆåªèªæ–°ç´°æ˜é«”/Timesï¼‰':'å‹å–„æ¨¡å¼ï¼ˆç­‰åƒ¹/ä»£ç”¨å…è¨±ï¼‰'}\n`;
    }
    box.textContent=txt.trim();
  }catch(e){ box.textContent='ç”Ÿæˆæ‘˜è¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š'+e.message; }
}

/* å¤–éƒ¨æª¢ç´¢åŠ©æ‰‹ï¼ˆç°¡åŒ–ï¼‰ */
function buildExternalSearchEvidence(baseTitle){
  const t=(baseTitle||'å°è«–æ–‡ç¯‡å').trim(), mk=s=>encodeURIComponent(s);
  const items=[
    {label:'Google Scholarï¼ˆç¹ä¸­ï¼‰',href:`https://scholar.google.com/scholar?hl=zh-TW&q=${mk(t)}`,q:`${t}`},
    {label:'Googleï¼šé¡Œå + å°è«–æ–‡ å¾—ç',href:`https://www.google.com/search?q=${mk(t+' å°è«–æ–‡ å¾—ç')}`,q:`${t} å°è«–æ–‡ å¾—ç`},
    {label:'Googleï¼šé¡Œå + å°ˆé¡Œè£½ä½œ æ¯”è³½ æ­·å±† ä½œå“',href:`https://www.google.com/search?q=${mk(t+' å°ˆé¡Œè£½ä½œ æ¯”è³½ æ­·å±† ä½œå“')}`,q:`${t} å°ˆé¡Œè£½ä½œ æ¯”è³½ æ­·å±† ä½œå“`},
    {label:'Googleï¼šé¡Œå + site:shs.edu.tw',href:`https://www.google.com/search?q=${mk(t+' site:shs.edu.tw')}`,q:`${t} site:shs.edu.tw`},
    {label:'Googleï¼šé¡Œå + site:edu.tw å°è«–æ–‡',href:`https://www.google.com/search?q=${mk(t+' site:edu.tw å°è«–æ–‡')}`,q:`${t} site:edu.tw å°è«–æ–‡`}
  ];
  searchLinksEl.innerHTML = items.map((it,i)=>`<li class="mono">#${i+1} <a data-extlink href="${it.href}" target="_blank" rel="noopener">${it.q}</a></li>`).join('');
  extPanel.style.display='block';
}
function initExternalSearchAssist(baseTitle){
  document.getElementById('btnOpenAllSearch')?.addEventListener('click',()=>{document.querySelectorAll('a[data-extlink]').forEach(a=>window.open(a.href,'_blank','noopener'));});
  document.getElementById('btnCopyGptPrompt')?.addEventListener('click',async()=>{
    const t=(baseTitle||'å°è«–æ–‡ç¯‡å').trim();
    const qsEls=document.querySelectorAll('a[data-extlink]'); const qs=[...qsEls].map((a,i)=>`(${i+1}) ${a.textContent} -> ${a.href}`).join('\n');
    const summary=(typeof lastSummaryJSON==='object'&&lastSummaryJSON)?JSON.stringify(lastSummaryJSON,null,2):(jsonPreviewEl?.textContent||'');
    const prompt=`è«‹å”åŠ©é€²è¡Œã€Œæ ¡å¤–ç™¼è¡¨ï¼å¾—çã€å¤–éƒ¨æª¢ç´¢ç¢ºèªï¼š
é¡Œå/æª”åï¼š${t}

è«‹åˆ°ä»¥ä¸‹ä¾†æºæª¢ç´¢ä¸¦å½™æ•´å‰ 10 ç­†çµæœï¼ˆæ¨™é¡Œã€ä¾†æºã€å¹´ä»½ã€é€£çµï¼‰ï¼ŒåŒæ™‚åˆ¤æ–·æ˜¯å¦ç–‘ä¼¼ç›¸åŒé¡Œåä¹‹å…¬é–‹ç™¼è¡¨æˆ–å¾—çç´€éŒ„ï¼š
1) Google Scholarï¼ˆç¹ä¸­ï¼‰
2) Google é—œéµå­—ï¼šé¡Œå +ã€Œå°è«–æ–‡ å¾—çã€ã€é¡Œå +ã€Œå°ˆé¡Œè£½ä½œ æ¯”è³½ æ­·å±† ä½œå“ã€
3) Google é™ç«™ï¼šsite:shs.edu.twã€site:edu.tw å°è«–æ–‡

è«‹ç”¨è¡¨æ ¼ï¼‹æ¢åˆ—è¼¸å‡ºï¼›æœ€å¾Œçµ¦ã€Œæ˜¯å¦æŸ¥åˆ°ç–‘ä¼¼ç›¸åŒé¡Œåã€çµè«–èˆ‡ç†ç”±ï¼Œä¸¦é™„ä¸Šå¯¦éš›ä½¿ç”¨çš„æŸ¥è©¢å­—ä¸²æ¸…å–®ã€‚

ï¼ˆé™„ï¼šæœ¬æ¬¡æª¢æŸ¥æ‘˜è¦ JSONï¼‰
${summary||'(è‹¥ç©ºç™½å¯å¿½ç•¥)'}

ï¼ˆæŸ¥è©¢å­—ä¸²èˆ‡é€£çµé è¦½ï¼‰
${qs}`;
    try{await navigator.clipboard.writeText(prompt);alert('å·²è¤‡è£½æŸ¥æ ¸æç¤ºï¼Œè«‹é»ã€ŒAI å°åŠ©æ‰‹ï¼ˆGPT Aï¼‰ã€ä¸¦è²¼ä¸Šã€‚');}catch{alert('ç„¡æ³•å­˜å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');}
  });
}

/* ä¸‹è¼‰çµæœï¼ˆç°¡ç‰ˆï¼‰ */
downloadHtmlBtn.addEventListener('click', ()=>{
  const html='<!doctype html><meta charset="utf-8"><title>å°è«–æ–‡æª¢æŸ¥å ±å‘Š</title>'
    + '<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif;margin:24px;}table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}th{background:#f9fafb}.badge-ok{color:#065f46}.badge-bad{color:#991b1b}.hint{color:#6b7280;font-size:13px}</style>'
    + document.querySelector('#resultCard').outerHTML;
  const blob=new Blob([html],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paper-check-report.html'; a.click();
  URL.revokeObjectURL(a.href);
});

/* æ¸…é™¤å›åˆå§‹ */
function resetToInitial(){
  arrayBuffer=null; fileName=''; lastSummaryJSON=null; tbody.innerHTML=''; _ruleCounter=0;
  resultCard.style.display='none'; extPanel.style.display='none'; searchLinksEl.innerHTML=''; jsonPreviewEl.textContent='';
  if(fileInput) fileInput.value=''; statusEl.textContent=consent.checked?'å·²åŒæ„ï¼Œå¯é¸æª”ã€‚':'è«‹å…ˆå‹¾é¸åŒæ„ã€‚'; setEnabled(consent.checked);
  window.scrollTo({top:0,behavior:'smooth'});
}
document.getElementById('clearAll')?.addEventListener('click', resetToInitial);
document.getElementById('clearTop')?.addEventListener('click', resetToInitial);

/* äººæ¬¡ï¼ˆå¯é—œï¼‰ */
async function fetchCounter(){ if(!ENABLE_COUNTER) return; try{ const u=GAS_WEB_APP_URL+'?action=get&site=essayguard&ts='+Date.now(); const r=await fetch(u,{cache:'no-store'}); const d=await r.json().catch(()=>({})); const el=document.getElementById('counter'); if(el) el.textContent=d.count??'0'; }catch{ const el=document.getElementById('counter'); if(el) el.textContent='0'; } }
async function bumpCounterEveryTime(){ if(!ENABLE_COUNTER) return; try{ const u=GAS_WEB_APP_URL+(GAS_WEB_APP_URL.includes('?')?'&':'?')+'action=increment&ts='+Date.now(); await fetch(u,{method:'GET',cache:'no-store'});}catch{} }
window.addEventListener('DOMContentLoaded', ()=> setTimeout(fetchCounter,400));

/* è‡ªå‹•å¸¶ç‰ˆæœ¬åƒæ•¸ï¼ˆé¿å…å¿«å–ï¼‰ */
(function(){
  try{
    const tag=document.querySelector('header .mono')?.textContent.match(/v[=ï¼š]([\w.-]+)/); const v=tag?tag[1]:null;
    if(v) document.title+=`ï½œ${v}`;
    const url=new URL(window.location.href); if(v && !url.searchParams.has('v')){ url.searchParams.set('v',v); window.location.replace(url.toString()); }
  }catch(e){ console.warn('ç‰ˆæœ¬è™Ÿé™„åŠ å¤±æ•—',e); }
})();
</script>
</body>
</html>