<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>高中職小論文格式自檢系統（HTML + GPTs 摘要版）</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
    .wrap{max-width:960px;margin:auto;padding:24px}
    header h1{margin:0 0 4px;font-size:clamp(22px,4vw,28px)}
    header p{margin:0;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:14px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;font-size:12px}
    .hint{color:var(--muted);font-size:13px}
    .drop{border:2px dashed #cbd5e1;border-radius:12px;padding:24px;text-align:center;background:#fafafa;margin-top:8px}
    input[type=file]{display:none}
    label.file{display:inline-flex;align-items:center;gap:.6rem;padding:.7rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
    button{padding:.7rem 1.1rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    .ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.1rem .5rem;border-radius:999px;font-size:12px}
    .bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.1rem .5rem;border-radius:999px;font-size:12px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}
    th{background:#f9fafb}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    pre{white-space:pre-wrap;max-height:260px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
    nav a{color:#2563eb;text-decoration:none}
    nav a:hover{text-decoration:underline}
    .filetag{font-size:13px;color:#374151;margin:6px 0 0}
    .num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:6px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px;color:#374151;font-weight:600}
    .muted{color:#6b7280}
    .badge{margin-top:8px}
  </style>

  <!-- pdf.js（ESM） -->
  <script type="module">
    window.loadPdfjs = async () => {
      const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
      const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
      GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
      return { getDocument };
    };
  </script>
  <!-- mammoth.js（DOCX→HTML） -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
  <!-- （中間的 header、section、table、檢查規則等等保持不動，這裡省略，和你原來的一模一樣） -->

  <script>
    // ====== Cloud Run 呼叫 ======
    async function fetchCloudRun(fileBlob, nameForServer){
      const formData = new FormData();
      formData.append("file", fileBlob, nameForServer || "upload.pdf");
      try {
        const res = await fetch(CLOUD_RUN_ENDPOINT, {
          method: "POST",
          body: formData,
          cache: "no-store", // ★ 新增
          headers: { "Cache-Control": "no-cache" } // ★ 新增
        });
        if (!res.ok){
          const t = await res.text().catch(()=> "");
          throw new Error(`API ${res.status} ${res.statusText} ${t}`);
        }
        return await res.json();
      } catch (err) {
        console.error("呼叫 Cloud Run 失敗：", err);
        addRow('Cloud Run 字體字型檢查', false,
          '無法連線或 CORS 被擋，請確認 Cloud Run 已允許跨網域（OPTIONS 與 Access-Control-Allow-Origin）。',
          '請檢查 Cloud Run CORS 設定與 service URL 是否可公開存取。');
        return null;
      }
    }

    // ====== buildEvidenceString ======
    function buildEvidenceString(data){
      try{
        const parts = [];
        if (data.summary?.pages) parts.push(`頁數：${data.summary.pages}`);
        if (data.summary?.dominant_fonts) parts.push(`主要字體：${data.summary.dominant_fonts.join('、')}`);
        if (Array.isArray(data.top_fonts)) parts.push('常見字體：' + data.top_fonts.slice(0,6).join('、'));
        if (Array.isArray(data.fonts) && data.fonts.length){
          parts.push('字體列表（前幾項）：' + data.fonts.slice(0,6).map(f => {
            const n = [f.family, f.name].filter(Boolean)[0] || '(未知字體)';
            const sz = f.size_pt ? `${f.size_pt}pt` : (f.size || '');
            const wt = f.weight || '';
            const clr = f.color || f.fill || '';
            return [n, sz, wt, clr].filter(Boolean).join(' / ');
          }).join('；'));
        }
        if (Array.isArray(data.issues) && data.issues.length){
          parts.push('問題：' + data.issues.slice(0,6).map(it => it.message || it).join('；'));
        }
        if (data.layout?.mode === "first_page_only") { // ★ 新增
          parts.push("邊界檢查模式：僅以第一頁為基準"); // ★ 新增
        }
        if (!parts.length) return typeof data === 'object' ? JSON.stringify(data).slice(0,800) : String(data);
        return parts.join('｜');
      }catch{
        return typeof data === 'object' ? JSON.stringify(data).slice(0,800) : String(data);
      }
    }
  </script>
</body>
</html>
