<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>高中職小論文格式自檢系統（HTML + GPTs 摘要版）</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
    .wrap{max-width:960px;margin:auto;padding:24px}
    header h1{margin:0 0 4px;font-size:clamp(22px,4vw,28px)}
    header p{margin:0;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:14px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;font-size:12px}
    .hint{color:var(--muted);font-size:13px}
    .drop{border:2px dashed #cbd5e1;border-radius:12px;padding:24px;text-align:center;background:#fafafa;margin-top:8px}
    input[type=file]{display:none}
    label.file{display:inline-flex;align-items:center;gap:.6rem;padding:.7rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
    button{padding:.7rem 1.1rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    .ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.1rem .5rem;border-radius:999px;font-size:12px}
    .bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.1rem .5rem;border-radius:999px;font-size:12px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}
    th{background:#f9fafb}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    pre{white-space:pre-wrap;max-height:260px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
    .filetag{font-size:13px;color:#374151;margin:6px 0 0}
    .num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:6px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px;color:#374151;font-weight:600;}
  </style>

  <!-- pdf.js（ESM） -->
  <script type="module">
    window.loadPdfjs = async () => {
      const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
      const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
      GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
      return { getDocument };
    };
  </script>
  <!-- mammoth.js（DOCX→HTML） -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>高中職小論文格式自檢系統</h1>
      <p>支援 PDF 與 DOCX 檔案的格式檢查，檢查頁數、頁首、頁碼、邊界、段落、字體字型等規則。</p>
    </header>

    <!-- 一般檢查區塊（保留原本內容） -->
    <section class="card">
      <h3>一般格式檢查</h3>
      <input id="file" type="file" accept=".pdf,.docx" />
      <button id="start" class="primary">開始檢查</button>
      <div id="status" class="hint"></div>
    </section>

    <section id="resultCard" class="card" style="display:none">
      <h3>檢查結果</h3>
      <table>
        <thead><tr><th>規則</th><th>結果</th><th>說明</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <pre id="jsonPreview" class="mono"></pre>
    </section>

    <!-- ===== 新增：字體字型進階檢查卡片 ===== -->
    <section class="card" id="fontCard">
      <h3>字體字型進階檢查</h3>
      <p class="hint">將 PDF 上傳至後端 Cloud Run API（PyMuPDF），精準分析字體名稱、字級大小、顏色。</p>
      <div class="row">
        <input id="fontFile" type="file" accept=".pdf" />
        <button id="fontCheckBtn" class="primary">進行字體字型檢查</button>
        <span id="fontStatus" class="hint"></span>
      </div>
      <div id="fontResult" style="margin-top:12px;display:none">
        <h4>字型檢查摘要</h4>
        <ul id="fontSummary"></ul>
        <h4>完整 JSON</h4>
        <pre id="fontJson" class="mono"></pre>
      </div>
    </section>
  </div>

  <script>
    // ====== 一般格式檢查示範 ======
    const fileInput = document.getElementById("file");
    const startBtn = document.getElementById("start");
    const statusEl = document.getElementById("status");
    const resultCard = document.getElementById("resultCard");
    const tbody = document.getElementById("tbody");
    const jsonPreview = document.getElementById("jsonPreview");

    startBtn.addEventListener("click", async ()=>{
      const f = fileInput.files?.[0];
      if(!f){ alert("請選擇 PDF 或 DOCX"); return; }
      statusEl.textContent = "解析中…";
      tbody.innerHTML = "";
      resultCard.style.display = "none";
      // 假裝檢查邏輯（您可放上 pdf.js / mammoth.js 的檢查）
      const result = [
        { rule:"頁數 4–10", pass:true, note:"共 6 頁" },
        { rule:"六大段落依序", pass:false, note:"缺少「研究方法」" }
      ];
      result.forEach((r,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td><span class="num">${i+1}</span>${r.rule}</td>
                        <td>${r.pass?"✅":"❌"}</td>
                        <td>${r.note}</td>`;
        tbody.appendChild(tr);
      });
      resultCard.style.display="block";
      jsonPreview.textContent = JSON.stringify(result,null,2);
      statusEl.textContent = "完成檢查 ✅";
    });

    // ====== 字體字型進階檢查（呼叫 Cloud Run API） ======
    const FONT_API_URL = "https://font-check-api-1009467346209.asia-east1.run.app/check";
    const fontFileInput = document.getElementById("fontFile");
    const fontBtn = document.getElementById("fontCheckBtn");
    const fontStatus = document.getElementById("fontStatus");
    const fontResult = document.getElementById("fontResult");
    const fontSummary = document.getElementById("fontSummary");
    const fontJson = document.getElementById("fontJson");

    fontBtn.addEventListener("click", async ()=>{
      const file = fontFileInput.files?.[0];
      if(!file){ alert("請先選擇 PDF 檔案"); return; }
      fontStatus.textContent = "上傳並分析中…";
      fontResult.style.display = "none";

      try{
        const fd = new FormData();
        fd.append("file", file);
        const res = await fetch(FONT_API_URL, { method:"POST", body: fd });
        if(!res.ok) throw new Error("API 回應失敗");
        const data = await res.json();

        // 簡易摘要
        fontSummary.innerHTML = `
          <li>總頁數：${data.pages}</li>
          <li>字級合格率：${data.metrics?.fontSizePassRate||"—"}%</li>
          <li>偏好字型比率：${data.metrics?.preferredFontRate||"—"}%</li>
          <li>近黑色比例：${data.metrics?.blackColorRate||"—"}%</li>
        `;
        fontJson.textContent = JSON.stringify(data, null, 2);
        fontResult.style.display = "block";
        fontStatus.textContent = "檢查完成 ✅";
      }catch(err){
        console.error(err);
        fontStatus.textContent = "檢查失敗：" + err.message;
      }
    });
  </script>
</body>
</html>