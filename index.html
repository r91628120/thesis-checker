<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>高中職小論文格式自檢系統</title>

<!-- ===== 發版字串（改這行就能強制換新） ===== -->
<script>
  const APP_VER = '2025-10-04f';
  (function () {
    try {
      const url = new URL(location.href);
      if (url.searchParams.get('v') !== APP_VER) {
        url.searchParams.set('v', APP_VER);
        location.replace(url.toString());
      }
    } catch (e) {}
  })();
  console.log("載入版本:", (new URL(location.href)).searchParams.get('v') || APP_VER);

  // 盡力清掉舊版 SW / caches，避免吃舊檔
  (async () => {
    try{
      const regs = await (navigator.serviceWorker?.getRegistrations?.()||[]);
      for (const r of regs) await r.unregister();
      if (window.caches?.keys) {
        const keys = await caches.keys();
        for (const k of keys) await caches.delete(k);
      }
    }catch(e){}
  })();
</script>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
:root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
.wrap{max-width:980px;margin:auto;padding:24px}
header h1{margin:0 0 4px;font-size:clamp(22px,4vw,28px)}header p{margin:0;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}.pill{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;font-size:12px}
.hint{color:var(--muted);font-size:13px}.drop{border:2px dashed #cbd5e1;border-radius:12px;padding:24px;text-align:center;background:#fafafa;margin-top:8px}
input[type=file]{display:none}label.file{display:inline-flex;gap:.6rem;padding:.7rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
button{padding:.7rem 1.1rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}button.primary{background:var(--accent);color:#fff;border-color:transparent}button:disabled{opacity:.5;cursor:not-allowed}
.ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.1rem .5rem;border-radius:999px;font-size:12px}
.bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.1rem .5rem;border-radius:999px;font-size:12px}
table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}th{background:#f9fafb}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}pre{white-space:pre-wrap;max-height:260px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
.filetag{font-size:13px;color:#374151;margin:6px 0 0}.num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:6px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px;color:#374151;font-weight:600}
.extsearch{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;margin-top:6px}.extsearch ul{margin:6px 0 0 18px;padding:0}.extsearch li{margin:4px 0}
</style>

<!-- pdf.js (ESM) -->
<script type="module">
  window.loadPdfjs = async () => {
    const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
    const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
    GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
    return { getDocument };
  };
</script>
<!-- mammoth.js -->
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>高中職小論文格式自檢系統</h1>
    <p>支援 PDF / DOCX；解析僅在瀏覽器記憶體中，完成即釋放，不留存。</p>
    <div class="hint" id="counterBox">目前累積小論文格式自檢人次：<b id="counter">—</b>　<span class="mono">v=<script>document.write(new URL(location.href).searchParams.get('v')||APP_VER)</script></span></div>
  </header>

  <section class="card">
    <div class="row"><div class="pill">PDF / DOCX</div><div class="pill">頁數 4–10</div><div class="pill">≤ 5MB</div><div class="pill">不得含校名／姓名</div></div>
    <details style="margin-top:8px">
      <summary><strong>上傳與資料保存政策（必讀）</strong></summary>
      <ul>
        <li>僅做格式檢查，不做存證或投稿。</li>
        <li>解析於瀏覽器記憶體，完成後即釋放；本站不保存。</li>
        <li>請勿含個資（校名、姓名、班級）。</li>
      </ul>
    </details>
    <div class="row" style="margin-top:8px">
      <input id="consent" type="checkbox"/><label for="consent">我已閱讀並同意，且確認檔案不含 <span class="mono">校名/姓名</span>。</label>
    </div>
    <div id="drop" class="drop" aria-disabled="true">
      <p><strong>拖拉 PDF 或 DOCX 到這裡</strong></p>
      <label for="file" class="file">選擇檔案</label>
      <input id="file" type="file" accept=".pdf,.docx" disabled/>
      <p class="hint">完成檢查即釋放／不保存。</p>
    </div>
    <div class="row" style="margin-top:8px">
      <button onclick="document.getElementById('file').click()">開始檢查</button>
      <button type="button" style="margin-left:auto" onclick="window.open('https://forms.gle/k8Bo5C2YMuXm1ZK79','_blank')">提建議</button>
    </div>
    <div class="drop hint" style="margin-top:16px; text-align:left">Tips：若 PDF 抽不到文字（像掃描影像或亂碼），請改傳 DOCX。</div>
  </section>

  <section class="card">
    <table>
      <thead>
        <tr><th style="width:50px">#</th><th>項目</th><th>狀態</th><th>說明</th><th>建議</th></tr>
      </thead>
      <tbody id="results">
      </tbody>
    </table>
    <div style="font-size:13px;color:#374151;margin:10px 0 0">外部檢索助手：</div>
    <div class="extsearch">
      <ul id="extsearch"></ul>
    </div>
  </section>
</div>

<script>
/* ====== 一些共用參數 / 小工具 ====== */
const RULES = {
  minPages: 4,
  maxPages: 10,
  quoteMaxChars: 50,
  minQuoteCharsForDirect: 10,
  sixSections: ['前言','文獻探討','研究方法','研究分析與結果','研究結論與建議','參考文獻']
};
const PUNCT = /[，、。：；！!？?\s"“”'‘’—…·．。]/g;

let fileBase = '';
let pageTexts = [];  // 1-based

// 顯示行
let resultCount = 0;
function addRow(name, pass, evidence, hint) {
  const rid = 'r' + (++resultCount);
  const row = document.createElement('tr');
  row.innerHTML = `<td class="num">${resultCount}</td><td>${name}</td><td>${
    pass?'<span class="ok">通過</span>':'<span class="bad">未通過</span>'
  }</td><td>${evidence||''}</td><td class="hint">${hint||''}</td>`;
  row.id = rid;
  document.getElementById('results').appendChild(row);
  return row;
}
function missingRange(pages, total) {
  const mis = [], set = new Set(pages);
  for(let i=1;i<=total;i++){ if(!set.has(i)) mis.push(i); }
  const ranges = [], cont = [];
  for(const n of mis) {
    if(cont.length && n === cont[cont.length-1]+1) { cont.push(n); continue; }
    if(cont.length >= 1) { ranges.push([...cont]); cont.length = 0; }
    cont.push(n);
  }
  if(cont.length) ranges.push([...cont]);
  return ranges.map(a=> a.length===1 ? a[0] : (a[0] + '–' + a[a.length-1]) ).join('、');
}
function stripHtml(html) {
  const t = document.createElement('div');
  t.innerHTML = html;
  return t.textContent || t.innerText || '';
}
</script>

<script>
/* ====== 參考文獻處理（#11 略過、#12 正確切條與四層統計） ====== */

// 取「最後一個」參考文獻標題位置，避免目錄/正文提前提到
function _findRefStart(fullText) {
  const text = fullText || '';
  const pat = /(^|\n)[^\n]{0,6}\s*(?:陸[、，.]?\s*)?(參考文獻|參考資料|References)\s*$/gmi;
  let m, lastIdx = -1;
  while ((m = pat.exec(text)) !== null) lastIdx = m.index + (m[1] ? m[1].length : 0);
  if (lastIdx < 0) {
    const cands = ['參考文獻','參考資料','References']
      .map(t => text.lastIndexOf(t)).filter(i => i >= 0);
    if (cands.length) lastIdx = Math.max(...cands);
  }
  return lastIdx;
}

// 是否章節小標
function _isCategoryHeader(line) {
  const s = (line || '').replace(/^[\s\u3000]+|[\s\u3000]+$/g, '');
  if (/^(陸[、，.]?)?\s*(參考文獻|參考資料|References)\s*$/i.test(s)) return true;
  if (/^([（(]?\s*[一二三四五六七八九十\d]+\s*[)）]?\s*[\.．、]?)\s*[\u4e00-\u9fa5A-Za-z]{0,12}(書籍|專書|期刊|期刊論文|論文|博碩士|會議|報紙|電子報|網站|網路|網路相關資源|資料|文獻|法規|政府|機構)\s*(類|資料|資源)?\s*$/.test(s)) return true;
  if (/^[〈《]\s*[\u4e00-\u9fa5A-Za-z]{1,12}\s*(類|資料|資源)?\s*[〉》]$/.test(s)) return true;
  return false;
}

// 參考文獻前處理：跨頁/網址續行/中文數字修補
function _preCleanRefText(s) {
  return (s || '')
    .replace(/\[\[PAGE_SPLIT\]\]/g, '\n')         // 跨頁符號還原為換行
    .replace(/^\s*\d{1,4}\s*$/gm, '')             // 只有頁碼的一行移除
    .replace(/([A-Za-z0-9])-\s*\n\s*([A-Za-z0-9])/g, '$1$2') // 斷字接回
    // URL/DOI 如果在新行，併到上一條
    .replace(/\n\s*(https?:\/\/\S+)/g, ' $1')
    .replace(/\n\s*(www\.\S+)/g, ' $1')
    .replace(/\n\s*(doi\.org\/\S+)/gi, ' $1')
    // 短網址如果在新行，併到上一條
    .replace(/\n\s*((?:reurl\.cc|bit\.ly|tinyurl\.com|t\.ly|t\.co|goo\.gl|is\.gd|ow\.ly|lihi\d?\.cc|ppt\.cc|forms\.gle|youtu\.be|github\.io|medium\.com|shorturl\.at|url\.cn)\S*)/gi, ' $1')
    // 中文數字被拆行的修補
    .replace(/([一二三四五六七八九十百千])\s+([一二三四五六七八九十百千])/g, '$1$2')
    // 以「1.」「（一）」「一、」之類符號作為可能的新起點，Before 插入換行
    .replace(/(?!^)([　\s]*)(?=[（(]?\s*(\d+|[一二三四五六七八九十百千]{1,4})\s*[)）]?\s*[\.．、])/g, '\n')
    // 把無意義的硬斷行合併
    .replace(/([^\.;。！？）”」])\n\s*([^\n])/g, '$1 $2')
    .replace(/[ \t]+\n/g, '\n')
    .replace(/\n{2,}/g, '\n')
    .trim();
}

// 文獻切條（支援數字/中文數字/作者-年份；網址行併入上一條；短網址白名單）
function _parseReferenceEntries(refText) {
  const lines = (refText || '').split(/\n+/).map(s => s.trim()).filter(Boolean);

  const entries = [];
  let cur = '';

  const SHORT_DOMAINS = /(reurl\.cc|bit\.ly|tinyurl\.com|t\.ly|t\.co|goo\.gl|is\.gd|ow\.ly|lihi\d?\.cc|ppt\.cc|forms\.gle|youtu\.be|github\.io|medium\.com|shorturl\.at|url\.cn)/i;

  const isNewItemByIndex = s =>
    /^[\s\u3000]*\d+\s*[\.．、]/.test(s) ||
    /^[\s\u3000]*[一二三四五六七八九十百千]{1,4}\s*[\.．、]/.test(s) ||
    /^[\s\u3000]*[（(]\s*(\d+|[一二三四五六七八九十百千]{1,4})\s*[)）]\s*[\.．、]/.test(s);

  const isNewItemByAuthorYear = s =>
    /^[\s\u3000]*[\u4e00-\u9fa5]{1,12}.*[（(]\s*(\d{4}|無日期)\s*[)）]/.test(s) ||      // 中文作者 +（年份/無日期）
    /^[\s\u3000]*[A-Za-z][A-Za-z .-]{0,30}[（(]\s*(\d{4}|[Nn]\.?[Dd]\.?)\s*[)）]/.test(s); // 英文作者 (Year/n.d.)

  const isContinuation = s =>
    /^\s{2,}/.test(s) || /^[\u3000]+/.test(s) ||
    /^(https?:\/\/|www\.|doi\.org|doi:|取自|Available at|網址)/i.test(s) ||
    /^[-–•．·●]/.test(s) ||
    /^([a-z0-9-]+\.)+[a-z]{2,}(?:[\/?#:].*)?$/i.test(s) ||  // 裸網域
    /^\/[^\s]/.test(s) ||
    SHORT_DOMAINS.test(s);

  for (const raw of lines) {
    const line0 = raw;

    // 小節抬頭（書籍類 / 期刊類 / 網路資源…）直接略過
    if (_isCategoryHeader(line0)) continue;

    const looksNew = isNewItemByIndex(line0) || isNewItemByAuthorYear(line0);
    const cont     = isContinuation(line0);

    const base = line0
      .replace(/^[\s\u3000]*[（(]?\s*(\d+|[一二三四五六七八九十百千]{1,4})\s*[)）]?\s*[\.．、]\s*/, '')
      .trim();

    if (!cur) {
      if (cont && !looksNew) continue; // 第一行就是 URL，等下一條的起點
      cur = base;
      continue;
    }

    if (looksNew) { entries.push(cur.trim()); cur = base; continue; }
    if (cont)     { cur += ' ' + line0.trim(); }
    else          { cur += ' ' + base; }
  }

  if (cur) entries.push(cur.trim());
  return entries.filter(s => s.replace(/\s/g, '').length >= 6);
}

function _normRefKey(s) {
  return s.replace(/\s+/g, ' ')
    .replace(/https?:\/\/(www\.)?/gi, '')
    .replace(/[，、；。]+/g, ' ')
    .trim()
    .toLowerCase();
}
function _dedupReferences(list) {
  const map = new Map();
  for (const e of list) { const k = _normRefKey(e); if (!map.has(k)) map.set(k, e); }
  return Array.from(map.values());
}
function _hasYear(text) {
  return /（\d{4}|無日期）|\(\d{4}\)|\b\d{4}\b年|\b(19|20)\d{2}\b|\(n\.?d\.?\)/i.test(text);
}
function _textWithoutUrls(s) { return s.replace(/https?:\/\/\S+/g, '').replace(/\s+/g, ' ').trim(); }
function _isQualifiedRef(item) {
  const s = item;
  const hasPublisher = /(出版社|Press\b|Publishing|出版|台北市|新北市|高雄市).{0,10}$/.test(s);
  const hasJournalMeta =
    /(\bVol\.?\s*\d+|\bNo\.?\s*\d+|\bpp?\.?\s*\d+[-–]\d+|第\s*\d+\s*卷|第\s*\d+\s*期|頁\s*\d+[-–]\d+)/i.test(s) ||
    /(Journal|期刊|學報|通訊|評論|會刊).{0,40}\d{4}/.test(s) ||
    /,\s*\d{1,4}\s*,\s*\d{1,4}\s*[-–]\s*\d{1,4}/.test(s) ||
    /,\s*\d{1,4}\b(?!\s*頁)/.test(s);
  const hasThesisOrConf = /(碩士論文|博士論文|學位論文|Master'?s|Ph\.?D\.?|dissertation|thesis|Proceedings|研討會|會議論文)/i.test(s);
  const hasLawOrGov     = /(法規|條例|辦法|函釋|教育部|衛福部|主計總處|行政院|內政部|各縣市政府)/.test(s);
  const hasNewspaper    = /(日報|電子報|聯合報|自由時報|中國時報|經濟日報|蘋果日報|天下雜誌|今周刊)/.test(s);
  const hasDOI          = /(doi\.org|doi:)/i.test(s);
  const hasAcademicPlatform =
    /(ScienceDirect|Wiley|Springer|Elsevier|Taylor & Francis|SAGE|ACM Digital Library|IEEE Xplore|Nature|Cell Press|Oxford Academic|Cambridge Core)/i.test(s);

  if (hasPublisher || hasJournalMeta || hasThesisOrConf || hasLawOrGov || hasNewspaper || hasDOI || hasAcademicPlatform) return true;
  if (_hasYear(s) && _textWithoutUrls(s).replace(/[，、；。.,]/g, '').length >= 6) return true;
  return false;
}
function _classifyReference(item) {
  const s = item;
  const hasPublisher = /(出版社|Press\b|Publishing|出版|台北市|新北市|高雄市).{0,10}$/.test(s);
  const hasJournalMeta =
    /(\bVol\.?\s*\d+|\bNo\.?\s*\d+|\bpp?\.?\s*\d+[-–]\d+)/i.test(s) ||
    /(Journal|期刊|學報|通訊|評論|會刊).{0,40}\d{4}/.test(s) ||
    /,\s*\d{1,4}\s*,\s*\d{1,4}\s*[-–]\s*\d{1,4}/.test(s) ||
    /,\s*\d{1,4}\b(?!\s*頁)/.test(s);
  const hasThesisOrConf = /(碩士論文|博士論文|學位論文|Master'?s|Ph\.?D\.?|dissertation|thesis|Proceedings|研討會|會議論文)/i.test(s);
  const hasLawOrGov     = /(法規|條例|辦法|函釋|教育部|衛福部|主計總處|行政院|內政部|各縣市政府)/.test(s);
  const hasNewspaper    = /(日報|電子報|聯合報|自由時報|中國時報|經濟日報|蘋果日報|天下雜誌|今周刊)/.test(s);
  const hasDOI          = /(doi\.org|doi:)/i.test(s);
  const hasAcademicPlatform =
    /(ScienceDirect|Wiley|Springer|Elsevier|Taylor & Francis|SAGE|ACM Digital Library|IEEE Xplore|Nature|Cell Press|Oxford Academic|Cambridge Core)/i.test(s);

  if (hasPublisher || hasJournalMeta || hasThesisOrConf || hasLawOrGov || hasNewspaper || hasDOI || hasAcademicPlatform) return 'nonweb';
  const isPureWeb = /(YouTube|Facebook|Instagram|IG|X\.com|Twitter|PTT|Dcard|blogspot|wordpress|medium\.com|wiki|維基|論壇|部落格)/i.test(s) ||
    /(網站|網頁|線上文章|粉專)/.test(s);
  const hasLink = /(https?:\/\/|取自|Available at|網址)/i.test(s);
  if (isPureWeb) return 'web';
  if (hasLink)    return 'web';
  return 'nonweb';
}
</script>

<script>
/* ===== 規則主程式（含 #11 略過、#12 四層統計） ===== */
function runTextRules(pageTextsIn){
  pageTexts = pageTextsIn;
  const pages=pageTexts.length-1||1;
  const fullText = pageTexts.slice(1).join('\n\n[[PAGE_SPLIT]]\n\n');

  // 1) 頁碼/頁數（簡要）
  const pageOK = pages>=RULES.minPages && pages<=RULES.maxPages;
  addRow('頁數 4–10 頁', pageOK, `偵測頁數：${pages}`, '4–10頁為參賽門檻。');

  // 2) 六大段落
  const sec=RULES.sixSections;
  const idx=sec.map(s=>fullText.indexOf(s)); const hasAll=idx.every(i=>i>=0); const inOrder=hasAll && idx.join(',')===idx.slice().sort((a,b)=>a-b).join(',');
  addRow('六大段落依序',hasAll&&inOrder,hasAll?(inOrder?'順序正確':'找到各段落但順序錯誤'):'有段落缺失','請依「前言 → 文獻探討 → 研究方法 → 研究分析與結果 → 研究結論與建議 → 參考文獻」排列。');

  // 3) 內文引註
  const citeA=/（[^，\n]{1,12}，\s*\d{4}）/g, citeB=/[^\s，。、]{1,12}（\s*\d{4}）/g;
  const hasCite=(fullText.match(citeA)?.length||0)+(fullText.match(citeB)?.length||0);
  addRow('內文引註採 作者-年份',hasCite>0,hasCite?`檢出 ${hasCite} 處`:'未檢出引註樣式','請使用（姓名，年份）或 姓名（年份）。');

  // 4) 直接引文長度
  const quotesRaw=[...(fullText.match(/「[^」]{1,200}」/g)||[]),...(fullText.match(/“[^”]{1,200}”/g)||[])];
  const clean=s=>s.replace(PUNCT,''); const isDirect=q=>clean(q).length>=RULES.minQuoteCharsForDirect;
  const directQuotes=quotesRaw.filter(q=>isDirect(q)), over=directQuotes.filter(q=>clean(q).length>RULES.quoteMaxChars);
  addRow(`直接引文 ≤ ${RULES.quoteMaxChars} 字（不含標點與空白）`,over.length===0,over.length?`超標處：${over.length} 例`:(directQuotes.length?`OK（偵測 ${directQuotes.length} 例）`:'OK（未偵測引號片段）'),'引號內淨字數≥10才視為直接引文。');

  // 5) 參考文獻起點（取最後一個）
  const refIdx = _findRefStart(fullText);

  // 6) 不得含校名/姓名（參考文獻之後略過）
  const SCHOOL_PATTERNS = [
    /國立臺灣大學|國立台灣大學|國立中興大學|國立清華大學|國立交通大學|陽明交通大學|國立成功大學|國立政治大學/,
    /國立中正大學|國立中央大學|國立中山大學|國立臺北大學|國立臺灣師範大學|國立臺灣科技大學|國立臺北科技大學|國立屏東科技大學/,
    /小學|國小|國民小學|國中|國民中學|高中|高級中學|高職|高工|大學|學院|學校/
  ];
  const schoolHits=[]; const schoolPages=new Set();
  for(let p=1;p<=pages;p++){
    let t=pageTexts[p]||'';
    const pageStartOffset = fullText.indexOf(pageTexts[p]);
    if(refIdx>=0 && pageStartOffset>=refIdx) continue; // 完整在參考文獻之後
    if(refIdx>=0 && pageStartOffset < refIdx && pageStartOffset + t.length > refIdx) {
      t = t.slice(0, refIdx - pageStartOffset); // 跨過界的頁，只取前段
    }
    for(const re of SCHOOL_PATTERNS){
      const m=t.match(re);
      if(m&&m.length){schoolHits.push(...m); schoolPages.add(p);}
    }
  }
  addRow('不得含校名/姓名',schoolHits.length===0,schoolHits.length?`偵測到疑似校名：${[...new Set(schoolHits)].join('、')}｜頁次：${[...schoolPages].join(', ')}`:'未發現','本檢查會自動略過「參考文獻」區段，避免學位論文出處誤判。');

  // 7) 參考文獻：切條 + 四層統計
  const refTextRaw   = refIdx >= 0 ? fullText.slice(refIdx).replace(/^(?:陸[、，.]?\s*)?(?:參考文獻|參考資料|References)\s*[\r\n]+/i, '') : '';
  const refTextFull  = _preCleanRefText(refTextRaw);
  let refEntries     = refIdx >= 0 ? _parseReferenceEntries(refTextFull) : [];
  refEntries         = _dedupReferences(refEntries);

  const A_total = refEntries.length;
  const B_hasYear = refEntries.filter(s => _hasYear(s)).length;
  const C_hasLink = refEntries.filter(s => /(https?:\/\/|doi\.org|doi:|取自|Available at|網址)/i.test(s)).length;

  const classified = refEntries.map(s => ({ text: s, kind: _classifyReference(s) }));
  const nonwebCount = classified.filter(x => x.kind === 'nonweb').length;
  const webCount    = classified.filter(x => x.kind === 'web').length;

  const qualifiedCount   = refEntries.filter(_isQualifiedRef).length;
  const unqualifiedCount = Math.max(0, A_total - qualifiedCount);

  const evidence12 = [
     `檢查總數量：${A_total}`,
     `合格數量：${qualifiedCount}`,
     `不合格數量：${unqualifiedCount}`,
     `網路來源數量：${webCount}`,
     `（A.總數：${A_total}｜B.含年份：${B_hasYear}｜C.含網址/DOI：${C_hasLink}）`
  ].join('｜');
  addRow('參考文獻 ≥ 3', A_total >= 3, evidence12,'以整筆條目計數（標題＋出版資訊＋網址若換行視為同一條）。若「不合格」存在，請補齊出版資訊或新增具出版證據的來源，使合格數達標。');

  // 8) 圖表（簡化）
  const figMatches=fullText.match(/(^|\n|\s)圖\s*\d+[\s．.、：:]/g)||[], tabMatches=fullText.match(/(^|\n|\s)表\s*\d+[\s．.、：:]/g)||[];
  const totalFT=figMatches.length+tabMatches.length;
  const srcAll=(fullText.match(/資料來源[:：]/g)||[]).length;
  const figPass = totalFT===0 ? true : (srcAll>=totalFT);
  addRow('圖表需有標號/標題與來源',figPass,`檢出圖/表 ${totalFT} 項；資料來源紀錄 ${srcAll} 項`,`圖/表需上方標號+標題；下方標示「資料來源：…」。`);

  // 9) 引註一致性（簡化）
  const refJoined = refEntries.join('\n');
  const citations=(fullText.match(/（[^，\n]{1,12}，\s*\d{4}）/g)||[]).map(s=>s.replace(/[（）\s]/g,'').replace(/，/g,''));
  let linked=0; for(const c of citations){ if(refJoined.includes(c)) linked++; }
  const unlinkedInText = Math.max(0,citations.length-linked);
  const refAuthors=(refJoined.match(/[\u4e00-\u9fa5A-Za-z]{1,12}（\d{4}/g)||[]).map(s=>s.replace(/（\d{4}.*/,''));
  const reverseUnlinked = refAuthors.filter(a=>!citations.some(c=>c.startsWith(a))).length;
  addRow('參考文獻與內文引註一致性',unlinkedInText===0 && reverseUnlinked<=1,`引註共 ${citations.length}；對應 ${linked}；未對應（內文→文獻）${unlinkedInText}；疑似未被引用（文獻→內文）${reverseUnlinked}`,'內文出現之引用需在參考文獻出現；未引用者不得列入參考文獻。');

  // 10) 來源不可全為網路
  const nonAllWebPass = (A_total > 0) && (webCount < A_total);
  const evidence16 = [
    `分類 → 非網路 ${nonwebCount}｜純網路 ${webCount}｜總數 ${A_total}`,
    `（檢查總數量：${A_total}｜合格：${qualifiedCount}｜不合格：${unqualifiedCount}）`
  ].join('｜');
  addRow('參考文獻來源不可全為網路', nonAllWebPass, evidence16, '至少保留 1 筆非純網路來源（書籍/期刊/論文/報紙/會議/法規等）。');

  // 11) 字體 Mirror（保留掛鉤）
  syncBasicFontRuleMirror();

  // 12) 外部檢索助手
  const extEvidence=buildExternalSearchEvidence(fileBase||'小論文篇名');
  addRow('作品是否已於校外發表/得獎（需人工/GPT）',true,extEvidence,'使用下方「外部檢索助手」或「複製查核提示」至 AI 小助手進行確認。');
  setTimeout(()=>initExternalSearchAssist(fileBase||'小論文篇名'),0);
}
</script>

<script>
/* ====== 上傳 / 解析 ====== */
const consent = document.getElementById('consent');
const fileInput = document.getElementById('file');
const drop = document.getElementById('drop');

consent.addEventListener('change', () => {
  fileInput.disabled = !consent.checked;
  drop.setAttribute('aria-disabled', String(!consent.checked));
});

drop.addEventListener('dragover', e => { e.preventDefault(); if(!consent.checked)return; drop.style.background='#fff'; });
drop.addEventListener('dragleave', e => { drop.style.background='#fafafa'; });
drop.addEventListener('drop', e => {
  e.preventDefault(); drop.style.background='#fafafa';
  if(!consent.checked)return;
  const f = e.dataTransfer.files?.[0];
  if (f) handleFile(f);
});

fileInput.addEventListener('change', e => {
  const f = e.target.files?.[0];
  if (f) handleFile(f);
});

async function handleFile(file){
  document.getElementById('results').innerHTML='';
  resultCount = 0;
  fileBase = (file.name||'').replace(/\.[^.]+$/,'');
  const ext = (file.name.split('.').pop()||'').toLowerCase();

  try{
    if(ext==='pdf'){
      const { getDocument } = await window.loadPdfjs();
      const buf = await file.arrayBuffer();
      const pdf = await getDocument({data: buf}).promise;
      const total = pdf.numPages;
      const texts = ['']; // 1-based
      for(let i=1;i<=total;i++){
        const page = await pdf.getPage(i);
        const c = await page.getTextContent();
        const str = c.items.map(it=>it.str).join(' ');
        texts[i] = str;
      }
      runTextRules(texts);
    } else if (ext==='docx'){
      const buf = await file.arrayBuffer();
      const r = await window.mammoth.convertToHtml({arrayBuffer: buf});
      const text = stripHtml(r.value);
      runTextRules(['', text]); // 當作單頁
    } else {
      alert('請上傳 PDF 或 DOCX 檔案。');
    }
  }catch(err){
    console.error(err);
    addRow('檔案解析', false, 'PDF/DOCX 解析失敗', '若是掃描影像或加密 PDF，請改用 DOCX。');
  }
}
</script>

<script>
/* ====== 其餘掛鉤（維持相容） ====== */
function syncBasicFontRuleMirror(){ /* 保留掛鉤，若有自動字體規則可在此 mirror 顯示 */ }

function buildExternalSearchEvidence(title){
  const lines = [
    `#1 Google Scholar（繁中）：${title} site:scholar.google.com`,
    `#2 Google：題名＋小論文／得獎：${title} 小論文 得獎`,
    `#3 Google：題名＋學校：${title} site:edu.tw`,
    `#4 Google：題名＋比賽或期刊：${title} site:gov.tw`
  ];
  return `<div class="mono">${lines.map(s=>`• ${s}`).join('<br/>')}</div>`;
}
function initExternalSearchAssist(title){
  const ul = document.getElementById('extsearch');
  ul.innerHTML = '';
  const qs = [
    {t:'Google Scholar', q:`${title}`, url:(q)=>`https://scholar.google.com/scholar?q=${encodeURIComponent(q)}`},
    {t:'Google：題名＋小論文／得獎', q:`${title} 小論文 得獎`, url:(q)=>`https://www.google.com/search?q=${encodeURIComponent(q)}`},
    {t:'Google：題名＋學校（.edu.tw）', q:`${title} site:edu.tw`, url:(q)=>`https://www.google.com/search?q=${encodeURIComponent(q)}`},
    {t:'Google：題名＋政府/期刊（.gov.tw）', q:`${title} site:gov.tw`, url:(q)=>`https://www.google.com/search?q=${encodeURIComponent(q)}`}
  ];
  for(const it of qs){
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = it.url(it.q); a.textContent = it.t; a.target="_blank"; a.rel="noopener";
    li.appendChild(a);
    const span = document.createElement('span');
    span.className='mono'; span.style.marginLeft='6px'; span.textContent = it.q;
    li.appendChild(span);
    ul.appendChild(li);
  }
}
</script>
</body>
</html>