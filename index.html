<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>高中職小論文格式自檢系統</title>
<style>
:root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
.wrap{max-width:960px;margin:auto;padding:24px}
header h1{margin:0 0 4px;font-size:clamp(22px,4vw,28px)}header p{margin:0;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}.pill{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;font-size:12px}
.hint{color:var(--muted);font-size:13px}.drop{border:2px dashed #cbd5e1;border-radius:12px;padding:24px;text-align:center;background:#fafafa;margin-top:8px}
input[type=file]{display:none}label.file{display:inline-flex;gap:.6rem;padding:.7rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
button{padding:.7rem 1.1rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}button.primary{background:var(--accent);color:#fff;border-color:transparent}button:disabled{opacity:.5;cursor:not-allowed}
.ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.1rem .5rem;border-radius:999px;font-size:12px}
.bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.1rem .5rem;border-radius:999px;font-size:12px}
table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}th{background:#f9fafb}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}pre{white-space:pre-wrap;max-height:260px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
.filetag{font-size:13px;color:#374151;margin:6px 0 0}.num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:6px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px;color:#374151;font-weight:600}
.extsearch{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;margin-top:6px}.extsearch ul{margin:6px 0 0 18px;padding:0}.extsearch li{margin:4px 0}
</style>

<!-- pdf.js (ESM) -->
<script type="module">
  window.loadPdfjs = async () => {
    const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
    const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
    GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
    return { getDocument };
  };
</script>
<!-- mammoth.js -->
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>高中職小論文格式自檢系統</h1>
    <p>支援 PDF 與 DOCX，完成檢查後即釋放記憶體，不保存檔案。</p>
    <div class="hint" id="counterBox">目前累積小論文格式自檢人次：<b id="counter">載入中…</b></div>
    <div class="hint" style="margin-top:8px">© 2025 CTVS Library 凡事皆正面 · Email: r91628120@ctvs.ptc.edu.tw</div>
  </header>

  <section class="card">
    <div class="row"><div class="pill">PDF / DOCX</div><div class="pill">頁數 4–10</div><div class="pill">大小 ≤ 5MB</div><div class="pill">不得含校名／姓名</div></div>
    <details style="margin-top:8px">
      <summary><strong>上傳與資料保存政策（必讀）</strong></summary>
      <ul>
        <li>僅做格式檢查與建議，不做存證或投稿。</li>
        <li>解析於瀏覽器記憶體，完成後即釋放；本站不保存。</li>
        <li>請勿含個資（校名、姓名、班級），否則拒檢。</li>
      </ul>
    </details>
    <div class="row" style="margin-top:8px">
      <input id="consent" type="checkbox"/><label for="consent">我已閱讀並同意，且確認檔案不含 <span class="mono">校名/姓名</span>。</label>
    </div>
    <div id="drop" class="drop" aria-disabled="true">
      <p><strong>拖拉 PDF 或 DOCX 至此</strong></p>
      <label for="file" class="file">選擇檔案</label>
      <input id="file" type="file" accept=".pdf,.docx" disabled/>
      <p class="hint">完成檢查即釋放／不保存。</p>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="start" class="primary" disabled>開始檢查</button>
      <button id="clear" disabled>清除</button>
      <button id="fontCheckBtn" disabled>字體字型進階檢查</button>
      <span id="status" class="hint" role="status" aria-live="polite"></span>
    </div>
  </section>

  <section class="card" id="spec">
    <h2>系統檢查規則（合格標準）</h2>
    <ol>
      <li>頁數：4–10 頁。</li>
      <li>首頁頁首置中且距上緣 ≥ 2 公分（於這 2 公分內偵測到置中之篇名/標題即通過）。</li>
      <li>首頁頁碼置中且距下緣 ≥ 2 公分（於這 2 公分內偵測到置中的頁碼即通過）。</li>
      <!-- 第4項已依需求移除 -->
      <li>檔案名稱 與 頁首篇名一致（不符判定淘汰）。</li>
      <li>每頁需有置中頁碼（底端帶）。</li>
      <li>四周邊界 ≥ 2 公分（正文區推估）。</li>
      <li>不得有封面頁（4–10頁）。</li>
      <li>不得含校名/姓名（跳過「參考文獻」段落）。</li>
      <li>六大段落依序。</li>
      <li>內文引註採 作者-年份；直接引文 ≤ 50 字（不含標點）。</li>
      <li>參考文獻 ≥ 3；並顯示 A/B/C 統計。</li>
      <li>圖表需有標號/標題與來源（表內已引注可不於表下再標）。</li>
      <li>參考文獻與內文引註一致；來源不可全為網路。</li>
      <li>字體/字型規範（可用進階檢查）。</li>
      <li>校外發表/得獎：外部檢索助手 + GPT 提示。</li>
    </ol>
    <p class="hint">※ 系統檢查為輔助工具，仍需老師覆核。</p>
  </section>

  <section class="card" id="resultCard" style="display:none">
    <h3>檢查結果</h3>
    <div id="fileTag" class="filetag"></div>
    <table><thead><tr><th>規則</th><th>結果</th><th>證據 / 說明</th><th>建議</th></tr></thead><tbody id="tbody"></tbody></table>
    <div class="row" style="margin-top:8px">
      <button id="downloadHtml">下載檢查結果（網頁）</button>
      <button id="copyJson">複製檢查結果 (給AI助手)</button>
      <button id="downloadJson">儲存檢查結果檔案</button>
      <a id="openGpts" class="primary" href="https://chatgpt.com/g/g-68c6d9e700c88191872154808e0e0e7b-gao-zhong-zhi-xiao-lun-wen-ge-shi-zi-jian-xi-tong" target="_blank" rel="noopener">打開AI助手（貼上檢查結果）</a>
    </div>
    <pre id="jsonPreview" class="mono" style="margin-top:8px"></pre>
  </section>
</div>

<script>
/* ===== 設定 ===== */
/* Google 試算表 + GAS 累計 */
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxUi3g3Yzeu7UQkvHx7Eg6YhQlF6i1zNgH0TwfNKbbHc3ggbkY8oOfKAAGQn76kALpJ/exec";
const ENABLE_COUNTER = true;

/* Cloud Run 進階字體檢查 */
const CLOUD_RUN_BASE = "https://font-check-api-1009467346209.asia-east1.run.app";
const CLOUD_RUN_ENDPOINT = CLOUD_RUN_BASE + "/check";

/* ===== UI 變數 ===== */
const consent=document.getElementById('consent'),fileInput=document.getElementById('file'),drop=document.getElementById('drop');
const startBtn=document.getElementById('start'),clearBtn=document.getElementById('clear'),fontCheckBtn=document.getElementById('fontCheckBtn');
const statusEl=document.getElementById('status'),resultCard=document.getElementById('resultCard'),tbody=document.getElementById('tbody');
const downloadHtmlBtn=document.getElementById('downloadHtml'),copyBtn=document.getElementById('copyJson'),downloadJsonBtn=document.getElementById('downloadJson');
const jsonPreview=document.getElementById('jsonPreview'),counterBox=document.getElementById('counterBox'),counterEl=document.getElementById('counter'),fileTagEl=document.getElementById('fileTag');

/* ===== 狀態 ===== */
let arrayBuffer=null,fileName=null,fileBase=null,fileExt=null,lastSummaryJSON=null,_lastPageCount=0;
let _ruleCounter=0; const _rowsBuffer=[];
let _fontCheckMirror=null;

/* ===== 規則常數 ===== */
const RULES={
  minPages:4,maxPages:10,maxSizeMB:5,
  sixSections:['前言','文獻探討','研究方法','研究分析與結果','研究結論與建議','參考文獻'],
  quoteMaxChars:50,minQuoteCharsForDirect:10,marginCM:2.0,
  headerBandFactor:1.0,footerBandFactor:1.0
};
const CM_TO_PT=cm=>cm*72/2.54, MARGIN_PT=CM_TO_PT(RULES.marginCM);
const PUNCT=/[，。、．；：、！？—─\-…‧（）()〔〕【】《》〈〉「」『』“”"'\[\]{}<>‧·~`^_=+\|\\/:，,.;:!\?\s]/g;
const SCHOOL_PATTERNS=[/(國立|市立|縣立)[\u4e00-\u9fa5]{0,8}(高級中學|高中|高職|高工|家商|商工|農工|高農|職業學校|中學|國中|小學|大學|科技大學|科大|師範大學|大學附中|實驗高中|高中部)/g];

/* ===== 可用性 ===== */
function setUploadEnabled(ok){fileInput.disabled=!ok;const has=!!arrayBuffer;startBtn.disabled=!ok||!has;clearBtn.disabled=!ok||!has;fontCheckBtn.disabled=!ok||!has||fileExt!=='pdf'}
consent.addEventListener('change',()=>{setUploadEnabled(consent.checked);statusEl.textContent=consent.checked?'已同意，可上傳。':'請先同意政策。'});

/* DnD */
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();if(!fileInput.disabled)drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');}));
drop.addEventListener('drop',e=>{if(fileInput.disabled)return;const f=e.dataTransfer.files?.[0];if(f)handleFile(f);});
fileInput.addEventListener('change',e=>{const f=e.target.files?.[0];if(f)handleFile(f);});
function baseName(n){return(n||'').replace(/\.[^.]+$/,'').trim();}
async function handleFile(f){
  const ext=(f.name.split('.').pop()||'').toLowerCase(); if(!['pdf','docx'].includes(ext)){statusEl.textContent='僅支援 PDF 或 DOCX';return;}
  if(f.size>RULES.maxSizeMB*1024*1024){statusEl.textContent=`檔案超過 ${RULES.maxSizeMB}MB 上限。`;return;}
  fileName=f.name;fileBase=baseName(f.name);fileExt=ext;arrayBuffer=await f.arrayBuffer();
  statusEl.textContent=`已選擇：${f.name}（${(f.size/1024/1024).toFixed(2)} MB）`;setUploadEnabled(consent.checked);
}
clearBtn.addEventListener('click',()=>{fileInput.value='';arrayBuffer=null;fileName=fileBase=fileExt=null;startBtn.disabled=clearBtn.disabled=fontCheckBtn.disabled=true;resultCard.style.display='none';tbody.innerHTML='';fileTagEl.textContent='';statusEl.textContent='已清除。';jsonPreview.textContent='';lastSummaryJSON=null;_rowsBuffer.length=0;_fontCheckMirror=null;});

/* ===== 主流程 ===== */
startBtn.addEventListener('click',async()=>{
  if(!arrayBuffer)return;tbody.innerHTML='';resultCard.style.display='none';statusEl.textContent='解析中…';_rowsBuffer.length=0;_ruleCounter=0;_fontCheckMirror=null;
  try{
    if(fileExt==='pdf'){await runPdfChecks(arrayBuffer);} else {await runDocxChecks(arrayBuffer);}
    resultCard.style.display='block';fileTagEl.textContent=`此次檢查檔案：${fileName||'(未命名)'}`;statusEl.textContent='完成檢查。';
    buildAndShowSummaryJSON({fileName,pages:_lastPageCount||0,passFailRows:_rowsBuffer.slice()});
    if(ENABLE_COUNTER){await bumpCounterEveryTime();await fetchCounter();}
  }catch(e){console.error(e);statusEl.textContent='解析失敗：請確認檔案是否有效。'}
});

/* ===== 進階字體檢查 ===== */
fontCheckBtn.addEventListener('click',async()=>{
  if(!arrayBuffer||fileExt!=='pdf'){alert('請先選擇 PDF 檔。');return;}
  try{
    statusEl.textContent='上傳至 Cloud Run 進行字體檢查…';
    const pdfBlob=new Blob([arrayBuffer],{type:"application/pdf"});
    const data=await fetchCloudRun(pdfBlob,fileName||'upload.pdf');
    if(data){
      const {pass,suggestion}=normalizeApiResult(data); const ev=buildEvidenceString(data);
      _fontCheckMirror={pass:Boolean(pass),evidence:ev,suggestion:suggestion||''};
      addRow('Cloud Run 字體字型檢查',!!pass,ev,suggestion||'請依規範修正字體。');
      syncBasicFontRuleMirror();
      buildAndShowSummaryJSON({fileName,pages:_lastPageCount||0,passFailRows:_rowsBuffer.slice()});
      resultCard.style.display='block';fileTagEl.textContent=`此次檢查檔案：${fileName||'(未命名)'}`;statusEl.textContent='Cloud Run 檢查完成。';
    }
  }catch(e){console.error(e);statusEl.textContent='Cloud Run 檢查失敗。'}
});
async function fetchCloudRun(fileBlob,nameForServer){
  const formData=new FormData(); formData.append("file",fileBlob,nameForServer||"upload.pdf");
  try{
    const res=await fetch(CLOUD_RUN_ENDPOINT,{method:"POST",body:formData,headers:{"Cache-Control":"no-cache"}});
    if(!res.ok){const t=await res.text().catch(()=> "");throw new Error(`API ${res.status} ${res.statusText} ${t}`)}
    return await res.json();
  }catch(err){
    console.error("Cloud Run 失敗：",err);
    addRow('Cloud Run 字體字型檢查',false,'CORS/快取問題：請確認 OPTIONS 與 Access-Control-Allow-Origin 設定。','請檢查 Cloud Run CORS 與公開存取設定。');return null;
  }
}
function normalizeApiResult(data){const pass=typeof data.pass==='boolean'?data.pass:(data.summary?.pass??data.ok??false);const suggestion=data.suggestion||data.summary?.suggestion||'';return {pass,suggestion}}
function buildEvidenceString(data){
  try{const parts=[]; if(data.summary?.pages)parts.push(`頁數：${data.summary.pages}`);
    if(data.summary?.dominant_fonts)parts.push(`主要字體：${data.summary.dominant_fonts.join('、')}`);
    if(Array.isArray(data.top_fonts))parts.push('常見字體：'+data.top_fonts.slice(0,6).join('、'));
    if(data.layout?.per_page_margins?.length){const f=data.layout.per_page_margins[0];parts.push(`第1頁邊界量測：左${f.left} / 右${f.right} / 上${f.top} / 下${f.bottom} pt（門檻≈${(72*2/2.54).toFixed(1)}）`);}
    return parts.join('｜')||JSON.stringify(data).slice(0,800);
  }catch{return typeof data==='object'?JSON.stringify(data).slice(0,800):String(data)}
}

/* ===== PDF 檢查 ===== */
async function runPdfChecks(buf){
  const {getDocument}=await window.loadPdfjs(); const pdf=await getDocument({data:buf}).promise;
  const numPages=pdf.numPages; _lastPageCount=numPages;

  const pageTexts=[];

  // 1) 頁數
  addRow('頁數 4–10',(numPages>=RULES.minPages&&numPages<=RULES.maxPages),`共 ${numPages} 頁`,'若少於4或多於10頁，請修訂篇幅。');

  let pageNumOkPages=[];
  let sequentialOk=true;
  const headerTitleTexts=[];
  let minLeft=Infinity,minRight=Infinity,minTop=Infinity,minBottom=Infinity;

  let firstHeaderOK=false, firstFooterOK=false;

  for(let p=1;p<=numPages;p++){
    const page=await pdf.getPage(p); const viewport=page.getViewport({scale:1}); const W=viewport.width,H=viewport.height;
    const tc=await page.getTextContent();

    const topBandMinY = H - MARGIN_PT;      // 距上緣 ≤ 2cm
    const bottomBandMaxY = MARGIN_PT;       // 距下緣 ≤ 2cm
    const centerTol = Math.max(W*0.15,72);  // 置中容忍（中心點 ± max(15%頁寬,72pt)）

    let hasCenterPageNum=false;
    const pageBuf=[];

    for(const it of tc.items){
      const tr=it.transform; const x=tr[4], y=tr[5]; const w=(typeof it.width==='number')?it.width:0;
      const txt=(it.str||'').trim();
      pageBuf.push(txt);

      // (A) 首頁：頁首 2cm 帶 + 置中（中心點判定）
      if(p===1 && txt){
        const mid = x + w/2;
        const centeredByMid = (mid >= (W/2 - centerTol) && mid <= (W/2 + centerTol));
        const inTop2cm = (y >= topBandMinY);
        const looksLikeTitle = !/^\d+$/.test(txt) && txt.replace(/\s/g,'').length >= 2;
        if(inTop2cm && centeredByMid && looksLikeTitle){ firstHeaderOK = true; }
      }

      // (B) 頁尾頁碼：2cm 帶 + 置中（接受常見樣式）
      const centeredBottomByMid = (()=>{const mid=x+w/2;return (mid >= (W/2 - centerTol) && mid <= (W/2 + centerTol));})();
      const inBottom2cm = (y <= bottomBandMaxY);
      const m = txt.match(/^\s*(?:第)?\s*[-—]*\s*(\d{1,4})\s*[-—]*(?:\s*頁)?\s*$/);
      if(inBottom2cm && centeredBottomByMid && m){
        const num=parseInt(m[1],10);
        hasCenterPageNum=true;
        if(num!==p) sequentialOk=false;
        if(p===1) firstFooterOK = true;
      }

      // 蒐集可能的頁首篇名文字（供「檔名 vs 頁首篇名」使用）
      if(y>=topBandMinY && txt){ headerTitleTexts.push(txt); }

      // 正文區：邊界估計
      const inBody=(y>MARGIN_PT)&&(y<(H-MARGIN_PT));
      if(inBody){
        const distLeft=x, distRight=W-(x+w), distBottom=y, distTop=H-y;
        if(distLeft<minLeft)minLeft=distLeft; if(distRight<minRight)minRight=distRight; if(distBottom<minBottom)minBottom=distBottom; if(distTop<minTop)minTop=distTop;
      }
    }
    if(hasCenterPageNum)pageNumOkPages.push(p);
    pageTexts[p]=pageBuf.join('');
  }

  // 2) 首頁頁首置中且距上緣 ≥ 2 公分
  addRow('首頁頁首置中且距上緣 ≥ 2 公分', firstHeaderOK,
    firstHeaderOK?'已在首頁 2 公分內偵測到置中之篇名/標題':'未偵測到置中篇名或未落在距上緣 2 公分內',
    '請將篇名置中於頁首，且位置落在距上緣 2 公分以內的區塊。');

  // 3) 首頁頁碼置中且距下緣 ≥ 2 公分
  addRow('首頁頁碼置中且距下緣 ≥ 2 公分', firstFooterOK,
    firstFooterOK?'已在首頁 2 公分內偵測到置中頁碼':'未偵測到置中頁碼或未落在距下緣 2 公分內',
    '請將頁碼置中於頁尾，且位置落在距下緣 2 公分以內的區塊。');

  // 5) 檔名 vs 頁首篇名一致
  const headerTitleGuess=(()=>{const n=s=>(s||'').replace(/\s/g,'').toLowerCase();const filtered=headerTitleTexts.filter(s=>n(s).length>=4);const freq=new Map();for(const s of filtered){const k=n(s);freq.set(k,(freq.get(k)||0)+1)}let bestKey='',bestCount=0;for(const [k,c] of freq){if(c>bestCount){bestKey=k;bestCount=c}}const raw=filtered.find(s=>n(s)===bestKey)||'';return{norm:bestKey,raw}})();
  const fileNorm=(fileBase||'').replace(/\s/g,'').toLowerCase(), titleNorm=headerTitleGuess.norm;
  const titleDetected=!!titleNorm, nameTitleConsistent = titleDetected && (titleNorm.includes(fileNorm)||fileNorm.includes(titleNorm));
  addRow('檔案名稱 與 頁首篇名一致性（不符判定淘汰）',nameTitleConsistent,
    titleDetected?`檔名「${fileBase}」；頁首篇名「${headerTitleGuess.raw}」`:'未偵測到可辨識的頁首篇名',
    '請使檔名與頁首篇名一致（常用小論文篇名）。');

  // 6) 每頁需有置中頁碼（底端帶）
  const pageNumPass=(pageNumOkPages.length===numPages);
  addRow('每頁需有置中頁碼（底端帶）',pageNumPass,
    pageNumPass?'所有頁底中央皆有頁碼':`缺少頁碼頁次：${missingRange(pageNumOkPages,numPages)}` + (sequentialOk?'':'；疑似非連號'),
    '請在頁尾置中放置阿拉伯數字頁碼（建議連號）。');

  // 7) 邊界 2 公分
  const marginPass=(minLeft>=MARGIN_PT)&&(minRight>=MARGIN_PT)&&(minBottom>=MARGIN_PT)&&(minTop>=MARGIN_PT);
  addRow('四周邊界 ≥ 2 公分（正文區推估）',marginPass,
    `估計最小邊界（pt）：左 ${isFinite(minLeft)?minLeft.toFixed(1):'—'}、右 ${isFinite(minRight)?minRight.toFixed(1):'—'}、上 ${isFinite(minTop)?minTop.toFixed(1):'—'}、下 ${isFinite(minBottom)?minBottom.toFixed(1):'—'}（門檻≈${MARGIN_PT.toFixed(1)}）`,
    '請確認版面設定至少 2 公分。');

  // 8) 不得有封面頁
  const firstText=pageTexts[1]||''; const coverHits=['封面','學校','指導老師','學生','班級','學號'].filter(k=>firstText.includes(k));
  addRow('不得有封面頁（4–10頁）',coverHits.length===0, coverHits.length?`第1頁疑似封面關鍵字：${coverHits.join('、')}`:'未發現','4–10頁之小論文不應包含封面資訊。');

  // 9) 文字規則
  runTextRules(pageTexts);
}

/* ===== DOCX ===== */
async function runDocxChecks(buf){
  const {value:html}=await window.mammoth.convertToHtml({arrayBuffer:buf});
  const text=stripHtml(html); _lastPageCount=0;
  addRow('頁數 4–10（DOCX）',true,'DOCX 無法精確估頁，建議匯出 PDF 再檢查空間規則。','請匯出 PDF。');
  runTextRules([text]);
}
function stripHtml(html){const t=document.createElement('div');t.innerHTML=html;return t.textContent||t.innerText||''}

/* ===== 參考文獻解析＋分類（新版） ===== */
function _isContinuationLine(line) {
  // 縮排、純網址/DOI/取自、符號項目開頭 → 併入上一條
  return (
    /^\s{2,}/.test(line) ||                 // 英文縮排
    /^[\u3000]{1,}/.test(line) ||           // 全形空白縮排
    /^(https?:\/\/|doi:|DOI:|取自|Available at|網址)/i.test(line) ||
    /^[-–•．·●]/.test(line)
  );
}
function _parseReferenceEntries(refText) {
  const lines = refText.split(/\n+/).map(s => s.trim()).filter(Boolean);
  const entries = [];
  let cur = '';

  for (const raw of lines) {
    const line = raw.replace(/\s+$/,'');
    if (!cur) { cur = line; continue; }

    if (_isContinuationLine(line)) {
      cur += ' ' + line;               // 併入上一筆
    } else if (/^\d+\./.test(line)) {  // 1. 2. 3. 編號開頭 → 開新筆
      entries.push(cur);
      cur = line.replace(/^\d+\.\s*/, '');
    } else {
      // 常見分隔：全形分號；空行已處理；否則視為同一條延伸
      if (/；$/.test(cur)) { entries.push(cur); cur = line; }
      else { cur += ' ' + line; }
    }
  }
  if (cur) entries.push(cur);

  // 粗過濾：明顯不是文獻的短行剔除
  return entries.filter(s => s.replace(/\s/g,'').length >= 6);
}
function _classifyReference(item) {
  const s = item;

  // A. 書籍／出版社
  const hasPublisher = /(出版社|Press\b|Publishing|出版|台北市|新北市|高雄市).{0,10}$/.test(s);

  // B. 期刊／卷期頁碼
  const hasJournalMeta =
    /(\bVol\.?\s*\d+|\bNo\.?\s*\d+|\bpp?\.?\s*\d+[-–]\d+|第\s*\d+\s*卷|第\s*\d+\s*期|頁\s*\d+[-–]\d+)/i.test(s) ||
    /(Journal|期刊|學報|通訊|評論).{0,40}\d{4}/.test(s);

  // C. 學位／會議論文
  const hasThesisOrConf =
    /(碩士論文|博士論文|學位論文|Master'?s|Ph\.?D\.?|dissertation|thesis|Proceedings|研討會|會議論文)/i.test(s);

  // D. 法規／政府公告
  const hasLawOrGov =
    /(法規|條例|辦法|函釋|教育部|衛福部|主計總處|行政院|內政部|各縣市政府)/.test(s);

  // E. 報紙／電子報（視為非網路資料來源的「報紙類」）
  const hasNewspaper =
    /(日報|電子報|聯合報|自由時報|中國時報|經濟日報|蘋果日報|天下雜誌|今周刊)/.test(s);

  if (hasPublisher || hasJournalMeta || hasThesisOrConf || hasLawOrGov || hasNewspaper) {
    return 'nonweb';
  }

  // 純網路類（社群／影音／部落格／一般網站文章等）
  const isPureWeb =
    /(YouTube|Facebook|Instagram|IG|X\.com|Twitter|PTT|Dcard|blogspot|wordpress|medium\.com|wiki|維基|論壇|部落格)/i.test(s) ||
    /(網站|網頁|線上文章|粉專)/.test(s);

  // 含網址但沒有任何出版/卷期/頁碼等出版證據 → 視為純網路
  const hasLink = /(https?:\/\/|doi\.org|doi:|取自|Available at|網址)/i.test(s);

  if (isPureWeb) return 'web';
  if (hasLink)    return 'web';

  // 兜底：未知 → 視為 nonweb，避免把「電子書/期刊」錯誤歸為網路
  return 'nonweb';
}

/* ===== 文字規則 ===== */
function runTextRules(pageTexts){
  const pages=pageTexts.length-1||1;
  const fullText = pageTexts.slice(1).join('\n\n[[PAGE_SPLIT]]\n\n');
  const sec=RULES.sixSections;
  const refIdx=fullText.indexOf('參考文獻');

  // 9) 不得含校名/姓名（避開參考文獻）
  const schoolHits=[]; const schoolPages=new Set();
  for(let p=1;p<=pages;p++){
    const t=pageTexts[p]||'';
    const pageStartOffset = fullText.indexOf(pageTexts[p]);
    if(refIdx>=0 && pageStartOffset>=refIdx) continue;
    for(const re of SCHOOL_PATTERNS){ const m=t.match(re); if(m&&m.length){schoolHits.push(...m); schoolPages.add(p);} }
  }
  addRow('不得含校名/姓名',schoolHits.length===0,
    schoolHits.length?`偵測到疑似校名：${[...new Set(schoolHits)].join('、')}｜頁次：${[...schoolPages].join(', ')}`:'未發現',
    '請去識別化（以 XXX 取代完整校名）。');

  // 10) 六大段落順序
  const idx=sec.map(s=>fullText.indexOf(s)); const hasAll=idx.every(i=>i>=0); const inOrder=hasAll && idx.join(',')===idx.slice().sort((a,b)=>a-b).join(',');
  addRow('六大段落依序',hasAll&&inOrder,hasAll?(inOrder?'順序正確':'找到各段落但順序錯誤'):'有段落缺失','請補齊並按規定順序排列：'+sec.join(' → '));

  // 11) 內文引註 作者-年份
  const citeA=/（[^，\n]{1,12}，\s*\d{4}）/g, citeB=/[^\s，。、]{1,12}（\s*\d{4}）/g;
  const hasCite=(fullText.match(citeA)?.length||0)+(fullText.match(citeB)?.length||0);
  addRow('內文引註採 作者-年份',hasCite>0,hasCite?`檢出 ${hasCite} 處`:'未檢出引註樣式','請使用（姓名，年份）或 姓名（年份）。');

  // 12) 直接引文 ≤ 50 字
  const quotesRaw=[...(fullText.match(/「[^」]{1,200}」/g)||[]),...(fullText.match(/“[^”]{1,200}”/g)||[])];
  const clean=s=>s.replace(PUNCT,''); const isDirect=q=>clean(q).length>=RULES.minQuoteCharsForDirect;
  const directQuotes=quotesRaw.filter(q=>isDirect(q)), over=directQuotes.filter(q=>clean(q).length>RULES.quoteMaxChars);
  addRow(`直接引文 ≤ ${RULES.quoteMaxChars} 字（不含標點與空白）`,over.length===0,over.length?`超標處：${over.length} 例`:(directQuotes.length?`OK（偵測 ${directQuotes.length} 例）`:'OK（未偵測引號片段）'),'引號內淨字數≥10才視為直接引文。');

  // 13) 疑似缺少引號之直接引文（格式錯誤）— 修正建議文字：僅「請加上『』」
  const noQuoteButCite = (fullText.match(/[^\n。！？]{8,80}(（[^，\n]{1,12}，\s*\d{4}）)/g)||[]).filter(seg=>clean(seg).length>=RULES.minQuoteCharsForDirect && !/[「“].+?[」”]/.test(seg));
  if(noQuoteButCite.length){
    addRow('疑似缺少引號之直接引文（格式錯誤）',false,`疑似片段數：${noQuoteButCite.length}（抽樣檢出）`,'直接引用原文時，請加上「」。');
  }

  // 14/16) 參考文獻（新版切條＋分類）
  const refAnchorIdx = fullText.indexOf('參考文獻');
  const refTextFull  = refAnchorIdx >= 0 ? fullText.slice(refAnchorIdx) : '';
  const refEntries   = refAnchorIdx >= 0 ? _parseReferenceEntries(refTextFull) : [];

  // A/B/C 統計（A=總數；B=含年份推估；C=含網址/DOI/取自的數量）
  const A_total = refEntries.length;
  const B_hasYear = refEntries.filter(s => /(（\d{4}）|\(\d{4}\)|\b\d{4}\b年)/.test(s)).length;
  const C_hasLink = refEntries.filter(s => /(https?:\/\/|doi\.org|doi:|取自|Available at|網址)/i.test(s)).length;

  // 分類：nonweb / web
  const classified = refEntries.map(s => ({ text: s, kind: _classifyReference(s) }));
  const nonwebCount = classified.filter(x => x.kind === 'nonweb').length;
  const webCount    = classified.filter(x => x.kind === 'web').length;

  // 14) 參考文獻 ≥ 3
  addRow('參考文獻 ≥ 3', A_total >= 3,
    `A. 總數：${A_total}｜B. 含年份推估：${B_hasYear}｜C. 含網址/DOI：${C_hasLink}`,
    '以整筆條目計數（標題＋出版資訊＋網址若換行視為同一條），至少 3 筆。');

  // 15) 圖表規範（含表內已引注例外）— 保留既有邏輯
  const figMatches=fullText.match(/(^|\n|\s)圖\s*\d+[\s．.、：:]/g)||[], tabMatches=fullText.match(/(^|\n|\s)表\s*\d+[\s．.、：:]/g)||[];
  const totalFT=figMatches.length+tabMatches.length;
  const srcAll=(fullText.match(/資料來源[:：]/g)||[]).length;
  let tableInlineOK=0; if(tabMatches.length){
    let pos=0; while((pos=fullText.indexOf('表',pos))>=0){const slice=fullText.slice(Math.max(0,pos-120),Math.min(fullText.length,pos+200)); if(/表\s*\d+/.test(slice) && /(（[^，\n]{1,12}，\s*\d{4}）|[^\s，。、]{1,12}（\s*\d{4}）)/.test(slice)) tableInlineOK++; pos+=1;}
  }
  const lackSource = (totalFT>0 && (srcAll+tableInlineOK)<totalFT);
  const lackLabel = (totalFT===0 && srcAll>0);
  const figPass = totalFT===0 ? true : (!lackSource && !lackLabel);
  const explain = (totalFT===0 && srcAll>0) ? '（文件出現多筆「資料來源：」但未偵測到任何「圖x/表x」標號，因此判定「缺標號＝是」。）' : '';
  addRow('圖表需有標號/標題與來源',figPass,
    `檢出圖/表 ${totalFT} 項；資料來源紀錄 ${srcAll} 項；表內已引注 ${tableInlineOK} 項；判定缺來源：${lackSource?'是':'否'}；判定缺標號：${lackLabel?'是':'否'} ${explain}`,
    '圖或表上方置左標號+標題；下方標示「資料來源：…」。若於表內已（作者，年代）引注，可不於表下再標。');

  // 16) 參考文獻與內文引註一致性（沿用原邏輯，但改用 refEntries）
  const refJoined = refEntries.join('\n');
  const citations=(fullText.match(/（[^，\n]{1,12}，\s*\d{4}）/g)||[]).map(s=>s.replace(/[（）\s]/g,'').replace(/，/g,''));
  let linked=0; for(const c of citations){ if(refJoined.includes(c)) linked++; }
  const unlinkedInText = Math.max(0,citations.length-linked);
  const refAuthors=(refJoined.match(/[\u4e00-\u9fa5A-Za-z]{1,12}（\d{4}/g)||[]).map(s=>s.replace(/（\d{4}.*/,'')); 
  const reverseUnlinked = refAuthors.filter(a=>!citations.some(c=>c.startsWith(a))).length;
  addRow('參考文獻與內文引註一致性',unlinkedInText===0 && reverseUnlinked<=1,
    `引註共 ${citations.length}；對應 ${linked}；未對應（內文→文獻）${unlinkedInText}；疑似未被引用（文獻→內文）${reverseUnlinked}`,
    '內文出現之引用需在參考文獻出現；未引用者不得列入參考文獻。');

  // 17) 參考文獻來源不可全為網路（新版：只要不是全部 web 即通過）
  const nonAllWebPass = (A_total > 0) && (webCount < A_total);
  const explain16 = `分類 → 非網路 ${nonwebCount}｜純網路 ${webCount}｜總數 ${A_total}（純網路≡社群/影音/一般網站文章；具出版/卷期/頁碼證據之電子書/期刊/論文/報紙皆為非網路）`;
  addRow('參考文獻來源不可全為網路', nonAllWebPass, explain16, '至少保留 1 筆非純網路來源（書籍/期刊/論文/報紙/會議/法規等）。');

  // 18) 字體/字型規範（同步進階結果或給建議）
  syncBasicFontRuleMirror();

  // 19) 外部檢索助手
  const extEvidence=buildExternalSearchEvidence(fileBase||'小論文篇名');
  addRow('作品是否已於校外發表/得獎（需人工/GPT）',true,extEvidence,'使用下方「外部檢索助手」或「複製查核提示」至 AI 小助手進行確認。');
  setTimeout(()=>initExternalSearchAssist(fileBase||'小論文篇名'),0);
}

/* ===== 外部檢索助手 ===== */
function buildExternalSearchEvidence(baseTitle){
  const t=(baseTitle||'小論文篇名').trim(), mk=s=>encodeURIComponent(s);
  const items=[
    {label:'Google Scholar（繁中）',href:`https://scholar.google.com/scholar?hl=zh-TW&q=${mk(t)}`,q:`${t}`},
    {label:'Google：題名 + 小論文 得獎',href:`https://www.google.com/search?q=${mk(t+' 小論文 得獎')}`,q:`${t} 小論文 得獎`},
    {label:'Google：題名 + 專題製作 比賽 歷屆 作品',href:`https://www.google.com/search?q=${mk(t+' 專題製作 比賽 歷屆 作品')}`,q:`${t} 專題製作 比賽 歷屆 作品`},
    {label:'Google：題名 + site:shs.edu.tw（台灣中學生網站）',href:`https://www.google.com/search?q=${mk(t+' site:shs.edu.tw')}`,q:`${t} site:shs.edu.tw`},
    {label:'Google：題名 + site:edu.tw 小論文',href:`https://www.google.com/search?q=${mk(t+' site:edu.tw 小論文')}`,q:`${t} site:edu.tw 小論文`}
  ];
  const links=items.map((it,i)=>`<li class="mono">#${i+1} ${it.label}：<a data-extlink href="${it.href}" target="_blank" rel="noopener">${it.q}</a></li>`).join('');
  return `<div id="extSearchPanel" class="extsearch"><div class="row"><button id="btnOpenAllSearch">一鍵開啟所有搜尋</button><button id="btnCopyGptPrompt" class="primary">複製查核提示（給 AI小助手）</button></div><div class="hint" style="margin-top:6px">以下為自動生成的查詢（即將檢索的內容）：</div><ul style="margin-top:6px">${links}</ul></div>`;
}
function initExternalSearchAssist(baseTitle){
  const panel=document.getElementById('extSearchPanel'); if(!panel)return;
  const btnOpen=panel.querySelector('#btnOpenAllSearch'), btnCopy=panel.querySelector('#btnCopyGptPrompt');
  btnOpen?.addEventListener('click',()=>{panel.querySelectorAll('a[data-extlink]').forEach(a=>window.open(a.href,'_blank','noopener'));});
  btnCopy?.addEventListener('click',async()=>{
    const t=(baseTitle||'小論文篇名').trim();
    const qsEls=panel.querySelectorAll('a[data-extlink]'); const qs=Array.from(qsEls).map((a,i)=>`(${i+1}) ${a.textContent} -> ${a.href}`).join('\n');
    const summary=(typeof lastSummaryJSON==='object'&&lastSummaryJSON)?JSON.stringify(lastSummaryJSON,null,2):(document.getElementById('jsonPreview')?.textContent||'');
    const prompt=`請協助進行「校外發表／得獎」外部檢索確認：
題名/檔名：${t}

請到以下來源檢索並彙整前 10 筆結果（標題、來源、年份、連結），同時判斷是否疑似相同題名之公開發表或得獎紀錄：
1) Google Scholar（繁中）
2) Google 關鍵字：題名 +「小論文 得獎」、題名 +「專題製作 比賽 歷屆 作品」
3) Google 限站：site:shs.edu.tw（台灣中學生網站）、site:edu.tw 小論文

請用表格＋條列輸出；最後給「是否查到疑似相同題名」結論與理由，並附上實際使用的查詢字串清單。

（附：本次檢查摘要 JSON）
${summary||'(若空白可忽略)'}

（查詢字串與連結預覽）
${qs}`;
    try{await navigator.clipboard.writeText(prompt);alert('已複製查核提示，請點「打開AI助手」並貼上。');}catch{alert('複製失敗，請重試。')}
  });
}

/* ===== 工具 ===== */
function missingRange(okPages,total){const ok=new Set(okPages);const miss=[];for(let i=1;i<=total;i++){if(!ok.has(i))miss.push(i)}return miss.length?miss.join(', '):'—'}
function addRow(rule,pass,evidence,suggestion){
  const tr=document.createElement('tr'); const badge=pass?'<span class="ok">通過</span>':'<span class="bad">未通過</span>';
  tr.innerHTML=`<td><span class="num">${++_ruleCounter}</span>${rule}</td><td>${badge}</td><td>${evidence||''}</td><td>${suggestion||''}</td>`; tbody.appendChild(tr);
  const map={
    '頁數 4–10':{rule_id:'file.pages',category:'檔案規格',severity:'critical'},
    '檔案名稱 與 頁首篇名一致性（不符判定淘汰）':{rule_id:'filename.title_consistency',category:'命名',severity:'critical'},
    '每頁需有置中頁碼（底端帶）':{rule_id:'footer.pagenum',category:'頁碼',severity:'critical'},
    '四周邊界 ≥ 2 公分（正文區推估）':{rule_id:'layout.margins',category:'版面',severity:'major'},
    '不得有封面頁（4–10頁）':{rule_id:'file.coverpage',category:'檔案規格',severity:'critical'},

    '首頁頁首置中且距上緣 ≥ 2 公分':{rule_id:'header.topmargin_firstpage',category:'頁首',severity:'critical'},
    '首頁頁碼置中且距下緣 ≥ 2 公分':{rule_id:'footer.bottommargin_firstpage',category:'頁碼',severity:'critical'},

    '不得含校名/姓名':{rule_id:'privacy.no_school_or_name',category:'隱私',severity:'critical'},
    '六大段落依序':{rule_id:'structure.sections_order',category:'結構',severity:'critical'},
    '內文引註採 作者-年份':{rule_id:'references.citation_style',category:'參考文獻',severity:'major'},
    [`直接引文 ≤ ${RULES.quoteMaxChars} 字（不含標點與空白）`]:{rule_id:'quotes.limit',category:'引文',severity:'major'},
    '疑似缺少引號之直接引文（格式錯誤）':{rule_id:'quotes.missing_quotes',category:'引文',severity:'major'},
    '引用原文需附出處（≤50字）':{rule_id:'references.citation_required',category:'參考文獻',severity:'critical'},
    '圖表需有標號/標題與來源':{rule_id:'figures.tables',category:'圖表',severity:'major'},

    '參考文獻 ≥ 3':{rule_id:'references.count',category:'參考文獻',severity:'critical'},
    '參考文獻與內文引註一致性':{rule_id:'references.consistency',category:'參考文獻',severity:'critical'},
    '參考文獻來源不可全為網路':{rule_id:'references.non_all_web',category:'參考文獻',severity:'critical'},

    '字體/字型規範（需人工確認）':{rule_id:'style.font',category:'版面',severity:'major'},
    '作品是否已於校外發表/得獎（需人工/GPT）':{rule_id:'external.duplicate_check',category:'人工檢查',severity:'minor'},
    '頁數 4–10（DOCX）':{rule_id:'file.pages.docx',category:'檔案規格',severity:'minor'},
    'Cloud Run 字體字型檢查':{rule_id:'fontcheck.cloudrun',category:'字體字型',severity:'major'}
  };
  const meta=map[rule]||{rule_id:'misc',category:'其他',severity:'minor'};
  _rowsBuffer.push({rule_id:meta.rule_id,category:meta.category,severity:meta.severity,pass,evidence:typeof evidence==='string'?{note:evidence}:(evidence||null),suggestion:suggestion||null});
}
function buildAndShowSummaryJSON({fileName='paper',pages=0,passFailRows=[]}={}){
  const weight=x=>x.severity==='critical'?2:(x.severity==='major'?1:0.5);
  const max=passFailRows.reduce((a,x)=>a+weight(x),0)||1; const score=Math.round(passFailRows.reduce((a,x)=>a+(x.pass?weight(x):0),0)/max*100);
  const hasCriticalFail=passFailRows.some(x=>!x.pass && x.severity==='critical'); const status=hasCriticalFail?'revise':'pass';
  const summary={meta:{report_id:(crypto.randomUUID?.()||String(Math.random()).slice(2)),generated_at:new Date().toISOString(),file:{name:fileName,pages,type:fileExt},rules_version:'v1.3'},
    summary:{score,totals:{checks:passFailRows.length,pass:passFailRows.filter(x=>x.pass).length,fail:passFailRows.filter(x=>!x.pass).length},status},
    checks:passFailRows.map(x=>({rule_id:x.rule_id,category:x.category,severity:x.severity,pass:x.pass,evidence:x.evidence||null,suggestion:x.suggestion||null}))};
  lastSummaryJSON=summary; jsonPreview.textContent=JSON.stringify(summary,null,2);
}

/* ===== 字體規範 mirror ===== */
function syncBasicFontRuleMirror(){
  if(_fontCheckMirror){
    addRow('字體/字型規範（需人工確認）',_fontCheckMirror.pass, `（同步進階檢查）${_fontCheckMirror.evidence||''}`, _fontCheckMirror.suggestion||'');
  }else{
    addRow('字體/字型規範（需人工確認）',true,'建議：中文新細明體 12pt；英文 Times New Roman 12pt；黑色字體。','若需精確檢查請使用「字體字型進階檢查」。');
  }
}

/* ===== 下載/複製 ===== */
downloadHtmlBtn.addEventListener('click',()=>{
  const html='<!doctype html><meta charset="utf-8"><title>小論文檢查報告</title>'+document.querySelector('#resultCard').outerHTML;
  const blob=new Blob([html],{type:'text/html;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='paper-check-report.html';a.click();URL.revokeObjectURL(a.href);
});
copyBtn.addEventListener('click',async()=>{if(!lastSummaryJSON){alert('尚未產生檢查摘要。');return;}await navigator.clipboard.writeText(JSON.stringify(lastSummaryJSON,null,2));alert('已複製檢查摘要 JSON，前往 AI助手 後直接貼上即可。')});
downloadJsonBtn.addEventListener('click',()=>{if(!lastSummaryJSON){alert('尚未產生檢查摘要。');return;}const blob=new Blob([JSON.stringify(lastSummaryJSON,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download((lastSummaryJSON.meta?.file?.name||'paper')+'.summary.json');a.click();URL.revokeObjectURL(a.href);});

/* ===== GAS 計數（Google 試算表累計） ===== */
async function bumpCounterEveryTime(){
  try{
    await fetch(GAS_WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json','Cache-Control':'no-cache'},body:JSON.stringify({action:'increment',site:'essayguard'})});
  }catch(e){console.warn('GAS increment failed',e);}
}
async function fetchCounter(){
  try{
    const res=await fetch(GAS_WEB_APP_URL+(GAS_WEB_APP_URL.includes('?')?'&':'?')+'action=get&site=essayguard',{headers:{'Accept':'application/json','Cache-Control':'no-cache'}});
    const text=await res.text();let data;try{data=JSON.parse(text);}catch{data={};}
    if(typeof data.count==='number'){counterEl.textContent=data.count.toLocaleString();}else{counterEl.textContent='0';}
  }catch(e){counterEl.textContent='0';}
}
if(ENABLE_COUNTER)fetchCounter();
</script>
</body>
</html>
