<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>高中職小論文格式自檢系統</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
    .wrap{max-width:960px;margin:auto;padding:24px}
    header h1{margin:0 0 4px;font-size:clamp(22px,4vw,28px)}
    header p{margin:0;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:14px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;font-size:12px}
    .hint{color:var(--muted);font-size:13px}
    .drop{border:2px dashed #cbd5e1;border-radius:12px;padding:24px;text-align:center;background:#fafafa;margin-top:8px}
    input[type=file]{display:none}
    label.file{display:inline-flex;align-items:center;gap:.6rem;padding:.7rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
    button{padding:.7rem 1.1rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    .ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.1rem .5rem;border-radius:999px;font-size:12px}
    .bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.1rem .5rem;border-radius:999px;font-size:12px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}
    th{background:#f9fafb}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    pre{white-space:pre-wrap;max-height:260px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
    .filetag{font-size:13px;color:#374151;margin:6px 0 0}
  </style>

  <!-- pdf.js -->
  <script type="module">
    window.loadPdfjs = async () => {
      const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
      const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
      GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
      return { getDocument };
    };
  </script>
  <!-- mammoth.js (docx 轉 html) -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>高中職小論文格式自檢系統</h1>
      <p>支援 PDF 與 DOCX 檔案，會檢查頁首、頁碼、邊界、段落與引用格式。</p>
    </header>

    <section class="card">
      <div class="row" aria-hidden="true">
        <div class="pill">PDF / DOCX</div>
        <div class="pill">頁數 4–10</div>
        <div class="pill">大小 ≤ 5MB</div>
        <div class="pill">不得含校名／姓名</div>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="consent" type="checkbox" />
        <label for="consent">我已閱讀並同意政策，並確認檔案不含 <span class="mono">校名/姓名</span>。</label>
      </div>
      <div id="drop" class="drop" aria-disabled="true">
        <p><strong>拖拉 PDF 或 DOCX 至此</strong></p>
        <label for="file" class="file">選擇檔案</label>
        <input id="file" type="file" accept=".pdf,.docx" disabled />
      </div>
      <div class="row" style="margin-top:8px">
        <button id="start" class="primary" disabled>開始檢查</button>
        <button id="clear" disabled>清除</button>
        <span id="status" class="hint"></span>
      </div>
    </section>

    <section id="resultCard" class="card" style="display:none">
      <h3>檢查結果</h3>
      <div id="fileTag" class="filetag"></div>
      <table>
        <thead><tr><th>規則</th><th>結果</th><th>證據 / 說明</th><th>建議</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <pre id="jsonPreview" class="mono"></pre>
    </section>
  </div>

  <script>
    const consent=document.getElementById('consent');
    const fileInput=document.getElementById('file');
    const startBtn=document.getElementById('start');
    const clearBtn=document.getElementById('clear');
    const statusEl=document.getElementById('status');
    const resultCard=document.getElementById('resultCard');
    const tbody=document.getElementById('tbody');
    const fileTagEl=document.getElementById('fileTag');
    const jsonPreview=document.getElementById('jsonPreview');

    let arrayBuffer=null,fileName=null,fileBase=null,fileExt=null,_ruleCounter=0,_lastPageCount=0,rowsBuffer=[];

    function setUploadEnabled(ok){fileInput.disabled=!ok;startBtn.disabled=!ok||!arrayBuffer;clearBtn.disabled=!ok||!arrayBuffer;}
    consent.addEventListener('change',()=>setUploadEnabled(consent.checked));
    fileInput.addEventListener('change',e=>{const f=e.target.files?.[0];if(f)handleFile(f);});
    async function handleFile(f){
      fileName=f.name;fileBase=f.name.replace(/\.[^.]+$/,'');fileExt=f.name.split('.').pop().toLowerCase();
      arrayBuffer=await f.arrayBuffer();statusEl.textContent=`已選擇：${f.name}`;setUploadEnabled(consent.checked);}
    clearBtn.addEventListener('click',()=>{fileInput.value='';arrayBuffer=null;fileName=null;fileBase=null;fileExt=null;setUploadEnabled(false);resultCard.style.display='none';tbody.innerHTML='';jsonPreview.textContent='';});
    startBtn.addEventListener('click',async()=>{
      tbody.innerHTML='';rowsBuffer=[];_ruleCounter=0;resultCard.style.display='none';
      if(fileExt==='pdf')await runPdfChecks(arrayBuffer);else await runDocxChecks(arrayBuffer);
      fileTagEl.textContent=`此次檢查檔案：${fileName}`;resultCard.style.display='block';buildSummaryJSON();
    });

    function addRow(rule,pass,evidence,suggestion){
      _ruleCounter++;const badge=pass?'<span class="ok">通過</span>':'<span class="bad">未通過</span>';
      const tr=document.createElement('tr');tr.innerHTML=`<td>${_ruleCounter}. ${rule}</td><td>${badge}</td><td>${evidence||''}</td><td>${suggestion||''}</td>`;
      tbody.appendChild(tr);
      rowsBuffer.push({rule_id:rule,pass,evidence:{note:evidence},suggestion});
    }
    function buildSummaryJSON(){
      const summary={meta:{file:fileName,pages:_lastPageCount,type:fileExt},checks:rowsBuffer};
      jsonPreview.textContent=JSON.stringify(summary,null,2);
    }

    async function runPdfChecks(buf){
      const { getDocument }=await window.loadPdfjs();const pdf=await getDocument({data:buf}).promise;_lastPageCount=pdf.numPages;
      // 偵測頁首篇名
      let headerTitleTexts=[];let headerHasFile=new Set();
      const norm=s=>(s||'').replace(/\s/g,'').toLowerCase();
      const fileNorm=norm(fileBase);
      for(let p=1;p<=pdf.numPages;p++){
        const page=await pdf.getPage(p);const v=page.getViewport({scale:1});const H=v.height;
        const tc=await page.getTextContent();const headerBandY=H-50;
        for(const it of tc.items){
          const y=it.transform[5];const txt=(it.str||'').trim();if(!txt)continue;
          if(y>=headerBandY)headerTitleTexts.push(txt);
          if(norm(txt).includes(fileNorm)&&y>=headerBandY)headerHasFile.add(p);
        }
      }
      const missing=[];for(let i=1;i<=pdf.numPages;i++){if(!headerHasFile.has(i))missing.push(i);}
      addRow("每頁需在頁首帶包含檔名",missing.length===0,missing.length?`缺少頁首頁次：${missing.join(',')}`:'OK',"請將檔名放頁首");
      // 檔案名稱 vs 頁首篇名
      const norm=s=>(s||'').replace(/\s/g,'').toLowerCase();
      const counts={};headerTitleTexts.forEach(t=>{const n=norm(t);if(n.length>=4)counts[n]=(counts[n]||0)+1;});
      const guess=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]||['','0'];
      const titleNorm=guess[0],titleRaw=headerTitleTexts.find(t=>norm(t)===titleNorm)||'';
      const consistent=titleNorm&&(titleNorm.includes(fileNorm)||fileNorm.includes(titleNorm));
      addRow("檔案名稱 與 頁首篇名一致性（不符判定淘汰）",consistent,titleRaw?`檔名:${fileBase}；篇名:${titleRaw}`:'未偵測到篇名',"請保持一致，否則淘汰");
    }
    async function runDocxChecks(buf){
      const { value: html }=await window.mammoth.convertToHtml({arrayBuffer:buf});
      const text=stripHtml(html);addRow("DOCX 文字檢查",true,"OK","匯出 PDF 再檢查頁首/篇名");
    }
    function stripHtml(html){const d=document.createElement('div');d.innerHTML=html;return d.textContent||d.innerText||'';}
  </script>
</body>
</html>