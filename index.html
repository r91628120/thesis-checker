<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>高中職小論文格式自檢系統（v1.5D 協作版）</title>

<!-- ===== 發版字串（改這行就能強制換新） ===== -->
<script>
  const APP_VER = '2025-10-23-collab-v1.5D';
  (function () {
    try {
      const url = new URL(location.href);
      if (url.searchParams.get('v') !== APP_VER) {
        url.searchParams.set('v', APP_VER);
        location.replace(url.toString());
      }
    } catch (e) {}
  })();
  console.log("載入版本:", (new URL(location.href)).searchParams.get('v') || APP_VER);
</script>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
:root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
.wrap{max-width:1000px;margin:auto;padding:24px}
header h1{margin:0 0 4px;font-size:clamp(22px,4vw,28px)}header p{margin:0;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.pill{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;font-size:12px}
.hint{color:var(--muted);font-size:13px}
.drop{border:2px dashed #cbd5e1;border-radius:12px;padding:24px;text-align:center;background:#fafafa;margin-top:8px}
input[type=file]{display:none}
label.file{display:inline-flex;gap:.6rem;padding:.7rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
button{padding:.7rem 1.1rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:transparent}
button:disabled{opacity:.5;cursor:not-allowed}
.ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.1rem .5rem;border-radius:999px;font-size:12px}
.bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.1rem .5rem;border-radius:999px;font-size:12px}
table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}th{background:#f9fafb}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}pre{white-space:pre-wrap;max-height:260px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
.filetag{font-size:13px;color:#374151;margin:6px 0 0}.num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:6px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px;color:#374151;font-weight:600}
.extsearch{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;margin-top:6px}.extsearch ul{margin:6px 0 0 18px;padding:0}.extsearch li{margin:4px 0}

/* 單獨 GPT 檢查按鈕（淡粉紅） */
.btn-gpt{background:#f8c8dc;color:#333;border:1px solid #f5a6c4;border-radius:10px;padding:.7rem 1.1rem;font-weight:600;cursor:pointer;transition:background .15s}
.btn-gpt:hover{ background:#f5a6c4; }
.btn-gpt:disabled{ opacity:.5; cursor:not-allowed; }

/* 模式切換 Segmented control */
.mode{display:flex;gap:6px;flex-wrap:wrap}
.mode button{padding:.45rem .9rem;border-radius:999px;border:1px solid #d1d5db;background:#fff;font-size:13px}
.mode button.active{background:#111827;color:#fff;border-color:#111827}

/* 小角落說明 */
.small{font-size:12px;color:#6b7280}

</style>

<!-- pdf.js (ESM) -->
<script type="module">
  window.loadPdfjs = async () => {
    const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
    const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
    GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
    return { getDocument };
  };
</script>
<!-- mammoth.js -->
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>高中職小論文格式自檢系統 <span class="small">（v1.5D 協作版｜嚴格模式｜繁體）</span></h1>
    <p class="small">支援 PDF / DOCX；解析僅在瀏覽器記憶體中，完成即釋放，不留存。</p>
    <div class="hint" id="counterBox">目前累積小論文格式自檢人次：<b id="counter">載入中…</b>　<span class="mono">v=<script>document.write(new URL(location.href).searchParams.get('v')||APP_VER)</script></span></div>
  </header>

  <section class="card">
    <div class="row"><div class="pill">PDF / DOCX</div><div class="pill">頁數 4–10</div><div class="pill">≤ 5MB</div><div class="pill">不得含校名／姓名</div></div>
    <div class="row" style="margin-top:8px"><input id="consent" type="checkbox"/><label for="consent">我已閱讀並同意，且確認檔案不含 <span class="mono">校名/姓名</span>。</label></div>
    
    <!-- ===== 模式切換：前端 / 單獨 GPT#2 / 混合（合併） ===== -->
    <div class="row" style="margin-top:8px;align-items:flex-start">
      <div class="mode" role="tablist" aria-label="檢查模式">
        <button id="mFrontend" class="active" role="tab" aria-selected="true">前端檢查</button>
        <button id="mGPT" role="tab" aria-selected="false">單獨 GPT#2</button>
        <button id="mHybrid" role="tab" aria-selected="false">混合：前端＋GPT#2</button>
      </div>
      <div class="small">說明：
        <ul style="margin:6px 0 0 18px">
          <li><b>前端</b>：版面/頁碼/段落等規則；
          <li><b>單獨 GPT#2</b>：直接在 GPT 解析 PDF；
          <li><b>混合</b>：先跑前端，再匯入 GPT#2 的 <code>.summary.json</code> 合併，提升圖表/引註/文獻的精準度。
        </ul>
      </div>
    </div>

    <div id="drop" class="drop" aria-disabled="true">
      <p><strong>拖拉 PDF 或 DOCX 到這裡</strong></p>
      <label for="file" class="file">選擇檔案</label>
      <input id="file" type="file" accept=".pdf,.docx" disabled/>
      <p class="hint">完成檢查即釋放／不保存。</p>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="start" class="primary" disabled>開始檢查（依模式）</button>
      <button id="clear" disabled>清除</button>
      <button id="fontCheckBtn" disabled>字體字型進階檢查</button>
      
      <!-- 單獨 GPT#2 入口（保持原有連結） -->
      <a id="gptCheckBtn" class="btn-gpt" href="https://chatgpt.com/g/g-68f77bc5d4008191802b3e5984de6f72-gao-zhong-zhi-xiao-lun-wen-ge-shi-ji-he-yuan-copy" target="_blank" rel="noopener noreferrer">單獨 GPT 檢查 PDF 檔案</a>

      <span id="status" class="hint" role="status" aria-live="polite"></span>
    </div>

    <!-- ====== 混合模式：匯入 GPT#2 報告 + 合併 ====== -->
    <details id="hybridPanel" class="hint" style="margin-top:8px;display:none">
      <summary><b>混合模式工具</b>（先跑前端，再匯入 GPT#2 報告並合併）</summary>
      <div class="row" style="margin-top:8px">
        <label for="gptJsonFile" class="file">選擇 GPT#2 報告（.summary.json）</label>
        <input id="gptJsonFile" type="file" accept="application/json"/>
        <button id="btnMerge" disabled>合併報告（前端＋GPT#2）</button>
        <button id="btnShowDelta" disabled>顯示差異比對</button>
      </div>
      <div class="small" id="mergeTip">匯入後可計算「一致率」，目標 ≥ 92%。</div>
      <pre id="deltaPreview" class="mono" style="display:none;margin-top:8px"></pre>
    </details>

  </section>

  <section class="card" id="spec">
    <h2>系統檢查規則（合格標準）</h2>
    <ol>
      <li>頁數：4–10 頁。</li>
      <li>首頁篇名需置中且落在距上緣 2 公分內。</li>
      <li>首頁頁碼需置中且落在距下緣 2 公分內。</li>
      <li>檔案名稱與頁首篇名一致（不符判定淘汰）。</li>
      <li>每頁需有置中頁碼（底端帶）。</li>
      <li>四周邊界 ≥ 2 公分（正文區推估）。</li>
      <li>不得有封面頁（4–10頁）。</li>
      <li>不得含校名/姓名（參考文獻之後的區段自動略過）。</li>
      <li>六大段落依序：前言 → 文獻探討 → 研究方法 → 研究分析與結果 → 研究結論與建議 → 參考文獻。</li>
      <li>內文引註採 作者-年份；直接引文 ≤ 50 字（不含標點）。</li>
      <li>參考文獻 ≥ 3；顯示四層統計（總數/合格/不合格/網路來源）。</li>
      <li>圖表需有標號/標題與來源（表內已引注可不於表下再標）。</li>
      <li>參考文獻與內文引註一致；來源不可全為網路。</li>
      <li>字體/字型規範（可用進階檢查）。</li>
      <li>校外發表/得獎：外部檢索助手 + GPT 提示。</li>
    </ol>
    <p class="hint">※ 本系統為輔助工具，仍需老師覆核。</p>
  </section>

  <section class="card" id="resultCard" style="display:none">
    <h3>檢查結果</h3>
    <div id="fileTag" class="filetag"></div>
    <table><thead><tr><th>規則</th><th>結果</th><th>證據 / 說明</th><th>建議</th></tr></thead><tbody id="tbody"></tbody></table>
    <div class="row" style="margin-top:8px">
      <button id="downloadHtml">下載檢查結果（網頁）</button>
      <button id="copyJson">複製檢查結果 (給AI助手)</button>
      <button id="downloadJson">儲存檢查結果檔案</button>
      <a id="openGpts" class="primary" href="https://chatgpt.com/g/g-68c6d9e700c88191872154808e0e0e7b-gao-zhong-zhi-xiao-lun-wen-ge-shi-zi-jian-xi-tong" target="_blank" rel="noopener">打開AI助手（貼上檢查結果）</a>
    </div>
    <pre id="jsonPreview" class="mono" style="margin-top:8px"></pre>
  </section>
</div>

<script>
/* ===== 可切換的功能旗標 ===== */
// 將「易漏項（圖表/引註/參考文獻）」交給 GPT#2 時，可把下列設為 false 以加速前端：
const ENABLE_TEXT_HEAVY_RULES = true;   // 註解：設為 false 將跳過 #10、#11、#12、#13

/* ===== 環境設定 ===== */
const GAS_WEB_APP_URL = "";             // 可留空；如需顯示人次再填
const ENABLE_COUNTER = false;            // 先關閉，避免阻塞
const CLOUD_RUN_BASE = "https://font-check-api-1009467346209.asia-east1.run.app";
const CLOUD_RUN_ENDPOINT = CLOUD_RUN_BASE + "/check";

/* ===== UI 變數 ===== */
const consent=document.getElementById('consent'),fileInput=document.getElementById('file'),drop=document.getElementById('drop');
const startBtn=document.getElementById('start'),clearBtn=document.getElementById('clear'),fontCheckBtn=document.getElementById('fontCheckBtn');
const statusEl=document.getElementById('status'),resultCard=document.getElementById('resultCard'),tbody=document.getElementById('tbody');
const downloadHtmlBtn=document.getElementById('downloadHtml'),copyBtn=document.getElementById('copyJson'),downloadJsonBtn=document.getElementById('downloadJson');
const jsonPreview=document.getElementById('jsonPreview'),counterEl=document.getElementById('counter'),fileTagEl=document.getElementById('fileTag');
const mFrontend=document.getElementById('mFrontend'), mGPT=document.getElementById('mGPT'), mHybrid=document.getElementById('mHybrid');
const hybridPanel=document.getElementById('hybridPanel');
const gptJsonFile=document.getElementById('gptJsonFile');
const btnMerge=document.getElementById('btnMerge');
const btnShowDelta=document.getElementById('btnShowDelta');
const deltaPreview=document.getElementById('deltaPreview');

/* ===== 狀態 ===== */
let arrayBuffer=null, fileName=null, fileBase=null, fileExt=null, lastSummaryJSON=null, _lastPageCount=0;
let FRONTEND_JSON=null, GPT_JSON=null, MERGED_JSON=null;
let activeMode='frontend'; // 'frontend' | 'gpt' | 'hybrid'

/* ===== 規則常數 ===== */
const RULES = { minPages:4, maxPages:10, maxSizeMB:5, sixSections:['前言','文獻探討','研究方法','研究分析與結果','研究結論與建議','參考文獻'], quoteMaxChars:50, minQuoteCharsForDirect:10, marginCM:2.0 };
const CM_TO_PT = cm => cm * 72 / 2.54; const MARGIN_PT = CM_TO_PT(RULES.marginCM);

/* ===== 模式切換 ===== */
[mFrontend,mGPT,mHybrid].forEach(btn=>btn.addEventListener('click',()=>{
  [mFrontend,mGPT,mHybrid].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  activeMode = btn===mFrontend?'frontend':(btn===mGPT?'gpt':'hybrid');
  hybridPanel.style.display = (activeMode==='hybrid')?'block':'none';
  statusEl.textContent = `已切換模式：${{frontend:'前端檢查',gpt:'單獨 GPT#2',hybrid:'混合：前端＋GPT#2'}[activeMode]}`;
}));

/* ===== 可用性 ===== */
function setUploadEnabled(ok){
  fileInput.disabled=!ok; const has=!!arrayBuffer;
  startBtn.disabled = !ok || (!has && activeMode!=='gpt'); // gpt 模式可不選檔，直接點連結
  clearBtn.disabled = !ok || !has; fontCheckBtn.disabled = !ok || !has || fileExt!=='pdf';
}
statusEl.textContent='請先同意政策。'; setUploadEnabled(false);
consent.addEventListener('change',()=>{ setUploadEnabled(consent.checked); statusEl.textContent = consent.checked? '已同意，可上傳。':'請先同意政策。'; });

/* DnD / 檔案處理 */
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();if(!fileInput.disabled)drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');}));
drop.addEventListener('drop',e=>{if(fileInput.disabled)return;const f=e.dataTransfer.files?.[0];if(f)handleFile(f);});
fileInput.addEventListener('change',e=>{const f=e.target.files?.[0];if(f)handleFile(f);});
function baseName(n){return(n||'').replace(/\.[^.]+$/,'').trim();}
async function handleFile(f){
  const ext=(f.name.split('.').pop()||'').toLowerCase(); if(!['pdf','docx'].includes(ext)){statusEl.textContent='僅支援 PDF 或 DOCX';return;}
  if(f.size>RULES.maxSizeMB*1024*1024){statusEl.textContent=`檔案超過 ${RULES.maxSizeMB}MB 上限。`;return;}
  fileName=f.name;fileBase=baseName(f.name);fileExt=ext;arrayBuffer=await f.arrayBuffer();
  statusEl.textContent=`已選擇：${f.name}（${(f.size/1024/1024).toFixed(2)} MB）`;
  setUploadEnabled(consent.checked);
}
clearBtn.addEventListener('click',()=>{
  fileInput.value='';arrayBuffer=null;fileName=fileBase=fileExt=null;startBtn.disabled = true;clearBtn.disabled = true;fontCheckBtn.disabled = true;
  resultCard.style.display='none';tbody.innerHTML='';fileTagEl.textContent='';statusEl.textContent='已清除。';jsonPreview.textContent='';lastSummaryJSON=null;FRONTEND_JSON=GPT_JSON=MERGED_JSON=null;deltaPreview.style.display='none';
});

/* ===== 主流程 ===== */
startBtn.addEventListener('click',async()=>{
  if(activeMode==='gpt'){
    // 直接導向單獨 GPT（不在前端解析）
    window.open(document.getElementById('gptCheckBtn').href,'_blank','noopener');
    return;
  }
  if(!arrayBuffer){ statusEl.textContent='請先選擇檔案'; return; }
  tbody.innerHTML=''; resultCard.style.display='none'; statusEl.textContent='解析中…';
  try{
    if(fileExt==='pdf'){ await runPdfChecks(arrayBuffer); } else { await runDocxChecks(arrayBuffer); }
    resultCard.style.display='block'; fileTagEl.textContent=`此次檢查檔案：${fileName||'(未命名)'}`; statusEl.textContent='完成檢查（前端）。';
    FRONTEND_JSON = lastSummaryJSON; MERGED_JSON = null; // 重置
  }catch(e){ console.error(e); statusEl.textContent='解析失敗：請確認檔案是否有效。'; }
});

/* ===== 匯入 GPT#2 報告 + 合併 ===== */
gptJsonFile?.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f){ btnMerge.disabled=true; btnShowDelta.disabled=true; return; }
  try{
    const txt = await f.text(); GPT_JSON = JSON.parse(txt);
    btnMerge.disabled = !FRONTEND_JSON; // 需先跑完前端
    btnShowDelta.disabled = false;
    statusEl.textContent = '已載入 GPT#2 報告。可執行「合併」或「顯示差異」。';
  }catch(err){ alert('讀取 JSON 失敗'); GPT_JSON=null; }
});

btnMerge?.addEventListener('click', ()=>{
  if(!FRONTEND_JSON || !GPT_JSON){ alert('請先完成前端檢查並匯入 GPT#2 報告'); return; }
  MERGED_JSON = mergeReports(FRONTEND_JSON, GPT_JSON);
  lastSummaryJSON = MERGED_JSON; // 以合併為主
  jsonPreview.textContent = JSON.stringify(MERGED_JSON, null, 2);
  statusEl.textContent = `合併完成。一致率：${Math.round((MERGED_JSON.summary?.consistency||0)*100)}%`;
});

btnShowDelta?.addEventListener('click', ()=>{
  if(!FRONTEND_JSON || !GPT_JSON){ alert('請先完成前端檢查並匯入 GPT#2 報告'); return; }
  const delta = diffReports(FRONTEND_JSON, GPT_JSON);
  deltaPreview.style.display='block';
  deltaPreview.textContent = JSON.stringify(delta, null, 2);
});

/* ===== 合併器（協作核心） ===== */
function keyBy(array, key){ const m=new Map(); for(const x of array) m.set(x[key], x); return m; }
function weightOf(sev){ return sev==='critical'?2: (sev==='major'?1:0.5); }

function mergeReports(frontendJson, gptJson){
  const A = structuredClone(frontendJson || {});
  const B = structuredClone(gptJson || {});
  const a = Array.isArray(A.checks)?A.checks:[];
  const b = Array.isArray(B.checks)?B.checks:[];
  const mapB = keyBy(b,'rule_id');

  let agree=0, total=0;

  for(const row of a){
    const peer = mapB.get(row.rule_id);
    if(peer){
      // 取較嚴格：任一未通過則 fail
      const before = row.pass;
      row.pass = row.pass && !!peer.pass;
      row.evidence = { frontend: row.evidence||null, gpt: peer.evidence||null };
      // 一致率：同 pass/fail 視為一致
      if(typeof before==='boolean' && typeof peer.pass==='boolean'){ total++; if(before===peer.pass) agree++; }
    }
  }

  // 追加 B 中 A 沒有的規則（可選）
  const aIds = new Set(a.map(x=>x.rule_id));
  for(const row of b){
    if(!aIds.has(row.rule_id)){
      a.push({ ...row, note:'（僅 GPT#2 報告含此規則）' });
    }
  }

  // 重算分數
  const max=a.reduce((s,x)=>s+weightOf(x.severity||'minor'),0)||1;
  const got=a.reduce((s,x)=>s+(x.pass?weightOf(x.severity||'minor'):0),0);
  const score=Math.round(got/max*100);
  const hasCriticalFail=a.some(x=>!x.pass && x.severity==='critical');

  const merged = {
    meta: { from:A.meta||{}, gpt:B.meta||{}, merged_at:new Date().toISOString(), rules_version: (A.meta?.rules_version||B.meta?.rules_version||'v1.4') },
    summary: { score, totals:{ checks:a.length, pass:a.filter(x=>x.pass).length, fail:a.filter(x=>!x.pass).length }, status: hasCriticalFail?'revise':'pass', consistency: (total? (agree/total):1) },
    merged_from: ['frontend','gpt2'],
    checks: a
  };
  // 顯示
  jsonPreview.textContent = JSON.stringify(merged, null, 2);
  return merged;
}

function diffReports(frontendJson, gptJson){
  const a = Array.isArray(frontendJson?.checks)?frontendJson.checks:[];
  const b = Array.isArray(gptJson?.checks)?gptJson.checks:[];
  const mapB = keyBy(b,'rule_id');
  const diffs = [];
  for(const row of a){
    const peer = mapB.get(row.rule_id);
    if(!peer) continue;
    if(!!row.pass !== !!peer.pass){
      diffs.push({ rule_id: row.rule_id, frontend: row.pass, gpt: peer.pass });
    }
  }
  return { disagree: diffs.length, items: diffs };
}

/* ===== 進階字體檢查（保留） ===== */
fontCheckBtn.addEventListener('click', async () => {
  const picked = document.querySelector('#file')?.files?.[0];
  const fallbackBlob = arrayBuffer? new Blob([arrayBuffer], { type: "application/pdf" }) : null;
  const fileForUpload = picked || fallbackBlob; const nameForServer = picked?.name || fileName || "upload.pdf";
  if (!fileForUpload || fileExt !== 'pdf') { alert('請先選擇一個 PDF 檔再進行字體檢查。'); return; }
  try {
    statusEl.textContent = '上傳至 Cloud Run 進行字體檢查…';
    const data = await fetchCloudRun(fileForUpload, nameForServer);
    if (data) {
      const pass = typeof data.pass==='boolean'?data.pass:(data.summary?.pass??false);
      addRow('Cloud Run 字體字型檢查', !!pass, 'API 回傳概要：'+ (data.summary?JSON.stringify(data.summary):''), '若未通過，請依規範修正字體。');
      buildAndShowSummaryJSON(); resultCard.style.display='block'; fileTagEl.textContent = `此次檢查檔案：${fileName || '(未命名)'}`; statusEl.textContent = 'Cloud Run 檢查完成。';
    }
  } catch (e) { console.error(e); statusEl.textContent = 'Cloud Run 檢查失敗。'; }
});
async function fetchCloudRun(fileOrBlob, nameForServer){
  const formData = new FormData(); formData.append("file", fileOrBlob, nameForServer || "upload.pdf");
  const url = CLOUD_RUN_ENDPOINT + "?v=" + Date.now();
  const res = await fetch(url, { method: "POST", mode: "cors", cache: "no-store", body: formData });
  if (!res.ok) throw new Error(`API ${res.status} ${res.statusText}`);
  return await res.json();
}

/* ===== PDF/DOCX 解析與規則（精簡：保留版面規則，文字重規則依旗標） ===== */
const PUNCT=/[，。、．；：、！？—─\-…‧（）()〔〕【】《》〈〉「」『』“”"'\[\]{}<>‧·~`^_=+\|\\/:，,.;:!\?\s]/g;
const SCHOOL_PATTERNS=[/(國立|市立|縣立)[\u4e00-\u9fa5]{0,8}(高級中學|高中|高職|高工|家商|商工|農工|高農|職業學校|中學|國中|小學|大學|科技大學|科大|師範大學|大學附中|實驗高中|高中部)/g];

async function runPdfChecks(buf){
  const {getDocument}=await window.loadPdfjs(); const pdf=await getDocument({data:buf}).promise;
  const numPages=pdf.numPages; _lastPageCount=numPages; const pageTexts=[];

  addRow('頁數 4–10',(numPages>=RULES.minPages&&numPages<=RULES.maxPages),`共 ${numPages} 頁`,'若少於4或多於10頁，請修訂篇幅。');

  let pageNumOkPages=[]; let headerTitleTexts=[]; let minLeft=Infinity,minRight=Infinity,minTop=Infinity,minBottom=Infinity; let firstHeaderOK=false, firstFooterOK=false;
  for(let p=1;p<=numPages;p++){
    const page=await pdf.getPage(p); const viewport=page.getViewport({scale:1}); const W=viewport.width,H=viewport.height; const tc=await page.getTextContent();
    const topBandMinY = H - MARGIN_PT; const bottomBandMaxY = MARGIN_PT; const centerTol = Math.max(W*0.15,72);
    let hasCenterPageNum=false; const pageBuf=[]; let _lastXY=null;

    for(const it of tc.items){
      const tr=it.transform; const x=tr[4], y=tr[5]; const w=(typeof it.width==='number')?it.width:0; const txt=(it.str||'').trim();
      if(txt){ if(_lastXY){ const newLine=(Math.abs(y - _lastXY.y) > 6 && x < _lastXY.x + 20) || (y < _lastXY.y - 2 && x <= _lastXY.x); if(newLine) pageBuf.push('\n'); } pageBuf.push(txt); _lastXY={x,y}; }
      const mid = x + w/2; const centeredTop = (mid >= (W/2 - centerTol) && mid <= (W/2 + centerTol)) && (y >= topBandMinY);
      const centeredBottom = (mid >= (W/2 - centerTol) && mid <= (W/2 + centerTol)) && (y <= bottomBandMaxY);
      if(p===1 && centeredTop && txt && !/^\d+$/.test(txt) && txt.replace(/\s/g,'').length>=2) firstHeaderOK=true;
      const m = txt.match(/^\s*(?:第)?\s*[-—]*\s*(\d{1,4})\s*[-—]*(?:\s*頁)?\s*$/); if(centeredBottom && m){ hasCenterPageNum=true; if(p===1) firstFooterOK=true; }
      // 取正文框估邊界（第1頁）
      if(p===1){ const inBody=(y> MARGIN_PT)&&(y < (H - MARGIN_PT)); if(inBody){ const distLeft=x, distRight=W-(x+w), distBottom=y, distTop=H-y; if(distLeft<minLeft)minLeft=distLeft; if(distRight<minRight)minRight=distRight; if(distBottom<minBottom)minBottom=distBottom; if(distTop<minTop)minTop=distTop; }}
    }
    if(hasCenterPageNum)pageNumOkPages.push(p); pageTexts[p]=pageBuf.join('');
  }

  addRow('首頁篇名需置中且落在距上緣 2 公分內', firstHeaderOK, firstHeaderOK?'已於首頁偵測到置中之篇名/標題':'未偵測到置中篇名或位置不在 2 公分內','請將篇名置中於頁首，且位置落在距上緣 2 公分以內。');
  addRow('首頁頁碼需置中且落在距下緣 2 公分內', firstFooterOK, firstFooterOK?'已於首頁偵測到置中頁碼':'未偵測到置中頁碼或位置未落在距下緣 2 公分內','請將頁碼置中於頁尾，並保持距下緣 2 公分以內。');

  const pageNumPass=(pageNumOkPages.length===_lastPageCount);
  addRow('每頁需有置中頁碼（底端帶）',pageNumPass, pageNumPass?'所有頁底中央皆有頁碼':`缺少頁碼頁次：${missingRange(pageNumOkPages,_lastPageCount)}`, '請在頁尾置中放置阿拉伯數字頁碼。');

  const marginPass = [minLeft,minRight,minBottom,minTop].every(v=>isFinite(v) && (v + 0.8) >= MARGIN_PT);
  addRow('四周邊界 ≥ 2 公分（正文區推估）', marginPass, `估計最小邊界（pt）：左 ${isFinite(minLeft)?minLeft.toFixed(1):'—'}、右 ${isFinite(minRight)?minRight.toFixed(1):'—'}、上 ${isFinite(minTop)?minTop.toFixed(1):'—'}、下 ${isFinite(minBottom)?minBottom.toFixed(1):'—'}`, '只要第1頁正文四邊皆 ≥ 2 公分，即視為版面合格。');

  // 封面與隱私
  const fullText = pageTexts.slice(1).join('\n'); const firstText=pageTexts[1]||''; const coverHits=['封面','學校','指導老師','學生','班級','學號'].filter(k=>firstText.includes(k));
  addRow('不得有封面頁（4–10頁）',coverHits.length===0, coverHits.length?`第1頁疑似封面關鍵字：${coverHits.join('、')}`:'未發現','4–10頁之小論文不應包含封面資訊。');
  // 校名/姓名（簡版）
  const schoolHits=(fullText.match(SCHOOL_PATTERNS[0])||[]); addRow('不得含校名/姓名',schoolHits.length===0, schoolHits.length?`疑似：${[...new Set(schoolHits)].slice(0,6).join('、')}`:'未發現','請去識別化（以 XXX 取代完整校名）。');

  // 文字重規則：視旗標決定是否交給 GPT#2
  if(ENABLE_TEXT_HEAVY_RULES){ runTextRules(pageTexts); }

  buildAndShowSummaryJSON({fileName,pages:_lastPageCount||0});
}

async function runDocxChecks(buf){
  const { value: html } = await window.mammoth.convertToHtml({ arrayBuffer: buf });
  const text = stripHtml(html); _lastPageCount = 0;
  addRow('頁數 4–10（DOCX）', true, 'DOCX 無法精確估頁，建議匯出 PDF 再檢查空間規則。', '請匯出 PDF。');
  if(ENABLE_TEXT_HEAVY_RULES){ runTextRules([text]); }
  buildAndShowSummaryJSON({fileName,pages:0});
}
function stripHtml(html){const t=document.createElement('div');t.innerHTML=html;return t.textContent||t.innerText||''}

/* ===== 文字規則（簡化自你原版：引註 / 文獻 / 圖表 / 一致性） ===== */
function runTextRules(pageTexts){
  const pages = pageTexts.length - 1 || 1; const fullText = pageTexts.slice(1).join('\n\n[[PAGE_SPLIT]]\n\n');

  // 六段落（簡）
  const sec=RULES.sixSections; const idx=sec.map(s=>fullText.indexOf(s)); const hasAll=idx.every(i=>i>=0); const inOrder=hasAll && idx.join(',')===idx.slice().sort((a,b)=>a-b).join(',');
  addRow('六大段落依序',hasAll&&inOrder,hasAll?(inOrder?'順序正確':'找到各段落但順序錯誤'):'有段落缺失','請補齊並按規定順序排列：'+sec.join(' → '));

  // 作者-年份（簡）
  const citeRE=/（[^，\n()]{1,40}(?:等)?，\s*(\d{4}|無日期|n\.?d\.?)）|\(\s*[A-Z][A-Za-z.'\-\s]{0,40}(?:et al\.)?\s*,\s*(\d{4}|n\.?d\.)\s*\)/g;
  const hasCite=(fullText.match(citeRE)||[]).length; addRow('內文引註採 作者-年份',hasCite>0,hasCite?`檢出 ${hasCite} 處`:'未檢出引註樣式','請使用（姓名，年份）或 姓名（年份）等。');

  // 直接引文長度
  const quotesRaw=[...(fullText.match(/「[^」]{1,200}」/g)||[]),...(fullText.match(/“[^”]{1,200}”/g)||[])];
  const clean=s=>s.replace(PUNCT,''); const isDirect=q=>clean(q).length>=RULES.minQuoteCharsForDirect; const directQuotes=quotesRaw.filter(q=>isDirect(q)), over=directQuotes.filter(q=>clean(q).length>RULES.quoteMaxChars);
  addRow(`直接引文 ≤ ${RULES.quoteMaxChars} 字（不含標點與空白）`,over.length===0,over.length?`超標處：${over.length} 例`:(directQuotes.length?`OK（偵測 ${directQuotes.length} 例）`:'OK（未偵測引號片段）'),'引號內淨字數≥10才視為直接引文。');

  // 參考文獻（極簡：僅統計）
  const refIdx = (()=>{ const t=fullText; const cands=['參考文獻','參考資料','References']; const pos=cands.map(x=>t.lastIndexOf(x)).filter(x=>x>=0); return pos.length?Math.max(...pos):-1; })();
  const refText = refIdx>=0 ? fullText.slice(refIdx) : '';
  const entries = refText.split(/\n{1,}/).map(s=>s.trim()).filter(s=>s && s.replace(/\s/g,'').length>=6).slice(0,999);
  const total = entries.length; addRow('參考文獻 ≥ 3', total>=3, `總筆數：${total}`,'請至少三筆；建議含非網路來源。');

  // 來源不可全為網路（粗略）
  const webCount = entries.filter(s=>/(https?:\/\/|doi\.org|取自)/i.test(s)).length; const nonAllWebPass = (total>0) && (webCount < total);
  addRow('參考文獻來源不可全為網路', nonAllWebPass, `純網路 ${webCount}｜總數 ${total}`, '至少保留 1 筆非網路來源（書籍/期刊/學位論文/報紙/法規等）。');

  // 圖表（極簡）：標號 + 來源字樣
  const FIGTAB_LABEL = new RegExp('(^|\\n|[\\s\\u3000])' + '(圖|表)' + '[\\s\\u3000]*' + '(\\d+|[一二三四五六七八九十百千]+)' + '[\\s\\u3000]*[：:、．\\.]','g');
  const SOURCE_LABEL = /(資料來源[:：]|圖片來源[:：]|出處[:：]|來源[:：])/;
  let m, count=0, withSrc=0; while((m=FIGTAB_LABEL.exec(fullText))!==null){ count++; const tail = fullText.slice(m.index, m.index+500); if(SOURCE_LABEL.test(tail)) withSrc++; }
  addRow('圖表需有標號/標題與來源', (count===0)|| (withSrc===count), `檢出圖/表：${count}｜含來源：${withSrc}`, '圖/表下方請標「資料來源：…」。若表內已引注可視為來源。');

  // 一致性（粗略計數）
  addRow('參考文獻與內文引註一致性', true, '（混合模式建議交由 GPT#2 嚴格檢核）', '內文出現之引用需在參考文獻出現；未引用者不得列入參考文獻。');
}

/* ===== 報表與工具 ===== */
const _rowsBuffer=[]; let _ruleCounter=0;
function addRow(rule,pass,evidence,suggestion){
  const tr=document.createElement('tr'); const badge=pass?'<span class="ok">通過</span>':'<span class="bad">未通過</span>';
  tr.innerHTML=`<td><span class="num">${++_ruleCounter}</span>${rule}</td><td>${badge}</td><td>${typeof evidence==='string'?evidence: (evidence==null?'': `<pre class="mono">${JSON.stringify(evidence,null,2)}</pre>`)}</td><td>${suggestion||''}</td>`;
  tbody.appendChild(tr);
  const map={
    '頁數 4–10':'file.pages','首頁篇名需置中且落在距上緣 2 公分內':'header.topmargin_firstpage','首頁頁碼需置中且落在距下緣 2 公分內':'footer.bottommargin_firstpage','檔案名稱與頁首篇名一致（不符判定淘汰）':'filename.title_consistency','每頁需有置中頁碼（底端帶）':'footer.pagenum','四周邊界 ≥ 2 公分（正文區推估）':'layout.margins','不得有封面頁（4–10頁）':'file.coverpage','不得含校名/姓名':'privacy.no_school_or_name','六大段落依序':'structure.sections_order','內文引註採 作者-年份':'references.citation_style',[`直接引文 ≤ ${RULES.quoteMaxChars} 字（不含標點與空白）`]:'quotes.limit','圖表需有標號/標題與來源':'figures.tables','參考文獻 ≥ 3':'references.count','參考文獻與內文引註一致性':'references.consistency','參考文獻來源不可全為網路':'references.non_all_web','字體/字型規範（需人工確認）':'style.font','作品是否已於校外發表/得獎（需人工/GPT）':'external.duplicate_check','頁數 4–10（DOCX）':'file.pages.docx','Cloud Run 字體字型檢查':'fontcheck.cloudrun'
  };
  const sev = (['file.pages','header.topmargin_firstpage','footer.bottommargin_firstpage','filename.title_consistency','footer.pagenum','file.coverpage','privacy.no_school_or_name','structure.sections_order','references.count','references.consistency','references.non_all_web'].includes(map[rule]))?'critical': (['layout.margins','references.citation_style','quotes.limit','figures.tables','fontcheck.cloudrun'].includes(map[rule])?'major':'minor');
  _rowsBuffer.push({ rule_id: map[rule]||'misc', category:'—', severity: sev, pass, evidence: typeof evidence==='string'?{note:evidence}:(evidence||null), suggestion: suggestion||null });
}

function buildAndShowSummaryJSON(){
  const weight=x=>x.severity==='critical'?2:(x.severity==='major'?1:0.5);
  const max=_rowsBuffer.reduce((a,x)=>a+weight(x),0)||1; const score=Math.round(_rowsBuffer.reduce((a,x)=>a+(x.pass?weight(x):0),0)/max*100);
  const hasCriticalFail=_rowsBuffer.some(x=>!x.pass && x.severity==='critical'); const status=hasCriticalFail?'revise':'pass';
  const summary={meta:{report_id:(crypto.randomUUID?.()||String(Math.random()).slice(2)),generated_at:new Date().toISOString(),file:{name:fileName,pages:_lastPageCount,type:fileExt},rules_version:'v1.4'}, summary:{score,totals:{checks:_rowsBuffer.length,pass:_rowsBuffer.filter(x=>x.pass).length,fail:_rowsBuffer.filter(x=>!x.pass).length},status}, checks:_rowsBuffer.map(x=>({rule_id:x.rule_id,category:x.category,severity:x.severity,pass:x.pass,evidence:x.evidence||null,suggestion:x.suggestion||null}))};
  lastSummaryJSON=summary; jsonPreview.textContent=JSON.stringify(summary,null,2);
}

function missingRange(okPages,total){const ok=new Set(okPages);const miss=[];for(let i=1;i<=total;i++){if(!ok.has(i))miss.push(i)}return miss.length?miss.join(', '):'—'}

/* ===== 下載/複製 ===== */
downloadHtmlBtn.addEventListener('click',()=>{ const html='<!doctype html><meta charset="utf-8"><title>小論文檢查報告</title>'+document.querySelector('#resultCard').outerHTML; const blob=new Blob([html],{type:'text/html;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paper-check-report.html'; a.click(); URL.revokeObjectURL(a.href); });
copyBtn.addEventListener('click',async()=>{ if(!lastSummaryJSON){alert('尚未產生檢查摘要。');return;} await navigator.clipboard.writeText(JSON.stringify(lastSummaryJSON,null,2)); alert('已複製檢查摘要 JSON'); });
downloadJsonBtn.addEventListener('click',()=>{ if(!lastSummaryJSON){alert('尚未產生檢查摘要。');return;} const blob=new Blob([JSON.stringify(lastSummaryJSON,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download((lastSummaryJSON.meta?.file?.name||'paper')+'.summary.json'); a.click(); URL.revokeObjectURL(a.href); });

/* ===== 註：人次計數程式碼暫註解 ===== */
// 若需恢復計數，請：1) 將 ENABLE_COUNTER=true；2) 填入 GAS_WEB_APP_URL；3) 啟用下列函式並在 DOMContentLoaded 後呼叫
/*
async function fetchCounter(){ try{ const url = GAS_WEB_APP_URL + '?action=get&site=essayguard&ts=' + Date.now(); const res = await fetch(url,{cache:'no-store'}); const data = await res.json().catch(()=>({})); counterEl.textContent = data.count ?? '0'; }catch(e){ counterEl.textContent='0'; }}
*/
</script>
</body>
</html>