<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>高中職小論文格式自檢系統</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
:root{
  --bg:#f7f7fb; --card:#fff; --ink:#111827; --muted:#6b7280; --accent:#2563eb; --ok:#059669; --bad:#b91c1c; --bdr:#e5e7eb;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
.wrap{max-width:980px;margin:auto;padding:24px}
header h1{margin:0 0 6px;font-size:clamp(22px,4vw,28px)}
header .meta{margin:0 0 12px;color:var(--muted);font-size:13px}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.hint{color:var(--muted);font-size:13px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
button{padding:.7rem 1.05rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:transparent}
button:disabled{opacity:.5;cursor:not-allowed}
a.btn-gpt{background:#f3e8ff;border:1px solid #e9d5ff;border-radius:10px;color:#3b0764;padding:.7rem 1.05rem;text-decoration:none;font-weight:600}
button.danger{background:#dc2626;color:#fff;border-color:#b91c1c}
a.btn-violet{background:#f3e8ff;border:1.5px solid #c4b5fd;color:#4c1d95;border-radius:10px;padding:.7rem 1.05rem;text-decoration:none;font-weight:700}
a.btn-violet:hover{background:#ede9fe;border-color:#a78bfa}
.step{display:grid;grid-template-columns:34px 1fr;gap:10px;align-items:start}
.step .no{display:flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-weight:700}
.drop{border:2px dashed #cbd5e1;border-radius:12px;padding:22px;text-align:center;background:#fafafa;margin-top:8px}
.drop[aria-disabled="true"]{opacity:.7;filter:grayscale(.1)}
input[type=file]{display:none}
label.file{display:inline-flex;gap:.6rem;padding:.65rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid var(--bdr);padding:8px 10px;text-align:left;vertical-align:top}
th{background:#f9fafb}
.badge-ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.15rem .5rem;border-radius:999px;font-size:12px}
.badge-bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.15rem .5rem;border-radius:999px;font-size:12px}
.num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:6px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px;color:#374151;font-weight:600}
footer{margin-top:24px;text-align:center;color:#6b7280;font-size:13px}
.margin-preview{margin-top:8px}
.margin-preview .legend{display:flex;gap:10px;align-items:center;font-size:12px;color:#374151;margin:6px 0}
.margin-preview .dot{display:inline-block;width:10px;height:10px;border-radius:2px;border:2px solid #111}
.margin-preview .dot.red{border-color:#be123c;border-style:dashed}
.margin-preview .dot.blue{border-color:#1d4ed8;border-style:dashed}
.extsearch{margin-top:14px;border-top:1px dashed #e5e7eb;padding-top:12px}
.extsearch .row{gap:8px}
.extsearch a[data-extlink]{text-decoration:none}
</style>

<!-- pdf.js（ESM）僅作備援讀字 -->
<script type="module">
  window.loadPdfjs = async () => {
    const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
    const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
    GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
    return { getDocument };
  };
</script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>高中職小論文格式自檢系統</h1>
    <p class="meta">
      目前累積自檢人次：<b id="counter">載入中…</b>
      <span class="mono">｜v=2025-11-03b</span>
      ｜© 2025 CTVS 凡事皆正面
    </p>
  </header>

  <!-- Step 1 -->
  <section class="card">
    <div class="step">
      <div class="no">1</div>
      <div>
        <h3 style="margin:4px 0 8px">同意與上傳</h3>
        <details>
          <summary><strong>上傳與資料保存政策（必讀）</strong></summary>
          <ul>
            <li>僅做格式檢查，不做存證或投稿。</li>
            <li>解析於瀏覽器記憶體，完成後即釋放；本站不保存。</li>
            <li>請勿含個資（校名、姓名、班級）。</li>
          </ul>
        </details>
        <div class="row" style="margin-top:8px">
          <input id="consent" type="checkbox"/>
          <label for="consent">我已閱讀並同意，且確認檔案不含 <span class="mono">校名/姓名</span>。</label>
        </div>
        <div id="drop" class="drop" aria-disabled="true">
          <p><strong>拖拉 PDF 到這裡</strong></p>
          <label for="file" class="file">選擇檔案</label>
          <input id="file" type="file" accept=".pdf" disabled/>
          <p class="hint" id="status">請先勾選同意。</p>
        </div>
        <p class="hint" style="color:#444;font-size:14px;margin-top:6px;line-height:1.6;">
          💡 建議流程：優先用 <b>Cloud Run 逐頁邊界</b>，失敗時才啟用<b>前端備援</b>；再用 <b>字體進階</b> 與 <b>GPT B 全面分析</b> 交叉驗證。
        </p>
      </div>
    </div>
  </section>

  <!-- Step 2 -->
  <section class="card">
    <div class="step">
      <div class="no">2</div>
      <div>
        <h3 style="margin:4px 0 8px">執行檢查</h3>
        <div class="row">
          <button id="start" class="primary" disabled>開始檢查（邊界：Server 優先）</button>
          <button id="fontCheckBtn" disabled>字體字型進階檢查（Cloud Run）</button>
          <a id="gptB" class="btn-gpt" target="_blank" rel="noopener"
             href="https://chat.openai.com/">單獨 GPT 檢查 PDF（GPT B）</a>
          <a id="gptA" class="btn-violet" target="_blank" rel="noopener"
             href="https://chat.openai.com/">AI 小助手（GPT A）</a>
          <button id="clearTop" class="danger">清除</button>
        </div>
        <p class="hint">🔎 含「小論文評分表」之頁將被<strong>完整略過</strong>：不納入全文、頁數、頁碼與邊界等任何檢查。</p>
      </div>
    </div>
  </section>

  <!-- Step 3 -->
  <section class="card" id="resultCard" style="display:none">
    <div class="step">
      <div class="no">3</div>
      <div>
        <h3 style="margin:4px 0 8px">檢查結果</h3>
        <div id="fileTag" class="hint" style="margin:6px 0 12px"></div>
        <table>
          <thead><tr><th>規則</th><th>結果</th><th>證據 / 說明</th><th>建議</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>

        <!-- 外部檢索助手 + 給 AI 的摘要 -->
        <div id="extSearchPanel" class="extsearch" style="display:none">
          <h4 style="margin:10px 0 6px">#4 外部檢索助手（給 AI 小助手）</h4>
          <div class="row">
            <button id="btnOpenAllSearch">一鍵開啟所有搜尋</button>
            <button id="btnCopyGptPrompt" class="btn-violet">複製查核提示（給 AI 小助手）</button>
          </div>
          <ol id="searchLinks" style="margin:10px 0 6px;padding-left:20px"></ol>
          <details style="margin-top:6px">
            <summary>顯示本次檢查摘要 JSON（會一併複製給 GPT）</summary>
            <pre id="jsonPreview" class="mono" style="white-space:pre-wrap;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:10px;max-height:280px;overflow:auto"></pre>
          </details>
          <details open style="margin-top:10px;border-top:1px dashed #ddd;padding-top:8px">
            <summary><b>AI 小助手結果摘要（解釋版）</b></summary>
            <div id="aiSummaryReadable" style="white-space:pre-wrap;font-size:13px;line-height:1.6;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px;"></div>
          </details>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="downloadHtml">下載檢查結果（網頁）</button>
          <button id="clearAll" class="danger">清除（回到初始畫面）</button>
        </div>
      </div>
    </div>
  </section>

  <footer>© 2025 CTVS 凡事皆正面 · v=2025-11-03b</footer>
</div>

<script>
/* ========== 依你的實際部署修改這兩個 URL（很重要！） ========== */
const MARGIN_API = "https://margin-check-service-1009467346209.asia-east1.run.app/check";
const FONT_API   = "https://font-check-api-1009467346209.asia-east1.run.app/check";

/* （若要顯示人次，填入你的 GAS 網址；不需要就維持空白） */
const GAS_WEB_APP_URL = "";
const ENABLE_COUNTER = false;

/* ====== 小工具 ====== */
async function fetchWithTimeout(url, options = {}, timeoutMs = 20000){
  const c = new AbortController(); const id = setTimeout(()=>c.abort(), timeoutMs);
  try{ return await fetch(url,{...options,signal:c.signal}); } finally{ clearTimeout(id); }
}
const CM_TO_PT = cm => cm * 72 / 2.54;
const PT_TO_CM = pt => pt * 2.54 / 72;
const fmtCM = v => (isFinite(v) ? PT_TO_CM(v).toFixed(3) : '—');
const BASE_CM=2.0, TOL_CM=0.2, MICRO_TOL_PT=0.8;
const RANGE_MIN_PT=CM_TO_PT(BASE_CM - TOL_CM), RANGE_MAX_PT=CM_TO_PT(BASE_CM + TOL_CM);
const within = v => isFinite(v) && v >= (RANGE_MIN_PT - MICRO_TOL_PT) && v <= (RANGE_MAX_PT + MICRO_TOL_PT);

/* ====== DOM ====== */
const consent  = document.getElementById('consent');
const fileInput= document.getElementById('file');
const drop     = document.getElementById('drop');
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('start');
const fontBtn  = document.getElementById('fontCheckBtn');
const resultCard = document.getElementById('resultCard');
const tbody    = document.getElementById('tbody');
const fileTag  = document.getElementById('fileTag');
const downloadHtmlBtn = document.getElementById('downloadHtml');
const gptALink = document.getElementById('gptA');
const gptBLink = document.getElementById('gptB');
const extPanel = document.getElementById('extSearchPanel');
const searchLinksEl = document.getElementById('searchLinks');
const jsonPreviewEl = document.getElementById('jsonPreview');

let arrayBuffer=null, fileName='', lastSummaryJSON=null;

/* ====== 啟用/停用 ====== */
function setEnabled(ok){
  fileInput.disabled = !ok;
  startBtn.disabled  = !ok || !arrayBuffer;
  fontBtn.disabled   = !ok || !arrayBuffer;
  drop.setAttribute('aria-disabled', ok ? 'false' : 'true');
  statusEl.textContent = ok
    ? (arrayBuffer ? '已選擇檔案，準備開始。' : '已同意，可選檔。')
    : '請先勾選同意。';
}
window.addEventListener('DOMContentLoaded', ()=>{
  setEnabled(false);
  consent.addEventListener('change', ()=>{
    setEnabled(consent.checked);
    if(consent.checked && arrayBuffer){
      startBtn.disabled = false;
      fontBtn.disabled  = false;
    }
  });
});
document.querySelector('label.file')?.addEventListener('click',(e)=>{
  e.preventDefault();
  if(!fileInput.disabled) fileInput.click();
});

/* ====== DnD / 選檔 ====== */
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();if(!fileInput.disabled)drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');}));
drop.addEventListener('drop',e=>{if(fileInput.disabled)return;const f=e.dataTransfer.files?.[0];if(f)handleFile(f);});
fileInput.addEventListener('change',e=>{const f=e.target.files?.[0];if(f)handleFile(f);});

async function handleFile(f){
  if((f.name.split('.').pop()||'').toLowerCase()!=='pdf'){statusEl.textContent='僅支援 PDF';return;}
  if(f.size>5*1024*1024){statusEl.textContent='超過 5MB 上限';return;}
  arrayBuffer = await f.arrayBuffer();
  fileName = f.name;
  setEnabled(consent.checked);

  // 初始化外部檢索連結
  const baseTitle=(fileName||'小論文篇名').replace(/\.[^.]+$/,'');
  buildExternalSearchEvidence(baseTitle);
  extPanel.style.display='block';
}

/* ====== 視覺尺規縮圖（以 API 第 1 頁值疊圖） ====== */
function marginPreviewSVG({W,H,left,right,top,bottom}){
  const thumbW=240, scale=thumbW/W, th=Math.round(H*scale);
  const insetBlack=CM_TO_PT(2.0)*scale, insetRed=CM_TO_PT(2.2)*scale, insetBlue=CM_TO_PT(1.8)*scale;
  const mL=Math.max(0,(left??0)*scale), mR=Math.max(0,(right??0)*scale), mT=Math.max(0,(top??0)*scale), mB=Math.max(0,(bottom??0)*scale);
  return `
<div class="margin-preview">
<svg width="${thumbW}" height="${th}" viewBox="0 0 ${thumbW} ${th}" xmlns="http://www.w3.org/2000/svg" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px">
  <rect x="0.5" y="0.5" width="${thumbW-1}" height="${th-1}" fill="white" stroke="#9ca3af"/>
  <rect x="${insetBlack}" y="${insetBlack}" width="${thumbW-2*insetBlack}" height="${th-2*insetBlack}" fill="none" stroke="#111" stroke-width="2"/>
  <rect x="${insetRed}" y="${insetRed}" width="${thumbW-2*insetRed}" height="${th-2*insetRed}" fill="none" stroke="#be123c" stroke-width="2" stroke-dasharray="6 4"/>
  <rect x="${insetBlue}" y="${insetBlue}" width="${thumbW-2*insetBlue}" height="${th-2*insetBlue}" fill="none" stroke="#1d4ed8" stroke-width="2" stroke-dasharray="6 4"/>
  ${Number.isFinite(mL)?`<line x1="${mL}" y1="0" x2="${mL}" y2="${th}" stroke="#16a34a" stroke-width="2"/>`:''}
  ${Number.isFinite(mR)?`<line x1="${thumbW-mR}" y1="0" x2="${thumbW-mR}" y2="${th}" stroke="#16a34a" stroke-width="2"/>`:''}
  ${Number.isFinite(mT)?`<line x1="0" y1="${mT}" x2="${thumbW}" y2="${mT}" stroke="#16a34a" stroke-width="2"/>`:''}
  ${Number.isFinite(mB)?`<line x1="0" y1="${th-mB}" x2="${thumbW}" y2="${th-mB}" stroke="#16a34a" stroke-width="2"/>`:''}
</svg>
<div class="legend">
  <span class="dot"></span><span>黑：2.0 cm</span>
  <span class="dot red"></span><span>紅：2.2 cm（上限）</span>
  <span class="dot blue"></span><span>藍：1.8 cm（下限）</span>
</div>
</div>`;
}

/* ====== 表格輸出 ====== */
let _ruleCounter=0;
function addRow(rule, pass, evidenceHtml, suggestionHtml){
  const tr=document.createElement('tr');
  const badge = pass ? '<span class="badge-ok">通過</span>' : '<span class="badge-bad">未通過</span>';
  tr.innerHTML = `<td><span class="num">${++_ruleCounter}</span>${rule}</td>
                  <td>${badge}</td>
                  <td>${evidenceHtml||''}</td>
                  <td>${suggestionHtml||''}</td>`;
  tbody.appendChild(tr);
}

/* ====== 邊界檢查（Server-first） ====== */
startBtn.addEventListener('click', async ()=>{
  if(!arrayBuffer) return;
  tbody.innerHTML=''; _ruleCounter=0; resultCard.style.display='none'; extPanel.style.display='none';
  statusEl.textContent='上傳至 Cloud Run 進行逐頁邊界檢查…';

  let serverOK=false; let summaryForAI={};

  try{
    const fd = new FormData();
    fd.append('file', new Blob([arrayBuffer], {type:"application/pdf"}), fileName || 'upload.pdf');

    const res = await fetchWithTimeout(MARGIN_API + "?v=" + Date.now(), {
      method:'POST', mode:'cors', cache:'no-store', body:fd
    }, 20000);

    const text = await res.text();
    if(!res.ok) throw new Error(`API ${res.status} ${res.statusText} ${text}`);
    const data = (()=>{ try{return JSON.parse(text);}catch{return { ok:true, raw:text }; } })();

    const per = data?.layout?.per_page_margins || [];
    const pages = Number(data?.summary?.pages || per.length || 0);
    const skip = new Set(Array.isArray(data?.skip_pages)?data.skip_pages:[]);
    const effPages = [...Array(pages).keys()].map(i=>i+1).filter(p=>!skip.has(p));

    if(per.length>0 && pages>0){
      serverOK=true;

      const badPages=[]; const globalMin = {left:Infinity,right:Infinity,top:Infinity,bottom:Infinity};
      per.forEach((pg,i)=>{
        const pno=i+1; if(skip.has(pno)) return;
        const {left:L,right:R,top:T,bottom:B,page_size:S}=pg;
        if(isFinite(L)&&L<globalMin.left)globalMin.left=L;
        if(isFinite(R)&&R<globalMin.right)globalMin.right=R;
        if(isFinite(T)&&T<globalMin.top)globalMin.top=T;
        if(isFinite(B)&&B<globalMin.bottom)globalMin.bottom=B;
        const fail=(isFinite(L)&&!within(L))||(isFinite(R)&&!within(R))||(isFinite(T)&&!within(T))||(isFinite(B)&&!within(B));
        if(fail)badPages.push(pno);
      });

      let svg=''; if(per[0]?.page_size?.width&&per[0]?.page_size?.height){
        svg=marginPreviewSVG({W:per[0].page_size.width,H:per[0].page_size.height,left:per[0].left,right:per[0].right,top:per[0].top,bottom:per[0].bottom});
      }

      const passAll = badPages.length===0;
      const ev1 = `逐頁最小值（cm）：左 ${fmtCM(globalMin.left)}、右 ${fmtCM(globalMin.right)}、上 ${fmtCM(globalMin.top)}、下 ${fmtCM(globalMin.bottom)}`
        + (badPages.length?`<br/>不合格頁次：<span class="mono">${badPages.join(', ')}</span>`:'<br/>全數頁面於 2.0±0.2 cm（含 ±0.8pt 微誤差）內。');
      addRow('四周邊界 2 公分（逐頁嚴格 · Cloud Run）', passAll, ev1, '以伺服器幾何量測為準；若有不合格頁請回 Word 版面調整。');

      const ev2 = `第 1 頁量測（cm）：左 ${fmtCM(per[0]?.left)}｜右 ${fmtCM(per[0]?.right)}｜上 ${fmtCM(per[0]?.top)}｜下 ${fmtCM(per[0]?.bottom)}`;
      addRow('第 1 頁視覺尺規（參考圖）', true, `<div>${ev2}</div>${svg||''}`, '黑=2.0cm、紅=2.2cm、藍=1.8cm。');

      // 給 AI 的摘要 JSON（邊界部份）
      summaryForAI = {
        file: { name: fileName||'(未命名)', pages_total: pages, pages_effective: effPages.length, skipped_pages: [...skip] },
        margins: {
          base_cm: 2.0, tol_cm: 0.2, micro_tol_pt: 0.8,
          global_min_pt: {
            left: isFinite(globalMin.left)?Number(globalMin.left.toFixed(2)):null,
            right: isFinite(globalMin.right)?Number(globalMin.right.toFixed(2)):null,
            top: isFinite(globalMin.top)?Number(globalMin.top.toFixed(2)):null,
            bottom: isFinite(globalMin.bottom)?Number(globalMin.bottom.toFixed(2)):null
          },
          bad_pages: badPages
        }
      };
      lastSummaryJSON = summaryForAI;
      jsonPreviewEl.textContent = JSON.stringify(summaryForAI, null, 2);

      // 外部檢索連結
      buildExternalSearchEvidence((fileName||'小論文篇名').replace(/\.[^.]+$/,''));
      extPanel.style.display='block';

      const skipped = skip.size ? `（略過頁：${[...skip].join(', ')}）` : '';
      resultCard.style.display='block';
      fileTag.textContent = `此次檢查檔案：${fileName||'(未命名)'}；總頁數：${pages}；有效頁數：${effPages.length}${skipped}`;
      statusEl.textContent = 'Cloud Run 檢查完成。';
      updateAiReadableSummary();
    }
  }catch(e){
    statusEl.textContent='Cloud Run 檢查失敗或逾時。';
    addRow('四周邊界 2 公分（伺服器）', false, (e?.message||String(e)).replace(/</g,'&lt;'), '請稍後重試。');
    resultCard.style.display='block';
  }
});

/* ====== 字體字型進階檢查（Cloud Run） ====== */
fontBtn.addEventListener('click', async ()=>{
  const blob = arrayBuffer ? new Blob([arrayBuffer], {type:"application/pdf"}) : null;
  if(!blob){ alert('請先選擇 PDF 檔'); return; }

  statusEl.textContent = '上傳至 Cloud Run 檢查中…';
  try{
    const fd = new FormData(); fd.append('file', blob, fileName||'upload.pdf');
    const res = await fetch(FONT_API + '?v=' + Date.now(), { method:'POST', mode:'cors', cache:'no-store', body:fd });
    const text = await res.text();
    if(!res.ok) throw new Error(`API ${res.status} ${res.statusText} ${text}`);
    const data = (()=>{ try{return JSON.parse(text);}catch{return { ok:true, raw:text }; } })();

    // 新版欄位 coverage_main（0~1），舊版 main_coverage_pct（%）
    let zh=0,en=0,combined=0, pass=false;
    if (data?.summary?.coverage_main){
      const c=data.summary.coverage_main;
      zh=(c.zh_main||0)*100; en=(c.en_main||0)*100; combined=(c.combined||0)*100;
      pass=!!data.summary.pass || (c.combined>=0.8);
    }else if (typeof data?.summary?.main_coverage_pct === 'number'){
      combined = data.summary.main_coverage_pct; pass = combined >= 80;
    }

    const pagesEff = data?.file?.pages_effective ?? data?.summary?.pages ?? null;
    const parts = [
      pagesEff?`有效頁數：${pagesEff}`:null,
      `主字體 coverage（12±1pt；新細明體＋Times New Roman）：${combined.toFixed(2)}%`,
      `‧ 新細明體（中文 12 級）：${zh.toFixed(2)}%`,
      `‧ Times New Roman（英文 12pt）：${en.toFixed(2)}%`
    ].filter(Boolean).join('｜');

    // top list（相容新舊）
    let topList='';
    if(Array.isArray(data?.top_fonts) && data.top_fonts.length){
      topList=data.top_fonts.slice(0,10).map(x=>`• ${x.name}：${(x.pct*100).toFixed(2)}%`).join('<br/>');
    }else if(Array.isArray(data?.distribution) && data.distribution.length){
      topList=data.distribution.slice(0,10).map(r=>`• ${r.family} ${r.size}pt：${(+r.percent||0).toFixed(2)}%`).join('<br/>');
    }

    addRow('Cloud Run 字體字型檢查（字體佔比）', pass,
      (parts + (topList?('<br/>'+topList):'')).replace(/</g,'&lt;'),
      pass ? '主要字體 coverage 達標（≥80%）' : '主要字體 coverage 未達 80%，請調整字體與字級。'
    );

    // 摘要 JSON（字體部份）
    lastSummaryJSON = lastSummaryJSON || {};
    lastSummaryJSON.fonts = {
      main_pass: pass,
      coverage_main: data?.summary?.coverage_main || { zh_main: zh/100, en_main: en/100, combined: combined/100 },
      top_fonts: (data?.top_fonts || [])
    };
    lastSummaryJSON.file = lastSummaryJSON.file || { name:fileName||'(未命名)' };
    jsonPreviewEl.textContent = JSON.stringify(lastSummaryJSON, null, 2);

    resultCard.style.display='block';
    fileTag.textContent = `此次檢查檔案：${fileName||'(未命名)'}`;
    statusEl.textContent = '字體佔比檢查完成。';
    updateAiReadableSummary();
  }catch(err){
    addRow('Cloud Run 字體字型檢查（字體佔比）', false,
      (err?.message||String(err)).replace(/</g,'&lt;'),
      '請確認後端允許匿名、已開 CORS，且前端確實送出檔案。');
    resultCard.style.display='block';
    statusEl.textContent = '字體佔比檢查失敗。';
  }
});

/* ====== AI 小助手可讀摘要 ====== */
function updateAiReadableSummary(){
  const box=document.getElementById('aiSummaryReadable');
  if(!box) return; if(!lastSummaryJSON){ box.textContent='尚無結果。'; return; }
  try{
    const j=lastSummaryJSON; let txt=`📄 小論文檢查摘要：${j?.file?.name||'(未命名)'}\n`;
    if(j.margins){
      const bads=j.margins.bad_pages||[];
      txt+=`\n【邊界檢查】\n　基準邊界：2.0±0.2 公分（容許 ±0.8pt）\n`;
      txt+=`　逐頁最小邊界（pt）：左 ${j.margins.global_min_pt?.left??'—'}、右 ${j.margins.global_min_pt?.right??'—'}、上 ${j.margins.global_min_pt?.top??'—'}、下 ${j.margins.global_min_pt?.bottom??'—'}。\n`;
      txt+=bads.length?`　❌ 不合格頁次：${bads.join(', ')}。\n`:`　✅ 所有頁面皆符合 2 公分 ±0.2 的要求。\n`;
    }
    if(j.fonts){
      const c=j.fonts.coverage_main||{};
      txt+=`\n【字體字型檢查】\n`;
      txt+=`　主字體覆蓋率：${((c.combined??0)*100).toFixed(2)}%（合格門檻：≥80%）\n`;
      txt+=`　新細明體（中文 12 級）：${((c.zh_main??0)*100).toFixed(2)}%｜Times New Roman（英文 12pt）：${((c.en_main??0)*100).toFixed(2)}%\n`;
      txt+=j.fonts.main_pass?`　✅ 主要字體覆蓋率達標。\n`:`　❌ 未通過。請在 Word 全選文字後，設定「中文：新細明體」「英文：Times New Roman」並重匯 PDF。\n`;
    }
    box.textContent=txt.trim();
  }catch(e){ box.textContent='生成摘要時發生錯誤：'+e.message; }
}

/* ====== 外部檢索助手 ====== */
function buildExternalSearchEvidence(baseTitle){
  const t=(baseTitle||'小論文篇名').trim(), mk=s=>encodeURIComponent(s);
  const items=[
    {label:'Google Scholar（繁中）',href:`https://scholar.google.com/scholar?hl=zh-TW&q=${mk(t)}`,q:`${t}`},
    {label:'Google：題名 + 小論文 得獎',href:`https://www.google.com/search?q=${mk(t+' 小論文 得獎')}`,q:`${t} 小論文 得獎`},
    {label:'Google：題名 + 專題製作 比賽 歷屆 作品',href:`https://www.google.com/search?q=${mk(t+' 專題製作 比賽 歷屆 作品')}`,q:`${t} 專題製作 比賽 歷屆 作品`},
    {label:'Google：題名 + site:shs.edu.tw',href:`https://www.google.com/search?q=${mk(t+' site:shs.edu.tw')}`,q:`${t} site:shs.edu.tw`},
    {label:'Google：題名 + site:edu.tw 小論文',href:`https://www.google.com/search?q=${mk(t+' site:edu.tw 小論文')}`,q:`${t} site:edu.tw 小論文`}
  ];
  searchLinksEl.innerHTML = items.map((it,i)=>`<li class="mono">#${i+1} <a data-extlink href="${it.href}" target="_blank" rel="noopener">${it.q}</a></li>`).join('');
  document.getElementById('btnOpenAllSearch')?.addEventListener('click',()=>{document.querySelectorAll('a[data-extlink]').forEach(a=>window.open(a.href,'_blank','noopener'));});
  document.getElementById('btnCopyGptPrompt')?.addEventListener('click',async()=>{
    const qsEls=document.querySelectorAll('a[data-extlink]'); const qs=[...qsEls].map((a,i)=>`(${i+1}) ${a.textContent} -> ${a.href}`).join('\n');
    const summary=(typeof lastSummaryJSON==='object'&&lastSummaryJSON)?JSON.stringify(lastSummaryJSON,null,2):(jsonPreviewEl?.textContent||'');
    const prompt=`請協助進行「校外發表／得獎」外部檢索確認：
題名/檔名：${t}

請到以下來源檢索並彙整前 10 筆結果（標題、來源、年份、連結），同時判斷是否疑似相同題名之公開發表或得獎紀錄：
1) Google Scholar（繁中）
2) Google 關鍵字：題名 +「小論文 得獎」、題名 +「專題製作 比賽 歷屆 作品」
3) Google 限站：site:shs.edu.tw、site:edu.tw 小論文

請用表格＋條列輸出；最後給「是否查到疑似相同題名」結論與理由，並附上實際使用的查詢字串清單。

（附：本次檢查摘要 JSON）
${summary||'(若空白可忽略)'}

（查詢字串與連結預覽）
${qs}`;
    try{await navigator.clipboard.writeText(prompt);alert('已複製查核提示，請點「AI 小助手（GPT A）」並貼上。');}catch{alert('無法存取剪貼簿，請手動複製。');}
  });
}

/* ====== 下載結果（簡版） ====== */
downloadHtmlBtn.addEventListener('click', ()=>{
  const html='<!doctype html><meta charset="utf-8"><title>小論文檢查報告</title>'
    + '<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif;margin:24px;}table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}th{background:#f9fafb}.badge-ok{color:#065f46}.badge-bad{color:#991b1b}.hint{color:#6b7280;font-size:13px}</style>'
    + document.querySelector('#resultCard').outerHTML;
  const blob=new Blob([html],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paper-check-report.html'; a.click();
  URL.revokeObjectURL(a.href);
});

/* ====== 清除回初始 ====== */
function resetToInitial(){
  arrayBuffer=null; fileName=''; lastSummaryJSON=null; tbody.innerHTML=''; _ruleCounter=0;
  resultCard.style.display='none'; extPanel.style.display='none'; searchLinksEl.innerHTML=''; jsonPreviewEl.textContent='';
  if(fileInput) fileInput.value=''; statusEl.textContent=consent.checked?'已同意，可選檔。':'請先勾選同意。'; setEnabled(consent.checked);
  window.scrollTo({top:0,behavior:'smooth'});
}
document.getElementById('clearAll')?.addEventListener('click', resetToInitial);
document.getElementById('clearTop')?.addEventListener('click', resetToInitial);

/* ====== 人次（可關） ====== */
async function fetchCounter(){ if(!ENABLE_COUNTER) return; try{ const u=GAS_WEB_APP_URL+'?action=get&site=essayguard&ts='+Date.now(); const r=await fetch(u,{cache:'no-store'}); const d=await r.json().catch(()=>({})); const el=document.getElementById('counter'); if(el) el.textContent=d.count??'0'; }catch{ const el=document.getElementById('counter'); if(el) el.textContent='0'; } }
async function bumpCounterEveryTime(){ if(!ENABLE_COUNTER) return; try{ const u=GAS_WEB_APP_URL+(GAS_WEB_APP_URL.includes('?')?'&':'?')+'action=increment&ts='+Date.now(); await fetch(u,{method:'GET',cache:'no-store'});}catch{} }
window.addEventListener('DOMContentLoaded', ()=> setTimeout(fetchCounter,400));
</script>
</body>
</html>
