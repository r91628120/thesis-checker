<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>é«˜ä¸­è·å°è«–æ–‡æ ¼å¼è‡ªæª¢ç³»çµ±</title>

<!-- ===== ç™¼ç‰ˆå­—ä¸²ï¼ˆæ”¹é€™è¡Œå°±èƒ½å¼·åˆ¶æ›æ–°ï¼‰ ===== -->
<script>
  const APP_VER = '2025-10-21c';
  (function () {
    try {
      const url = new URL(location.href);
      if (url.searchParams.get('v') !== APP_VER) {
        url.searchParams.set('v', APP_VER);
        location.replace(url.toString());
      }
    } catch (e) {}
  })();
  console.log("è¼‰å…¥ç‰ˆæœ¬:", (new URL(location.href)).searchParams.get('v') || APP_VER);
</script>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
:root{--bg:#f7f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--border:#e5e7eb}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC",sans-serif}
.wrap{max-width:960px;margin:auto;padding:24px}
header h1{margin:0 0 4px;font-size:clamp(22px,4vw,28px)}header p{margin:0;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:14px}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}.pill{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:.3rem .6rem;font-size:12px}
.hint{color:var(--muted);font-size:13px}.drop{border:2px dashed #cbd5e1;border-radius:12px;padding:24px;text-align:center;background:#fafafa;margin-top:8px}
input[type=file]{display:none}label.file{display:inline-flex;gap:.6rem;padding:.7rem 1rem;border:1.5px dashed #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
button{padding:.7rem 1.1rem;border-radius:10px;border:1px solid #d1d5db;background:#fff;cursor:pointer}button.primary{background:var(--accent);color:#fff;border-color:transparent}button:disabled{opacity:.5;cursor:not-allowed}
.ok{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:.1rem .5rem;border-radius:999px;font-size:12px}
.bad{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.1rem .5rem;border-radius:999px;font-size:12px}
table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top}th{background:#f9fafb}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}pre{white-space:pre-wrap;max-height:260px;overflow:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px}
.filetag{font-size:13px;color:#374151;margin:6px 0 0}.num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:6px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px;color:#374151;font-weight:600}
.extsearch{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;margin-top:6px}.extsearch ul{margin:6px 0 0 18px;padding:0}.extsearch li{margin:4px 0}

/* å–®ç¨ GPT æª¢æŸ¥æŒ‰éˆ•ï¼ˆæ·¡ç²‰ç´…ï¼‰ */
.btn-gpt{
  background:#f8c8dc;       /* æ·¡ç²‰ç´… */
  color:#333;
  border:1px solid #f5a6c4;
  border-radius:10px;
  padding:.7rem 1.1rem;
  font-weight:600;
  cursor:pointer;
  transition:background .15s;
}
.btn-gpt:hover{ background:#f5a6c4; }
.btn-gpt:disabled{ opacity:.5; cursor:not-allowed; }

/* å³å´çš„å°ä¸‰è§’è§£èªª */
.gpt-inline-desc{ display:inline-block; margin-left:8px; font-size:13px; }
.gpt-inline-desc summary{ cursor:pointer; color:#c2185b; font-weight:600; }
.gpt-inline-desc ul{ margin:6px 0 0 20px; color:#555; }
</style>

<!-- pdf.js (ESM) -->
<script type="module">
  window.loadPdfjs = async () => {
    const base = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/";
    const { GlobalWorkerOptions, getDocument } = await import(base + "pdf.min.mjs");
    GlobalWorkerOptions.workerSrc = base + "pdf.worker.min.mjs";
    return { getDocument };
  };
</script>
<!-- mammoth.js -->
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>é«˜ä¸­è·å°è«–æ–‡æ ¼å¼è‡ªæª¢ç³»çµ±</h1>
    <p>æ”¯æ´ PDF / DOCXï¼›è§£æåƒ…åœ¨ç€è¦½å™¨è¨˜æ†¶é«”ä¸­ï¼Œå®Œæˆå³é‡‹æ”¾ï¼Œä¸ç•™å­˜ã€‚</p>
    <div class="hint" id="counterBox">ç›®å‰ç´¯ç©å°è«–æ–‡æ ¼å¼è‡ªæª¢äººæ¬¡ï¼š<b id="counter">è¼‰å…¥ä¸­â€¦</b>ã€€<span class="mono">v=<script>document.write(new URL(location.href).searchParams.get('v')||APP_VER)</script></span></div>
    <div class="hint" style="margin-top:8px">Â© 2025 CTVS å‡¡äº‹çš†æ­£é¢ Â· r91628120@ctvs.ptc.edu.tw</div>
    <!-- ğŸ“˜ ç³»çµ±ä»‹ç´¹å°è¦½å€ -->
<div style="background:#e8f1fd;border-radius:10px;padding:16px;margin-top:16px;text-align:center;">
  <p style="margin:0;font-size:15px;color:#1e3a8a;">
    æƒ³äº†è§£ç³»çµ±åˆ¤å®šæ–¹å¼èˆ‡ AI å°åŠ©æ‰‹ä½¿ç”¨æ•™å­¸å—ï¼Ÿ<br/>
    <a href="about.html" style="color:#2563eb;font-weight:600;text-decoration:none;">
      ğŸ“˜ é»æˆ‘å‰å¾€ã€Œç³»çµ±ä»‹ç´¹èˆ‡ AI èªªæ˜ã€
    </a>
    <a href="manual.pdf" style="display:inline-block;margin-top:6px;color:#1e40af;text-decoration:none;">ğŸ“„ ä¸‹è¼‰æ“ä½œèˆ‡åˆ¤å®šèªªæ˜æ›¸ï¼ˆPDFï¼‰</a>
    <a href="gpt-safety.html" style="display:inline-block;margin-top:6px;color:#c2185b;text-decoration:none;font-weight:600;">ğŸ”’ AIå°åŠ©æ‰‹ GPT å–®ç¨æª¢æŸ¥PDFæ¨¡å¼å®‰å…¨èªªæ˜ç¶²é 
    </a>

  </p>
</div>


  </header>

  <section class="card">
    <div class="row"><div class="pill">PDF / DOCX</div><div class="pill">é æ•¸ 4â€“10</div><div class="pill">â‰¤ 5MB</div><div class="pill">ä¸å¾—å«æ ¡åï¼å§“å</div></div>
    <details style="margin-top:8px">
      <summary><strong>ä¸Šå‚³èˆ‡è³‡æ–™ä¿å­˜æ”¿ç­–ï¼ˆå¿…è®€ï¼‰</strong></summary>
      <ul>
        <li>åƒ…åšæ ¼å¼æª¢æŸ¥ï¼Œä¸åšå­˜è­‰æˆ–æŠ•ç¨¿ã€‚</li>
        <li>è§£ææ–¼ç€è¦½å™¨è¨˜æ†¶é«”ï¼Œå®Œæˆå¾Œå³é‡‹æ”¾ï¼›æœ¬ç«™ä¸ä¿å­˜ã€‚</li>
        <li>è«‹å‹¿å«å€‹è³‡ï¼ˆæ ¡åã€å§“åã€ç­ç´šï¼‰ã€‚</li>
      </ul>
    </details>
    <div class="row" style="margin-top:8px">
      <input id="consent" type="checkbox"/><label for="consent">æˆ‘å·²é–±è®€ä¸¦åŒæ„ï¼Œä¸”ç¢ºèªæª”æ¡ˆä¸å« <span class="mono">æ ¡å/å§“å</span>ã€‚</label>
    </div>
    <div id="drop" class="drop" aria-disabled="true">
      <p><strong>æ‹–æ‹‰ PDF æˆ– DOCX åˆ°é€™è£¡</strong></p>
      <label for="file" class="file">é¸æ“‡æª”æ¡ˆ</label>
      <input id="file" type="file" accept=".pdf,.docx" disabled/>
      <p class="hint">å®Œæˆæª¢æŸ¥å³é‡‹æ”¾ï¼ä¸ä¿å­˜ã€‚</p>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="start" class="primary" disabled>é–‹å§‹æª¢æŸ¥</button>
      <button id="clear" disabled>æ¸…é™¤</button>
      <button id="fontCheckBtn" disabled>å­—é«”å­—å‹é€²éšæª¢æŸ¥</button>
      <button id="gptCheckBtn" class="btn-gpt" disabled>å–®ç¨ GPT æª¢æŸ¥ PDF æª”æ¡ˆ</button>
      <details class="gpt-inline-desc">
        <summary>äº†è§£æ­¤åŠŸèƒ½</summary>
        <ul>
          <li>ç”± GPT ç›´æ¥è§£æ PDFï¼ˆä¸èµ°å‰ç«¯è§£æï¼‰ï¼Œå¿«é€Ÿç”¢å‡ºã€Œå«é ç¢¼ã€çš„éŒ¯èª¤æ¸…å–®ã€‚</li>
          <li>å¯æª¢æŸ¥ï¼šæ ¼å¼ã€éŒ¯å­—ã€æ–‡ç»èˆ‡åœ–è¡¨ä¾†æºï¼›å ±å‘Šæ”¯æ´é ç¢¼æ¨™è¨»ã€‚</li>
          <li>ç‚ºä¿éš±ç§ï¼Œæª¢æŸ¥å®Œæˆå¾Œå°‡è‡ªå‹•åˆªé™¤æš«å­˜æª”ï¼Œä¸æœƒæ°¸ä¹…ä¿å­˜ã€‚</li>
        </ul>
      </details>

      <span id="status" class="hint" role="status" aria-live="polite"></span>
    </div>
  </section>

  <section class="card" id="spec">
    <h2>ç³»çµ±æª¢æŸ¥è¦å‰‡ï¼ˆåˆæ ¼æ¨™æº–ï¼‰</h2>
    <ol>
      <li>é æ•¸ï¼š4â€“10 é ã€‚</li>
      <li>é¦–é ç¯‡åéœ€ç½®ä¸­ä¸”è½åœ¨è·ä¸Šç·£ 2 å…¬åˆ†å…§ã€‚</li>
      <li>é¦–é é ç¢¼éœ€ç½®ä¸­ä¸”è½åœ¨è·ä¸‹ç·£ 2 å…¬åˆ†å…§ã€‚</li>
      <li>æª”æ¡ˆåç¨±èˆ‡é é¦–ç¯‡åä¸€è‡´ï¼ˆä¸ç¬¦åˆ¤å®šæ·˜æ±°ï¼‰ã€‚</li>
      <li>æ¯é éœ€æœ‰ç½®ä¸­é ç¢¼ï¼ˆåº•ç«¯å¸¶ï¼‰ã€‚</li>
      <li>å››å‘¨é‚Šç•Œ â‰¥ 2 å…¬åˆ†ï¼ˆæ­£æ–‡å€æ¨ä¼°ï¼‰ã€‚</li>
      <li>ä¸å¾—æœ‰å°é¢é ï¼ˆ4â€“10é ï¼‰ã€‚</li>
      <li>ä¸å¾—å«æ ¡å/å§“åï¼ˆåƒè€ƒæ–‡ç»ä¹‹å¾Œçš„å€æ®µè‡ªå‹•ç•¥éï¼‰ã€‚</li>
      <li>å…­å¤§æ®µè½ä¾åºï¼šå‰è¨€ â†’ æ–‡ç»æ¢è¨ â†’ ç ”ç©¶æ–¹æ³• â†’ ç ”ç©¶åˆ†æèˆ‡çµæœ â†’ ç ”ç©¶çµè«–èˆ‡å»ºè­° â†’ åƒè€ƒæ–‡ç»ã€‚</li>
      <li>å…§æ–‡å¼•è¨»æ¡ ä½œè€…-å¹´ä»½ï¼›ç›´æ¥å¼•æ–‡ â‰¤ 50 å­—ï¼ˆä¸å«æ¨™é»ï¼‰ã€‚</li>
      <li>åƒè€ƒæ–‡ç» â‰¥ 3ï¼›åŒæ™‚é¡¯ç¤ºå››å±¤çµ±è¨ˆï¼ˆç¸½æ•¸/åˆæ ¼/ä¸åˆæ ¼/ç¶²è·¯ä¾†æºï¼‰ã€‚</li>
      <li>åœ–è¡¨éœ€æœ‰æ¨™è™Ÿ/æ¨™é¡Œèˆ‡ä¾†æºï¼ˆè¡¨å…§å·²å¼•æ³¨å¯ä¸æ–¼è¡¨ä¸‹å†æ¨™ï¼‰ã€‚</li>
      <li>åƒè€ƒæ–‡ç»èˆ‡å…§æ–‡å¼•è¨»ä¸€è‡´ï¼›ä¾†æºä¸å¯å…¨ç‚ºç¶²è·¯ã€‚</li>
      <li>å­—é«”/å­—å‹è¦ç¯„ï¼ˆå¯ç”¨é€²éšæª¢æŸ¥ï¼‰ã€‚</li>
      <li>æ ¡å¤–ç™¼è¡¨/å¾—çï¼šå¤–éƒ¨æª¢ç´¢åŠ©æ‰‹ + GPT æç¤ºã€‚</li>
    </ol>
    <ul class="hint" style="margin-top:8px">
      <li><b>æƒ…å¢ƒåŠ å€¼æª¢æŸ¥ï¼ˆçµæœé å¯èƒ½å‡ºç¾ï¼‰ï¼š</b></li>
      <li>ãƒ»ç²—é«”æ¨£å¼æª¢æŸ¥ï¼ˆPDF/DOCXï¼‰â€” å”åŠ©ä½ ç¢ºèªæ›¸åã€æœŸåˆŠåã€å·æœŸç­‰æ˜¯å¦æœ‰ä½¿ç”¨ç²—é«”ã€‚</li>
      <li>ãƒ»é æ•¸ 4â€“10ï¼ˆDOCXï¼‰â€” è‹¥ä¸Šå‚³ DOCXï¼Œå› ç„¡æ³•æº–ç¢ºä¼°é ï¼Œæœƒé¡¯ç¤ºæ›¿ä»£æç¤ºï¼ˆå»ºè­°åŒ¯å‡º PDF å†æª¢æŸ¥ï¼‰ã€‚</li>
      <li>ãƒ»Cloud Run å­—é«”å­—å‹æª¢æŸ¥ï¼ˆé€²éšï¼‰â€” ä½ æŒ‰ä¸‹ã€Œå­—é«”å­—å‹é€²éšæª¢æŸ¥ã€æ™‚æ‰æœƒæ–°å¢ä¸€åˆ—ä¸¦åŒæ­¥è‡³ã€Œå­—é«”/å­—å‹è¦ç¯„ã€ã€‚</li>
    </ul>

    <p class="hint">â€» æœ¬ç³»çµ±ç‚ºè¼”åŠ©å·¥å…·ï¼Œä»éœ€è€å¸«è¦†æ ¸ã€‚</p>
  </section>

  <section class="card" id="resultCard" style="display:none">
    <h3>æª¢æŸ¥çµæœ</h3>
    <div id="fileTag" class="filetag"></div>
    <table><thead><tr><th>è¦å‰‡</th><th>çµæœ</th><th>è­‰æ“š / èªªæ˜</th><th>å»ºè­°</th></tr></thead><tbody id="tbody"></tbody></table>
    <div class="row" style="margin-top:8px">
      <button id="downloadHtml">ä¸‹è¼‰æª¢æŸ¥çµæœï¼ˆç¶²é ï¼‰</button>
      <button id="copyJson">è¤‡è£½æª¢æŸ¥çµæœ (çµ¦AIåŠ©æ‰‹)</button>
      <button id="downloadJson">å„²å­˜æª¢æŸ¥çµæœæª”æ¡ˆ</button>
      <a id="openGpts" class="primary" href="https://chatgpt.com/g/g-68c6d9e700c88191872154808e0e0e7b-gao-zhong-zhi-xiao-lun-wen-ge-shi-zi-jian-xi-tong" target="_blank" rel="noopener">æ‰“é–‹AIåŠ©æ‰‹ï¼ˆè²¼ä¸Šæª¢æŸ¥çµæœï¼‰</a>
    </div>
    <pre id="jsonPreview" class="mono" style="margin-top:8px"></pre>
  </section>
</div>

<script>
/* ===== è¨­å®š ===== */
// é€™è£¡ä¸€å®šè¦è²¼ã€Œéƒ¨ç½² > ç®¡ç†éƒ¨ç½² > ç¶²é æ‡‰ç”¨ç¨‹å¼ > ç¶²å€ã€é‚£å€‹ /exec
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwMjhNj9wJmXeTtq4W2kf0MErBPoq_bCMzZBryMCf16ko_5tqAAw7nqq7yJAwjvQKEi/exec";
const ENABLE_COUNTER = true;
const CLOUD_RUN_BASE = "https://font-check-api-1009467346209.asia-east1.run.app";
const CLOUD_RUN_ENDPOINT = CLOUD_RUN_BASE + "/check";

// âš ï¸ å…ˆä¸è¦åœ¨é€™è£¡å‘¼å« fetchCounter()ï¼Œæ”¹åˆ° DOM è§£æå®Œæˆå¾Œå†å«ï¼ˆè¦‹ä¸‹ï¼‰
</script>
<script>
/* ===== UI è®Šæ•¸ ===== */
const consent=document.getElementById('consent'),fileInput=document.getElementById('file'),drop=document.getElementById('drop');
const startBtn=document.getElementById('start'),clearBtn=document.getElementById('clear'),fontCheckBtn=document.getElementById('fontCheckBtn');
const statusEl=document.getElementById('status'),resultCard=document.getElementById('resultCard'),tbody=document.getElementById('tbody');
const downloadHtmlBtn=document.getElementById('downloadHtml'),copyBtn=document.getElementById('copyJson'),downloadJsonBtn=document.getElementById('downloadJson');
const jsonPreview=document.getElementById('jsonPreview'),counterBox=document.getElementById('counterBox'),counterEl=document.getElementById('counter'),fileTagEl=document.getElementById('fileTag');


// âœ… ç­‰ DOM è§£æå®Œæˆå†æŠ“äººæ¬¡ï¼›ä¸é˜»å¡ UI
(function initCounter() {
  if (!ENABLE_COUNTER) return;

  // å»¶é² 0.5 ç§’åŸ·è¡Œä»¥é¿å…é˜»å¡
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(async () => {
      try {
        await fetchCounter();
      } catch (err) {
        console.error('è®€å–äººæ¬¡å¤±æ•—', err);
        if (counterEl) counterEl.textContent = 'â€”';
      }
    }, 500);
  });
})();

// ã€ŒåŒæ„ä¸Šå‚³æ”¿ç­–ã€å‹¾é¸å¾Œä½ åŸæœ¬ä¹Ÿæœƒå†å« fetchCounter() â€”â€” ä¿ç•™å³å¯

/* ===== ç‹€æ…‹ ===== */
let arrayBuffer=null, fileName=null, fileBase=null, fileExt=null, lastSummaryJSON=null, _lastPageCount=0;
let _ruleCounter=0;
const _rowsBuffer=[];
let _fontCheckMirror=null;
// å…è¨±çš„é‚Šç•Œèª¤å·®ï¼ˆptï¼‰ã€‚0.8pt â‰ˆ 0.28mm
const MARGIN_TOL_PT = 0.8;
const PUNCT=/[ï¼Œã€‚ã€ï¼ï¼›ï¼šã€ï¼ï¼Ÿâ€”â”€\-â€¦â€§ï¼ˆï¼‰()ã€”ã€•ã€ã€‘ã€Šã€‹ã€ˆã€‰ã€Œã€ã€ã€â€œâ€"'\[\]{}<>â€§Â·~`^_=+\|\\/:ï¼Œ,.;:!\?\s]/g;
const SCHOOL_PATTERNS=[/(åœ‹ç«‹|å¸‚ç«‹|ç¸£ç«‹)[\u4e00-\u9fa5]{0,8}(é«˜ç´šä¸­å­¸|é«˜ä¸­|é«˜è·|é«˜å·¥|å®¶å•†|å•†å·¥|è¾²å·¥|é«˜è¾²|è·æ¥­å­¸æ ¡|ä¸­å­¸|åœ‹ä¸­|å°å­¸|å¤§å­¸|ç§‘æŠ€å¤§å­¸|ç§‘å¤§|å¸«ç¯„å¤§å­¸|å¤§å­¸é™„ä¸­|å¯¦é©—é«˜ä¸­|é«˜ä¸­éƒ¨)/g];

/* ===== è¦å‰‡å¸¸æ•¸ ===== */
const RULES = {
  minPages: 4,
  maxPages: 10,
  maxSizeMB: 5,
  sixSections: ['å‰è¨€', 'æ–‡ç»æ¢è¨', 'ç ”ç©¶æ–¹æ³•', 'ç ”ç©¶åˆ†æèˆ‡çµæœ', 'ç ”ç©¶çµè«–èˆ‡å»ºè­°', 'åƒè€ƒæ–‡ç»'],
  quoteMaxChars: 50,
  minQuoteCharsForDirect: 10,
  marginCM: 2.0
};

/* ===== é‚Šç•Œæ›ç®— ===== */
const CM_TO_PT = cm => cm * 72 / 2.54;
const MARGIN_PT = CM_TO_PT(RULES.marginCM);


/* ===== å¯ç”¨æ€§ ===== */
function setUploadEnabled(ok){
  fileInput.disabled=!ok;
  const has=!!arrayBuffer;
  startBtn.disabled = !ok || !has;
  clearBtn.disabled = !ok || !has;
  fontCheckBtn.disabled = !ok || !has || fileExt!=='pdf';
  if (window.gptCheckBtn) {
    gptCheckBtn.disabled = !ok || !has || fileExt!=='pdf';
  }
}

// å†å»æŠ“äººæ¬¡ï¼ˆé¿å…åˆå§‹åŒ–é–æ­» fileInputï¼‰
if (ENABLE_COUNTER) fetchCounter();
statusEl.textContent=consent.checked?'å·²åŒæ„ï¼Œå¯ä¸Šå‚³ã€‚':'è«‹å…ˆåŒæ„æ”¿ç­–ã€‚';
// å¯ç”¨æ€§ï¼šé é¢è¼‰å…¥å¾Œå…ˆåŒæ­¥ä¸€æ¬¡
setUploadEnabled(consent.checked);
// å‹¾é¸/å–æ¶ˆåŒæ„æ™‚ï¼Œç«‹å³æ›´æ–°å¯ç”¨æ€§èˆ‡æç¤ºæ–‡å­—
consent.addEventListener('change', () => {
  setUploadEnabled(consent.checked);
  statusEl.textContent = consent.checked ? 'å·²åŒæ„ï¼Œå¯ä¸Šå‚³ã€‚' : 'è«‹å…ˆåŒæ„æ”¿ç­–ã€‚';
});


/* DnD */
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();if(!fileInput.disabled)drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');}));
drop.addEventListener('drop',e=>{if(fileInput.disabled)return;const f=e.dataTransfer.files?.[0];if(f)handleFile(f);});
fileInput.addEventListener('change',e=>{const f=e.target.files?.[0];if(f)handleFile(f);});
function baseName(n){return(n||'').replace(/\.[^.]+$/,'').trim();}
async function handleFile(f){
  const ext=(f.name.split('.').pop()||'').toLowerCase(); if(!['pdf','docx'].includes(ext)){statusEl.textContent='åƒ…æ”¯æ´ PDF æˆ– DOCX';return;}
  if(f.size>RULES.maxSizeMB*1024*1024){statusEl.textContent=`æª”æ¡ˆè¶…é ${RULES.maxSizeMB}MB ä¸Šé™ã€‚`;return;}
  fileName=f.name;fileBase=baseName(f.name);fileExt=ext;arrayBuffer=await f.arrayBuffer();
  statusEl.textContent=`å·²é¸æ“‡ï¼š${f.name}ï¼ˆ${(f.size/1024/1024).toFixed(2)} MBï¼‰`;setUploadEnabled(consent.checked);
}
clearBtn.addEventListener('click',()=>{fileInput.value='';arrayBuffer=null;fileName=fileBase=fileExt=null;startBtn.disabled = true;
clearBtn.disabled = true;
fontCheckBtn.disabled = true;
if (window.gptCheckBtn) window.gptCheckBtn.disabled = true;resultCard.style.display='none';tbody.innerHTML='';fileTagEl.textContent='';statusEl.textContent='å·²æ¸…é™¤ã€‚';jsonPreview.textContent='';lastSummaryJSON=null;_rowsBuffer.length=0;_fontCheckMirror=null;});

/* ===== ä¸»æµç¨‹ ===== */
startBtn.addEventListener('click',async()=>{
  if(!arrayBuffer)return;tbody.innerHTML='';resultCard.style.display='none';statusEl.textContent='è§£æä¸­â€¦';_rowsBuffer.length=0;_ruleCounter=0;_fontCheckMirror=null;
  try{
    if(fileExt==='pdf'){await runPdfChecks(arrayBuffer);} else {await runDocxChecks(arrayBuffer);}
    resultCard.style.display='block';fileTagEl.textContent=`æ­¤æ¬¡æª¢æŸ¥æª”æ¡ˆï¼š${fileName||'(æœªå‘½å)'}`;statusEl.textContent='å®Œæˆæª¢æŸ¥ã€‚';
    buildAndShowSummaryJSON({fileName,pages:_lastPageCount||0,passFailRows:_rowsBuffer.slice()});
    if(ENABLE_COUNTER){await bumpCounterEveryTime();await fetchCounter();}
  }catch(e){console.error(e);statusEl.textContent='è§£æå¤±æ•—ï¼šè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦æœ‰æ•ˆã€‚'}
});

/* ===== é€²éšå­—é«”æª¢æŸ¥ ===== */
fontCheckBtn.addEventListener('click', async () => {
  // 1) å„ªå…ˆç”¨ <input type=file> çš„ File ç‰©ä»¶ï¼ˆæœ€å¯é ï¼‰
  const picked = document.querySelector('#file')?.files?.[0];

  // 2) é€€è€Œæ±‚å…¶æ¬¡ï¼šç”¨è¨˜æ†¶é«”ä¸­çš„ arrayBuffer è½‰ Blob
  const fallbackBlob = arrayBuffer
    ? new Blob([arrayBuffer], { type: "application/pdf" })
    : null;

  // 3) å–å¾—è¦é€å‡ºçš„æª”æ¡ˆèˆ‡æª”å
  const fileForUpload = picked || fallbackBlob;
  const nameForServer = picked?.name || fileName || "upload.pdf";

  if (!fileForUpload || fileExt !== 'pdf') {
    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ PDF æª”å†é€²è¡Œå­—é«”æª¢æŸ¥ã€‚');
    return;
  }

  // å°å°é™¤éŒ¯ï¼šåœ¨ Console çœ‹çœ‹å¯¦éš›é€å‡ºçš„å¤§å°
  console.log('[CloudRun] going to upload:',
              fileForUpload, 'size =', fileForUpload.size);

  try {
    statusEl.textContent = 'ä¸Šå‚³è‡³ Cloud Run é€²è¡Œå­—é«”æª¢æŸ¥â€¦';
    const data = await fetchCloudRun(fileForUpload, nameForServer);
    if (data) {
      const { pass, suggestion } = normalizeApiResult(data);
      const ev = buildEvidenceString(data);
      _fontCheckMirror = { pass: Boolean(pass), evidence: ev, suggestion: suggestion || '' };
      addRow('Cloud Run å­—é«”å­—å‹æª¢æŸ¥', !!pass, ev, suggestion || 'è«‹ä¾è¦ç¯„ä¿®æ­£å­—é«”ã€‚');
      syncBasicFontRuleMirror();
      buildAndShowSummaryJSON({ fileName, pages: _lastPageCount || 0, passFailRows: _rowsBuffer.slice() });
      resultCard.style.display = 'block';
      fileTagEl.textContent = `æ­¤æ¬¡æª¢æŸ¥æª”æ¡ˆï¼š${fileName || '(æœªå‘½å)'}`;
      statusEl.textContent = 'Cloud Run æª¢æŸ¥å®Œæˆã€‚';
    }
  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Cloud Run æª¢æŸ¥å¤±æ•—ã€‚';
  }
});

async function fetchCloudRun(fileOrBlob, nameForServer) {
  const formData = new FormData();
  // ç”¨æ¬„ä½å "file"ï¼ˆå¾Œç«¯å·²æ”¯æ´ï¼‰ï¼Œä¸¦ä¿ç•™åŸå§‹æª”å
  formData.append("file", fileOrBlob, nameForServer || "upload.pdf");

  // ç ´å£å¿«å–ï¼Œé¿å…å‘½ä¸­èˆŠçš„é æª¢/éŒ¯èª¤å›æ‡‰
  const url = CLOUD_RUN_ENDPOINT + "?v=" + Date.now();

  try {
    const res = await fetch(url, {
      method: "POST",
      mode: "cors",
      cache: "no-store",
      body: formData,
      // æ³¨æ„ï¼šä½¿ç”¨ FormData æ™‚ä¸è¦è‡ªå·±è¨­ Content-Typeï¼Œç€è¦½å™¨æœƒå¸¶ boundary
    });

    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`API ${res.status} ${res.statusText} ${t}`);
    }
    return await res.json();

  } catch (err) {
    console.error("Cloud Run å¤±æ•—ï¼š", err);

    const msg = (err && err.message ? String(err.message).slice(0, 400) : '');
    addRow(
      "Cloud Run å­—é«”å­—å‹æª¢æŸ¥",
      false,
      `CORS/å¿«å–æˆ–è³‡æ–™å•é¡Œï¼šdetails: ${msg || 'ï¼ˆç„¡æ›´å¤šè¨Šæ¯ï¼‰'}`,
      "è«‹æª¢æŸ¥ Cloud Run æ˜¯å¦å…è¨±åŒ¿åã€å·²é–‹ CORSï¼Œä¸”å‰ç«¯ç¢ºå¯¦é€å‡ºæª”æ¡ˆã€‚"
    );
    return null;
  }
}

function normalizeApiResult(data){const pass=typeof data.pass==='boolean'?data.pass:(data.summary?.pass??data.ok??false);const suggestion=data.suggestion||data.summary?.suggestion||'';return {pass,suggestion}}
function buildEvidenceString(data){
  try{const parts=[]; if(data.summary?.pages)parts.push(`é æ•¸ï¼š${data.summary.pages}`);
    if(data.summary?.dominant_fonts)parts.push(`ä¸»è¦å­—é«”ï¼š${data.summary.dominant_fonts.join('ã€')}`);
    if(Array.isArray(data.top_fonts))parts.push('å¸¸è¦‹å­—é«”ï¼š'+data.top_fonts.slice(0,6).join('ã€'));
    if(data.layout?.per_page_margins?.length){const f=data.layout.per_page_margins[0];parts.push(`ç¬¬1é é‚Šç•Œé‡æ¸¬ï¼šå·¦${f.left} / å³${f.right} / ä¸Š${f.top} / ä¸‹${f.bottom} pt`);}
    return parts.join('ï½œ')||JSON.stringify(data).slice(0,800);
  }catch{return typeof data==='object'?JSON.stringify(data).slice(0,800):String(data)}
}

/* ===== PDF æª¢æŸ¥ ===== */
async function runPdfChecks(buf){
  const {getDocument}=await window.loadPdfjs(); const pdf=await getDocument({data:buf}).promise;
  const numPages=pdf.numPages; _lastPageCount=numPages;
 
  // ===== PDF ç²—é«”åµæ¸¬ =====
  let boldWordCount = 0;
  let boldFonts = new Set();

  const pageTexts=[];
  addRow('é æ•¸ 4â€“10',(numPages>=RULES.minPages&&numPages<=RULES.maxPages),`å…± ${numPages} é `,'è‹¥å°‘æ–¼4æˆ–å¤šæ–¼10é ï¼Œè«‹ä¿®è¨‚ç¯‡å¹…ã€‚');

  let pageNumOkPages=[];
  const headerTitleTexts=[];
  let minLeft=Infinity,minRight=Infinity,minTop=Infinity,minBottom=Infinity;
  let firstHeaderOK=false, firstFooterOK=false;

  // åªé‡æ¸¬ç¬¬1é æ­£æ–‡ç”¨
  let firstSectionY = null;    // ç¬¬1é ã€Œå£¹ã€å‰è¨€ã€é‚£ä¸€è¡Œçš„ Y åº§æ¨™ï¼ˆpdf.js çš„ y åº§æ¨™ï¼šè¶Šå¤§è¶Šé ä¸Šï¼‰
  const FIRST_BODY_GUESS_FALLBACK = 40; // å®¹å·®ï¼ˆptï¼‰ï¼Œæ‰¾ä¸åˆ°ã€Œå‰è¨€ã€æ™‚ï¼Œå¾€ä¸Šç•¥é 40pt ç•¶ä½œæ­£æ–‡èµ·é»

  for(let p=1;p<=numPages;p++){
    const page=await pdf.getPage(p); const viewport=page.getViewport({scale:1}); const W=viewport.width,H=viewport.height;
    const tc=await page.getTextContent();

    const topBandMinY = H - MARGIN_PT;
    const bottomBandMaxY = MARGIN_PT;
    const centerTol = Math.max(W*0.15,72);

    let hasCenterPageNum=false;
    const pageBuf=[];
    let _lastXY=null;

    for(const it of tc.items){
      const tr=it.transform; const x=tr[4], y=tr[5]; const w=(typeof it.width==='number')?it.width:0;
      const txt=(it.str||'').trim();

            // ç²—é«”å­—é«”åç¨±åµæ¸¬
      if (it.fontName && /bold|é»‘é«”|heavy|medium/i.test(it.fontName)) {
        boldWordCount += (txt.length || 1);
        boldFonts.add(it.fontName);
      }

      if(txt){
        if(_lastXY){
          const newLine =
            (Math.abs(y - _lastXY.y) > 6 && x < _lastXY.x + 20) ||
            (y < _lastXY.y - 2 && x <= _lastXY.x);
          if(newLine) pageBuf.push('\n');
        }
        pageBuf.push(txt);
        _lastXY = {x,y};
      }

      if(p===1 && txt){
        const mid = x + w/2;
        const centeredByMid = (mid >= (W/2 - centerTol) && mid <= (W/2 + centerTol));
        const inTop2cm = (y >= topBandMinY);
        const looksLikeTitle = !/^\d+$/.test(txt) && txt.replace(/\s/g,'').length >= 2;
        if(inTop2cm && centeredByMid && looksLikeTitle){ firstHeaderOK = true; }
      }

      // åªåœ¨ç¬¬1é åµæ¸¬ã€Œå£¹ã€å‰è¨€ï¼ä¸€ã€å‰è¨€ï¼1ã€å‰è¨€ã€ç•¶ä½œæ­£æ–‡èµ·é»
      if (p === 1 && txt) {
        // å¸¸è¦‹ä¸‰ç¨®å¯«æ³•ï¼šå£¹ã€ä¸€ã€1ï¼ŒåŠ ä¸Š ã€ï¼. ä»»ä¸€æ¨™é»
        if (/^\s*(å£¹|ä¸€|1)\s*[ã€ï¼\.]\s*å‰è¨€\s*$/.test(txt)) {
          // è¨˜ä¸‹é€™ä¸€è¡Œçš„ yï¼ˆpdf.jsï¼šè¶Šå¤§è¶Šé è¿‘ä¸Šç·£ï¼‰
          firstSectionY = y;
        }
      }

      const centeredBottomByMid = (()=>{const mid=x+w/2;return (mid >= (W/2 - centerTol) && mid <= (W/2 + centerTol));})();
      const inBottom2cm = (y <= bottomBandMaxY);
      const m = txt.match(/^\s*(?:ç¬¬)?\s*[-â€”]*\s*(\d{1,4})\s*[-â€”]*(?:\s*é )?\s*$/);
      if(inBottom2cm && centeredBottomByMid && m){
        const num=parseInt(m[1],10);
        hasCenterPageNum=true;
        if(num!==p) {/* å¿½ç•¥æ˜¯å¦é€£è™Ÿ */}
        if(p===1) firstFooterOK = true;
      }

      if(y>=topBandMinY && txt){ headerTitleTexts.push(txt); }

            // åªé‡æ¸¬ç¬¬1é ï¼›ä¸”å¿…é ˆæ˜¯æ­£æ–‡å€ï¼ˆä¸‹ç·£è¶…é 2cmã€ä¸Šç·£åœ¨ 2cm å…§ï¼‰
      const inBody = (y > MARGIN_PT) && (y < (H - MARGIN_PT));

      // åªæ¡ç”¨ç¬¬1é ä¸”ã€Œä½åœ¨ã€ˆå£¹ã€å‰è¨€ã€‰é‚£è¡Œä¹‹ä¸‹ã€çš„æ–‡å­—æ–¹å¡Š
      let isFirstPageBody = false;
      if (p === 1 && inBody) {
        // æ‰¾åˆ°ã€Œå£¹ã€å‰è¨€ã€ï¼šæ­£æ–‡åœ¨å®ƒä¹‹ä¸‹ï¼ˆy æœƒæ¯”å®ƒå°ä¸€äº›ï¼Œç•™ä¸€é»å®¹å·®ï¼‰
        if (firstSectionY != null) {
          isFirstPageBody = (y < firstSectionY - 2);
        } else {
          // æ‰¾ä¸åˆ°å°±ä¿å®ˆç•¥éæœ€ä¸Šæ–¹ç´„ 40ptï¼Œè¦–ç‚ºæ­£æ–‡èµ·é»
          isFirstPageBody = (y < (H - MARGIN_PT - FIRST_BODY_GUESS_FALLBACK));
        }
      }

      if (isFirstPageBody) {
        const distLeft   = x;
        const distRight  = W - (x + w);
        const distBottom = y;
        const distTop    = H - y;

        if (distLeft   < minLeft)   minLeft   = distLeft;
        if (distRight  < minRight)  minRight  = distRight;
        if (distBottom < minBottom) minBottom = distBottom;
        if (distTop    < minTop)    minTop    = distTop;
      }

    }
    if(hasCenterPageNum)pageNumOkPages.push(p);
    pageTexts[p]=pageBuf.join('');
  }

  addRow('é¦–é ç¯‡åéœ€ç½®ä¸­ä¸”è½åœ¨è·ä¸Šç·£ 2 å…¬åˆ†å…§', firstHeaderOK,
    firstHeaderOK?'å·²æ–¼é¦–é åµæ¸¬åˆ°ç½®ä¸­ä¹‹ç¯‡å/æ¨™é¡Œ':'æœªåµæ¸¬åˆ°ç½®ä¸­ç¯‡åæˆ–ä½ç½®ä¸åœ¨ 2 å…¬åˆ†å…§',
    'è«‹å°‡ç¯‡åç½®ä¸­æ–¼é é¦–ï¼Œä¸”ä½ç½®è½åœ¨è·ä¸Šç·£ 2 å…¬åˆ†ä»¥å…§ã€‚');

  addRow('é¦–é é ç¢¼éœ€ç½®ä¸­ä¸”è½åœ¨è·ä¸‹ç·£ 2 å…¬åˆ†å…§', firstFooterOK,
    firstFooterOK?'å·²æ–¼é¦–é åµæ¸¬åˆ°ç½®ä¸­é ç¢¼':'æœªåµæ¸¬åˆ°ç½®ä¸­é ç¢¼æˆ–ä½ç½®æœªè½åœ¨è·ä¸‹ç·£ 2 å…¬åˆ†å…§',
    'è«‹å°‡é ç¢¼ç½®ä¸­æ–¼é å°¾ï¼Œä¸¦ä¿æŒè·ä¸‹ç·£ 2 å…¬åˆ†ä»¥å…§ã€‚');

  const headerTitleGuess=(()=>{const n=s=>(s||'').replace(/\s/g,'').toLowerCase();const filtered=headerTitleTexts.filter(s=>n(s).length>=4);const freq=new Map();for(const s of filtered){const k=n(s);freq.set(k,(freq.get(k)||0)+1)}let bestKey='',bestCount=0;for(const [k,c] of freq){if(c>bestCount){bestKey=k;bestCount=c}}const raw=filtered.find(s=>n(s)===bestKey)||'';return{norm:bestKey,raw}})();
  const fileNorm=(fileBase||'').replace(/\s/g,'').toLowerCase(), titleNorm=headerTitleGuess.norm;
  const titleDetected=!!titleNorm, nameTitleConsistent = titleDetected && (titleNorm.includes(fileNorm)||fileNorm.includes(titleNorm));
  addRow('æª”æ¡ˆåç¨±èˆ‡é é¦–ç¯‡åä¸€è‡´ï¼ˆä¸ç¬¦åˆ¤å®šæ·˜æ±°ï¼‰',nameTitleConsistent,
    titleDetected?`æª”åã€Œ${fileBase}ã€ï¼›é é¦–ç¯‡åã€Œ${headerTitleGuess.raw}ã€`:'æœªåµæ¸¬åˆ°é é¦–ç¯‡å',
    'è«‹ä½¿æª”åèˆ‡é é¦–ç¯‡åä¸€è‡´ã€‚');

  const pageNumPass=(pageNumOkPages.length===_lastPageCount);
  addRow('æ¯é éœ€æœ‰ç½®ä¸­é ç¢¼ï¼ˆåº•ç«¯å¸¶ï¼‰',pageNumPass,
    pageNumPass?'æ‰€æœ‰é åº•ä¸­å¤®çš†æœ‰é ç¢¼':`ç¼ºå°‘é ç¢¼é æ¬¡ï¼š${missingRange(pageNumOkPages,_lastPageCount)}`,
    'è«‹åœ¨é å°¾ç½®ä¸­æ”¾ç½®é˜¿æ‹‰ä¼¯æ•¸å­—é ç¢¼ã€‚');

  const MPT = MARGIN_PT.toFixed(1);
  const tol = MARGIN_TOL_PT.toFixed(1);
  // â€¦åœ¨ addRow çš„ evidence å­—ä¸²è£¡ï¼š

  const marginPass =
  (isFinite(minLeft)   && (minLeft   + MARGIN_TOL_PT) >= MARGIN_PT) &&
  (isFinite(minRight)  && (minRight  + MARGIN_TOL_PT) >= MARGIN_PT) &&
  (isFinite(minBottom) && (minBottom + MARGIN_TOL_PT) >= MARGIN_PT) &&
  (isFinite(minTop)    && (minTop    + MARGIN_TOL_PT) >= MARGIN_PT);

  addRow(
    'å››å‘¨é‚Šç•Œ â‰¥ 2 å…¬åˆ†ï¼ˆæ­£æ–‡å€æ¨ä¼°ï¼‰',
    marginPass,
    `ï¼ˆåƒ…ç¬¬1é ã€å¾ã€Œå£¹ã€å‰è¨€ã€èµ·ç®—ï¼‰ä¼°è¨ˆæœ€å°é‚Šç•Œï¼ˆptï¼‰ï¼šå·¦ ${isFinite(minLeft)?minLeft.toFixed(1):'â€”'}ã€å³ ${isFinite(minRight)?minRight.toFixed(1):'â€”'}ã€ä¸Š ${isFinite(minTop)?minTop.toFixed(1):'â€”'}ã€ä¸‹ ${isFinite(minBottom)?minBottom.toFixed(1):'â€”'}ï¼ˆé–€æª»â‰ˆ${MPT}ï¼‰`,
    'åªè¦ç¬¬1é æ­£æ–‡å››é‚Šçš† â‰¥ 2 å…¬åˆ†ï¼Œå³è¦–ç‚ºç‰ˆé¢åˆæ ¼ã€‚'
  );

  const fullText = pageTexts.slice(1).join('\n\n[[PAGE_SPLIT]]\n\n');
  const firstText=pageTexts[1]||''; const coverHits=['å°é¢','å­¸æ ¡','æŒ‡å°è€å¸«','å­¸ç”Ÿ','ç­ç´š','å­¸è™Ÿ'].filter(k=>firstText.includes(k));
  addRow('ä¸å¾—æœ‰å°é¢é ï¼ˆ4â€“10é ï¼‰',coverHits.length===0, coverHits.length?`ç¬¬1é ç–‘ä¼¼å°é¢é—œéµå­—ï¼š${coverHits.join('ã€')}`:'æœªç™¼ç¾','4â€“10é ä¹‹å°è«–æ–‡ä¸æ‡‰åŒ…å«å°é¢è³‡è¨Šã€‚');

  // ===== ç²—é«”å­—é«”çµ±è¨ˆ =====
  const boldFontsList = Array.from(boldFonts);
  const hasBoldFont = boldWordCount > 0;
  addRow(
    'ç²—é«”æ¨£å¼æª¢æŸ¥ï¼ˆPDFï¼‰',
    hasBoldFont,
    hasBoldFont ? `æª¢å‡ºç²—é«”å­—é«” ${boldFontsList.join('ã€')}ï½œç´„ ${boldWordCount} å­—` : 'æœªæª¢å‡ºç²—é«”æ¨£å¼',
    hasBoldFont ? 'OKï¼ˆå·²æª¢æ¸¬åˆ°ç²—é«”å­—é«”ï¼‰' : 'è«‹ç¢ºèªåƒè€ƒæ–‡ç»ä¹‹æ›¸åã€æœŸåˆŠåã€å·æœŸç­‰éœ€ä»¥ç²—é«”è¡¨ç¤ºã€‚'
  );

  runTextRules(pageTexts);
}

/* ===== DOCX ===== */
async function runDocxChecks(buf){
  // å…ˆæŠŠ DOCX è½‰æˆ HTML
  const { value: html } = await window.mammoth.convertToHtml({ arrayBuffer: buf });

  // ===== DOCX ç²—é«”åµæ¸¬ =====
  const boldTags = (html.match(/<(b|strong)>/gi) || []).length;
  addRow(
    'ç²—é«”æ¨£å¼æª¢æŸ¥ï¼ˆDOCXï¼‰',
    boldTags > 0,
    boldTags > 0 ? `æª¢å‡º <b>/<strong> æ¨™ç±¤ ${boldTags} è™•` : 'æœªæª¢å‡ºç²—é«”æ¨£å¼',
    boldTags > 0 ? 'OKï¼ˆå·²åµæ¸¬åˆ°ç²—é«”æ–‡å­—æ¨£å¼ï¼‰' : 'è«‹ç¢ºèªæ›¸åã€æœŸåˆŠåã€å·æœŸç­‰éœ€ä»¥ç²—é«”è¡¨ç¤ºã€‚'
  );

  const text = stripHtml(html);
  _lastPageCount = 0;
  addRow('é æ•¸ 4â€“10ï¼ˆDOCXï¼‰', true, 'DOCX ç„¡æ³•ç²¾ç¢ºä¼°é ï¼Œå»ºè­°åŒ¯å‡º PDF å†æª¢æŸ¥ç©ºé–“è¦å‰‡ã€‚', 'è«‹åŒ¯å‡º PDFã€‚');
  runTextRules([text]);
}

function stripHtml(html){const t=document.createElement('div');t.innerHTML=html;return t.textContent||t.innerText||''}

/* ===== åƒè€ƒæ–‡ç»å·¥å…·ï¼ˆåƒ…å°å¹…ä¿®æ­£ï¼‰ ===== */

// å–ã€Œæœ€å¾Œä¸€å€‹ã€åƒè€ƒæ–‡ç»æ¨™é¡Œä½ç½®
function _findRefStart(fullText) {
  const text = fullText || '';
  const pat = /(^|\n)[^\n]{0,6}\s*(?:é™¸[ã€ï¼Œ.]?\s*)?(åƒè€ƒæ–‡ç»|åƒè€ƒè³‡æ–™|References)\s*$/gmi;
  let m, lastIdx = -1;
  while ((m = pat.exec(text)) !== null) lastIdx = m.index + (m[1] ? m[1].length : 0);
  if (lastIdx < 0) {
    const cands = ['åƒè€ƒæ–‡ç»','åƒè€ƒè³‡æ–™','References']
      .map(t => text.lastIndexOf(t)).filter(i => i >= 0);
    if (cands.length) lastIdx = Math.max(...cands);
  }
  return lastIdx;
}

// å°æ¨™åµæ¸¬ï¼šé¡åˆ¥æ¨™é¡Œï¼ˆä¸ç®—ä¸€æ¢æ–‡ç»ï¼‰
function _isCategoryHeader(line) {
  const s = (line || '').replace(/^[\s\u3000]+|[\s\u3000]+$/g, '');
  if (/^(é™¸[ã€ï¼Œ.]?)?\s*(åƒè€ƒæ–‡ç»|åƒè€ƒè³‡æ–™|References)\s*$/i.test(s)) return true;
  if (/^([ï¼ˆ(]?\s*[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+\s*[)ï¼‰]?\s*[\.ï¼ã€]?)\s*[\u4e00-\u9fa5A-Za-z]{0,12}(æ›¸ç±|å°ˆæ›¸|æœŸåˆŠ|æœŸåˆŠè«–æ–‡|è«–æ–‡|åšç¢©å£«|æœƒè­°|å ±ç´™|é›»å­å ±|ç¶²ç«™|ç¶²è·¯|ç¶²è·¯ç›¸é—œè³‡æº|è³‡æ–™|æ–‡ç»|æ³•è¦|æ”¿åºœ|æ©Ÿæ§‹)\s*(é¡|è³‡æ–™|è³‡æº)?\s*$/.test(s)) return true;
  if (/^[ã€ã€ˆã€Š]\s*[\u4e00-\u9fa5A-Za-z]{1,12}\s*(é¡|è³‡æ–™|è³‡æº)?\s*[ã€‘ã€‰ã€‹]$/.test(s)) return true;
  return false;
}

// åƒè€ƒæ–‡ç»å‰è™•ç†ï¼ˆæ–°å¢çŸ­ç¶²å€æ›è¡Œåˆä½µï¼‰
function _preCleanRefText(s) {
  return (s || '')
    // PDF é åˆ†éš”æ¨™è¨˜ â†’ æ›è¡Œ
    .replace(/\[\[PAGE_SPLIT\]\]/g, '\n')

    // å–®ç¨é ç¢¼/è¡Œè™Ÿ â†’ ç§»é™¤
    .replace(/^\s*\d{1,4}\s*$/gm, '')

    // è‹±æ•¸é€£å­—è·¨è¡Œ â†’ æ¥å›
    .replace(/([A-Za-z0-9])-\s*\n\s*([A-Za-z0-9])/g, '$1$2')

    // å°‡ã€Œç¨ç«‹ç¶²å€è¡Œï¼ˆå«çŸ­ç¶²å€ï¼‰ã€æ¨å›ä¸Šä¸€è¡Œï¼ˆé¿å…è¢«èª¤ç•¶æˆæ–°æ¢ï¼‰
    .replace(/\n\s*(https?:\/\/\S+)\s*$/gm, ' $1')
    .replace(/\n\s*(www\.\S+)\s*$/gm, ' $1')
    .replace(/\n\s*(doi\.org\/\S+)\s*$/gim, ' $1')
    .replace(/\n\s*((?:reurl\.cc|bit\.ly|tinyurl\.com|t\.ly|t\.co|goo\.gl|is\.gd|ow\.ly|lihi\d?\.cc|ppt\.cc|forms\.gle|youtu\.be|github\.io|medium\.com|shorturl\.at|url\.cn)\S*)\s*$/gim, ' $1')

    // æœ‰äº›å­¸ç”Ÿæœƒåœ¨æ¯ç­†ä¹‹é–“æ’ã€Œ1 å€‹ç©ºè¡Œã€â†’ ä¿ç•™ 1 å€‹æ›è¡Œå³å¯ï¼ˆå¤šæ–¼ 2 å€‹å£“æˆ 1 å€‹ï¼‰
    .replace(/\n{3,}/g, '\n\n')

    // è¡Œå°¾ç©ºç™½ â†’ æ¸…ç†
    .replace(/[ \t]+\n/g, '\n')
    .trim();
}

// æ–‡ç»åˆ‡æ¢
function _parseReferenceEntries(refText) {
  // å…ˆæŒ‰ã€Œè‡³å°‘ä¸€å€‹æ›è¡Œã€åˆ‡ï¼›ä¸å…ˆæ¿¾ç©ºï¼Œè®“ç©ºè¡Œæœ‰æ©Ÿæœƒç•¶ä½œã€Œåˆ†éš”ç¬¦ã€
  const rawLines = (refText || '').split(/\n+/);

  const entries = [];
  let cur = '';

  const SHORT_DOMAINS = /(reurl\.cc|bit\.ly|tinyurl\.com|t\.ly|t\.co|goo\.gl|is\.gd|ow\.ly|lihi\d?\.cc|ppt\.cc|forms\.gle|youtu\.be|github\.io|medium\.com|shorturl\.at|url\.cn)/i;

  const isNewByIndex = s =>
    // 1) é˜¿æ‹‰ä¼¯æ•¸å­— 1. / 1ã€ / 1ï¼‹ç©ºç™½
    /^[\s\u3000]*\d+\s*(?:[\.ï¼ã€]\s*|\s{1,})/.test(s) ||
    // 2) ä¸­æ–‡æ•¸å­— ä¸€. / ä¸€ã€ / ä¸€ï¼‹ç©ºç™½
    /^[\s\u3000]*[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]{1,4}\s*(?:[\.ï¼ã€]\s*|\s{1,})/.test(s) ||
    // 3) æ‹¬è™Ÿç·¨è™Ÿ ï¼ˆä¸€ï¼‰. / ï¼ˆä¸€ï¼‰ã€ / ï¼ˆä¸€ï¼‰ï¼‹ç©ºç™½
    /^[\s\u3000]*[ï¼ˆ(]\s*(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]{1,4})\s*[)ï¼‰]\s*(?:[\.ï¼ã€]?\s*|\s*)/.test(s);

  // âœ… æ”¹è‰¯ï¼šåŒæ™‚è¾¨è­˜ã€Œï¼ˆYYYYï¼‰ã€èˆ‡ã€Œï¼ˆYYYYå¹´MæœˆDæ—¥ï¼‰ã€èˆ‡ã€Œï¼ˆç„¡æ—¥æœŸ/n.d.ï¼‰ã€
  // - é–‹é ­å…è¨±ä¸­è‹±ä½œè€…/æ©Ÿæ§‹å
  // - æ‹¬è™Ÿå…§å…è¨±ï¼šYYYYã€YYYYå¹´Mæœˆã€YYYYå¹´MæœˆDæ—¥ã€ç„¡æ—¥æœŸã€n.d.
  const isNewByAuthorYear = s => {
    const re = /^[\s\u3000]*[\u4e00-\u9fa5A-Za-z].{0,60}[ï¼ˆ(]\s*(?:\d{4}(?:\s*å¹´\s*\d{1,2}\s*æœˆ(?:\s*\d{1,2}\s*æ—¥)?)?|ç„¡æ—¥æœŸ|n\.?d\.?)\s*[)ï¼‰]/;
    return re.test(s);
  };

  const isContinuation = s =>
    /^\s{2,}/.test(s) || /^[\u3000]+/.test(s) ||
    /^(https?:\/\/|www\.|doi\.org|doi:|å–è‡ª|Available at|ç¶²å€)/i.test(s) ||
    /^[-â€“â€¢ï¼Â·â—]/.test(s) ||
    /^([a-z0-9-]+\.)+[a-z]{2,}(?:[\/?#:].*)?$/i.test(s) ||
    /^\/[^\s]/.test(s) ||
    SHORT_DOMAINS.test(s);

  const isUrlOnly = s => /^\s*(https?:\/\/|www\.|doi\.org\/)\S+\s*$/i.test(s);
  const isBlank   = s => !s || !s.trim();

  for (let raw of rawLines) {
    const s = (raw || '').trim();

    // é¡åˆ¥å°æ¨™ â†’ ç•¥é
    if (_isCategoryHeader(s)) continue;

    // ã€Œç´”ç©ºè¡Œã€ï¼šè‹¥ç›®å‰æœ‰åœ¨ç´¯ç©æ¢ç›®ï¼Œè¦–ç‚ºã€Œæ¢ç›®çµæŸã€
    if (isBlank(s)) {
      if (cur) { entries.push(cur.trim()); cur = ''; }
      continue;
    }

    // å»æ‰é–‹é ­ç·¨è™Ÿï¼ˆ1 / ä¸€ / ï¼ˆä¸€ï¼‰ï¼‰å¾Œé¢ã€Œå¯æœ‰æ¨™é»ã€æˆ–è‡³å°‘ 1 å€‹ç©ºç™½ã€
   const base = s.replace(
     /^[\s\u3000]*(?:[ï¼ˆ(]?\s*(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]{1,4})\s*[)ï¼‰]?)\s*(?:[\.ï¼ã€]\s*|\s{1,})/,
     ''
   ).trim();

    // æ²’åœ¨ç´¯ç©ä¸”é‡åˆ°ç´”ç¶²å€ â†’ ç•¥é
    if (!cur && isUrlOnly(s)) continue;

    // åˆ¤æ–·æ˜¯å¦ã€Œæ–°æ¢ã€ï¼šæœ‰æ˜é¡¯ç·¨è™Ÿã€æˆ–åµæ¸¬åˆ° ä½œè€…(å¹´ä»½)
    const looksNew = isNewByIndex(s) || isNewByAuthorYear(s);

    if (!cur) {                // ç›®å‰æ²’æœ‰æ¢ç›®ï¼šé–‹æ–°æ¢ï¼ˆè‹¥æ˜¯ç´”ç¶²å€ï¼Œè·³éï¼‰
      cur = isUrlOnly(base) ? '' : base;
      continue;
    }

    if (looksNew) {            // å‘½ä¸­æ–°æ¢ï¼šæ”¶å‰ä¸€æ¢ã€å†é–‹æ–°æ¢
      entries.push(cur.trim());
      cur = isUrlOnly(base) ? '' : base;
      continue;
    }

    // å…¶ä»–æƒ…æ³ï¼šå»¶çºŒï¼ˆå«ç¶²å€ã€doiã€å–è‡ªâ€¦ï¼‰
    if (isContinuation(s)) {
      cur += ' ' + s;
    } else {
      // ä¸€èˆ¬æ–‡æœ¬ä½†æ²’æœ‰æ–°æ¢ç‰¹å¾µ â†’ å¤§å¤šæ˜¯åŒæ¢å»¶çºŒ
      cur += ' ' + s;
    }
  }

  if (cur) entries.push(cur.trim());

  // éæ¿¾æ‰åªæœ‰ç¶²å€çš„å‡æ¢ç›®èˆ‡å¤ªçŸ­çš„æ®˜ç‰‡
  return entries.filter(s =>
    !/^\s*(https?:\/\/|www\.|doi\.org\/)\S+\s*$/i.test(s) &&
    s.replace(/\s/g, '').length >= 6
  );
}

function _normRefKey(s) {
  return s
    .replace(/https?:\/\/(www\.)?/gi, '')   // URL å»é ­
    .replace(/[ï¼Œã€ï¼›ã€‚]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
    .toLowerCase();
}
function _dedupReferences(list) {
  const map = new Map();
  for (const e of list) {
    const k = _normRefKey(e);
    if (!map.has(k)) map.set(k, e);
  }
  return Array.from(map.values());
}

function _hasYear(text) {
  return /ï¼ˆ\d{4}|ç„¡æ—¥æœŸï¼‰|\(\d{4}\)|\b\d{4}\bå¹´|\b(19|20)\d{2}\b|\(n\.?d\.?\)/i.test(text);
}
function _textWithoutUrls(s) { return s.replace(/https?:\/\/\S+/g, '').replace(/\s+/g, ' ').trim(); }

// ==== helpers for web references (æ–°å¢) ====
// æ˜¯å¦æœ‰ã€Œï¼ˆYYYYå¹´MæœˆDæ—¥ï¼‰ã€çš„ä¸­æ–‡æ—¥æœŸï¼Œå…è¨± 1ï½2 ä½æ•¸æœˆä»½èˆ‡æ—¥æœŸ
function _hasZhDateInParens(s) {
  return /ï¼ˆ\s*\d{4}\s*å¹´\s*\d{1,2}\s*æœˆ\s*\d{1,2}\s*æ—¥\s*ï¼‰/.test(s);
}
// æ˜¯å¦æœ‰ã€Œç„¡æ—¥æœŸ + æ“·å–æ—¥æœŸã€çš„ç¶²è·¯å¯«æ³•
function _hasNoDateWithRetrieval(s) {
  const noDate = /ï¼ˆ\s*ç„¡æ—¥æœŸ\s*ï¼‰/.test(s);
  // å…è¨±ï¼šæ“·å–æ—¥æœŸï¼š2025å¹´10æœˆ12æ—¥ï¼Œå–è‡ª https://...
  const retrieved = /(æ“·å–æ—¥æœŸ\s*[:ï¼š]\s*\d{4}\s*å¹´\s*\d{1,2}\s*æœˆ\s*\d{1,2}\s*æ—¥\s*ï¼Œ\s*å–è‡ª\s*https?:\/\/\S+|å–è‡ª\s*https?:\/\/\S+|Retrieved\s+from\s+https?:\/\/\S+)/i.test(s);
  return noDate && retrieved;
}

// 1) å®‰å…¨è¼¸å‡º HTMLï¼ˆé¿å…ç ´ç‰ˆï¼‰
function _escapeHtml(s) {
  return String(s || '').replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
  }[c]));
}

// å…è¨±ã€Œç„¡ç©ºæ ¼ã€çš„ä¸­æ–‡å¯«æ³•ï¼›è‹±/ä¸­çš†å¯ï¼Œç©ºæ ¼å¯æœ‰å¯ç„¡
function _hasAuthorYearWithParen(text) {
  const s = String(text || '');
  // å…è¨±ï¼šå¼µä¸‰ï¼ˆ2001ï¼‰ã€Zhang (2001)ã€Zhang(2001)ã€ä½œè€…ï¼ˆç„¡æ—¥æœŸï¼‰
  return /[^\sï¼Œã€ã€‚]{1,40}\s*[(ï¼ˆ]\s*(\d{4}|n\.?d\.?|ç„¡æ—¥æœŸ)\s*[)ï¼‰]/i.test(s);
}
// èˆŠåç›¸å®¹ï¼šèˆŠç¨‹å¼è‹¥å‘¼å« _hasAuthorYearWithSpaceï¼Œè½‰å‘¼å«æ–°å‡½å¼
function _hasAuthorYearWithSpace(text) {
  return _hasAuthorYearWithParen(text);
}

// 3) ç¶²è·¯è³‡æ–™ã€Œå¹´æœˆæ—¥ã€èˆ‡ã€Œç„¡æ—¥æœŸï¼‹æ“·å–æ—¥æœŸã€äºŒæ“‡ä¸€ï¼›ç§»é™¤ä¸­æ–‡ç©ºæ ¼å¼·åˆ¶
function _qualifyRefStrict(s) {
  const t = String(s || '').replace(/\s+/g, ' ').trim();
  const reasons = [];

  const isWebToken = /(https?:\/\/|å–è‡ª|Available at|ç¶²å€)/i.test(t);
  const hasEbookPlatform =
    /(é›»å­æ›¸|e-?book)/i.test(t) ||
    /(hyread|ebookdrm|overdrive|read\.moo\.com|books\.google\.com\/books)/i.test(t);

  // è‹¥å‘½ä¸­ã€Œé›»å­æ›¸å¹³å°ã€å‰‡è¦–ç‚º nonwebï¼›å¦å‰‡æœ‰ç¶²å€/å–è‡ªæ‰ç•¶ web
  const kind = (isWebToken && !hasEbookPlatform) ? 'web' : 'nonweb';

  // æ™‚é–“ç›¸é—œ
  const hasYearOnly = /[(ï¼ˆ]\s*(\d{4}|n\.?d\.?|ç„¡æ—¥æœŸ)\s*[)ï¼‰]/i.test(t); // â†è£œä¸Š
  const hasZhDate   = /ï¼ˆ\s*\d{4}\s*å¹´\s*\d{1,2}\s*æœˆ\s*\d{1,2}\s*æ—¥\s*ï¼‰/.test(t);
  const hasNoDate   = /ï¼ˆ\s*ç„¡æ—¥æœŸ\s*ï¼‰/.test(t);
  const hasRetrievalToken = /(æ“·å–æ—¥æœŸ|å–è‡ª|Retrieved\s+from)/i.test(t);
  const hasNoDateWithRetrieval = hasNoDate && hasRetrievalToken;

  const authorParenOK = _hasAuthorYearWithParen(t);

  const hasSourceCue =
    /(å‡ºç‰ˆç¤¾|Publishing|Press|å‡ºç‰ˆ|æ›¸å±€|æ–‡åŒ–|åœ–æ›¸)/.test(t) ||
    /(\bVol\.?\s*\d+|\bNo\.?\s*\d+|\bpp?\.?\s*\d+[-â€“]\d+|ç¬¬\s*\d+\s*å·|ç¬¬\s*\d+\s*æœŸ|é \s*\d+[-â€“]\s*\d+)/i.test(t) ||
    /(å­¸å ±|Journal|æœŸåˆŠ|é€šè¨Š|è©•è«–|æœƒåˆŠ)/i.test(t) ||
    /(ç¢©å£«è«–æ–‡|åšå£«è«–æ–‡|å­¸ä½è«–æ–‡|Master'?s|Ph\.?D\.?|dissertation|thesis|Proceedings|ç ”è¨æœƒ|æœƒè­°è«–æ–‡)/i.test(t) ||
    /(æ³•è¦|æ¢ä¾‹|è¾¦æ³•|å‡½é‡‹|æ•™è‚²éƒ¨|è¡›ç¦éƒ¨|è¡Œæ”¿é™¢|å„ç¸£å¸‚æ”¿åºœ)/.test(t) ||
    /(æ—¥å ±|é›»å­å ±|è¯åˆå ±|è‡ªç”±æ™‚å ±|ä¸­åœ‹æ™‚å ±|ç¶“æ¿Ÿæ—¥å ±|å¤©ä¸‹é›œèªŒ|ä»Šå‘¨åˆŠ)/.test(t) ||
    /(doi\.org|doi:)/i.test(t) || /(https?:\/\/)/i.test(t);

  // â€”â€” è¦å‰‡ â€”â€”ï¼ˆé€™è£¡åªä¿ç•™ä¸€çµ„ if/elseï¼Œåˆªæ‰å¤šé¤˜çš„ "}"ï¼‰
  if (kind === 'web') {
    if (!(hasZhDate || hasNoDateWithRetrieval)) {
      reasons.push('ç¶²è·¯/é›»å­æœŸåˆŠ/æ–°è/å¹³å°æ–‡éœ€ç”¨ã€Œå®Œæ•´å¹´æœˆæ—¥ï¼ˆYYYYå¹´MæœˆDæ—¥ï¼‰ã€ï¼›è‹¥ç„¡æ—¥æœŸï¼Œæ”¹ç”¨ã€Œï¼ˆç„¡æ—¥æœŸï¼‰æ“·å–æ—¥æœŸï¼Œå–è‡ªç¶²å€ã€ã€‚');
    }
  } else {
    if (!hasYearOnly) reasons.push('æœªåµæ¸¬åˆ°ï¼ˆå¹´ä»½ï¼‰ï¼Œè«‹è£œ 4 ä½å¹´ä»½ã€‚');
  }

  if (!authorParenOK) {
    reasons.push('ä½œè€…èˆ‡æ‹¬è™Ÿï¼ˆå¹´ä»½/æ—¥æœŸï¼‰æ ¼å¼ä¸æ˜ï¼Œè«‹ä½¿ç”¨ï¼šä½œè€…ï¼ˆå¹´ä»½ï¼‰æˆ– ä½œè€…ï¼ˆYYYYå¹´MæœˆDæ—¥ï¼‰ã€‚');
  }
  if (!hasSourceCue) {
    reasons.push('æœªåµæ¸¬åˆ°å‡ºç‰ˆ/ä¾†æºè³‡è¨Šï¼ˆå‡ºç‰ˆç¤¾ã€æœŸåˆŠ/å·æœŸé ã€æ³•è¦ã€DOI æˆ–ç¶²å€â€¦ï¼‰ã€‚');
  }

// ç¦ç”¨ã€Šã€‹ã€Šã€‹èˆ‡ã€ˆã€‰ï¼ˆæ•´é«”è¦ç¯„ä¸ä½¿ç”¨ï¼›blog ä¹Ÿä¸è¦æ‹¬è™Ÿï¼Œåªåœ¨æ¨™é¡Œå¾ŒåŠ æ¨™ç±¤ï¼‰
  if (/[ã€Šã€‹ã€ˆã€‰]/.test(t)) {
    reasons.push('åƒè€ƒæ–‡ç»ä¸­çš„æ›¸åã€ç¯‡åã€æœŸåˆŠã€å‡ºç‰ˆç¤¾èˆ‡ä¾†æºï¼Œä¸éœ€ä½¿ç”¨ã€Šã€‹ã€Šã€‹æˆ–ã€ˆã€‰æ‹¬è™Ÿã€‚');
  }

// Blog ä¾‹å¤–ï¼šéœ€åœ¨æ¨™é¡Œå¾Œæ–¹åŠ ï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½
  const looksBlog = /(éƒ¨è½æ ¼|blog)/i.test(t) ||
                  /(blogspot|wordpress|pixnet|medium\.com|pinkoi\.com\/tw\/|blogs?\.)/i.test(t);
  if (looksBlog && !/ï¼»\s*éƒ¨è½æ ¼æ–‡ç« \s*ï¼½/.test(t)) {
    reasons.push('éƒ¨è½æ ¼æ–‡ç« éœ€åœ¨æ¨™é¡Œå¾ŒåŠ ï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½ã€‚');
}

const maybeHasJournal = /(å­¸å ±|æœŸåˆŠ|é›œèªŒ|ç‰¹åˆŠ|å­£åˆŠ|æœˆåˆŠ|é€±åˆŠ)/.test(t);
if (maybeHasJournal) {
  reasons.push('ã€æç¤ºã€‘æ›¸åã€æœŸåˆŠåã€å·æˆ–æœŸæ‡‰ä»¥ç²—é«”å‘ˆç¾ã€‚PDF è§£æç„¡æ³•è‡ªå‹•åˆ¤æ–·ï¼Œè«‹äººå·¥ç¢ºèªã€‚');
}

  const ok = reasons.length === 0;
  const rule_hits = { kind, hasYearOnly, hasZhDate, hasNoDateWithRetrieval, authorParenOK, hasSourceCue };
  return { ok, reasons, kind, text: s, rule_hits };
}

// å–®ç­†åƒè€ƒæ–‡ç»æ˜¯å¦ã€ŒåŸºæœ¬åˆæ ¼ã€ï¼šä¾›çµ±è¨ˆ/åˆ†é¡ç”¨ï¼ˆåš´æ ¼åŸå› èˆ‡ rule_hits ç”± _qualifyRefStrict ç”¢ï¼‰

function _isQualifiedRef(item) {
  // å…ˆåšåŸºç¤æ¸…ç†
  const s = String(item || '').replace(/\s+/g, ' ').trim();

  // é›»å­æ›¸/å¹³å°ï¼ˆè¦–åŒéç¶²è·¯å‡ºç‰ˆä¹‹è­‰æ“šï¼‰
  const hasEbookPlatform =
  /(é›»å­æ›¸|e-?book)/i.test(s) ||
  /(hyread|ebookdrm|overdrive|read\.moo\.com|books\.google\.com\/books)/i.test(s);
  
  // ===== éç¶²è·¯å‡ºç‰ˆé¡çš„ç·šç´¢ï¼ˆå‘½ä¸­å³è¦–ç‚ºæœ‰ã€Œå‡ºç‰ˆè­‰æ“šã€ï¼‰=====
  const hasPublisher =
    /(å‡ºç‰ˆç¤¾|Press\b|Publishing|å‡ºç‰ˆ|æ–‡åŒ–|æ›¸å±€|åœ–æ›¸).{0,12}$/.test(s) ||
    /(éº¥æµ©æ–¯|éº¥å…‹æ–¯|é æµ|å¤©ä¸‹æ–‡åŒ–|è¯ç¶“|ä¸‰æ°‘|äº”å—|é«˜å¯¶|æ™‚å ±æ–‡åŒ–|å•†å‘¨|è¦ªå­å¤©ä¸‹|è¯åˆæ–‡å­¸|æ˜¥å¤©|æœ¨é¦¬æ–‡åŒ–|å¤§å¡Šæ–‡åŒ–|å…¸è—è—è¡“).{0,12}$/.test(s);

  const hasJournalMeta =
    /(\bVol\.?\s*\d+|\bNo\.?\s*\d+|\bpp?\.?\s*\d+[-â€“]\d+|ç¬¬\s*\d+\s*å·|ç¬¬\s*\d+\s*æœŸ|é \s*\d+[-â€“]\d+)/i.test(s) ||
    /(Journal|æœŸåˆŠ|å­¸å ±|é€šè¨Š|è©•è«–|æœƒåˆŠ).{0,40}\d{4}/i.test(s);

  const hasThesisOrConf = /(ç¢©å£«è«–æ–‡|åšå£«è«–æ–‡|å­¸ä½è«–æ–‡|Master'?s|Ph\.?D\.?|dissertation|thesis|Proceedings|ç ”è¨æœƒ|æœƒè­°è«–æ–‡)/i.test(s);
  const hasLawOrGov     = /(æ³•è¦|æ¢ä¾‹|è¾¦æ³•|å‡½é‡‹|æ•™è‚²éƒ¨|è¡›ç¦éƒ¨|ä¸»è¨ˆç¸½è™•|è¡Œæ”¿é™¢|å…§æ”¿éƒ¨|å„ç¸£å¸‚æ”¿åºœ)/.test(s);
  const hasNewspaper    = /(æ—¥å ±|é›»å­å ±|è¯åˆå ±|è‡ªç”±æ™‚å ±|ä¸­åœ‹æ™‚å ±|ç¶“æ¿Ÿæ—¥å ±|è˜‹æœæ—¥å ±|å¤©ä¸‹é›œèªŒ|ä»Šå‘¨åˆŠ)/.test(s);
  const hasDOI          = /(doi\.org|doi:)/i.test(s);
  const hasAcademicPlatform =
    /(ScienceDirect|Wiley|Springer|Elsevier|Taylor & Francis|SAGE|ACM Digital Library|IEEE Xplore|Nature|Cell Press|Oxford Academic|Cambridge Core)/i.test(s);

  // å‘½ä¸­ä»¥ä¸Šä»»ä½•ä¸€å€‹ â†’ è¦–ç‚ºã€Œéç¶²è·¯ã€å‡ºç‰ˆå‹æ…‹ï¼šä»éœ€åŸºæœ¬ä½œè€…(å¹´ä»½)é–“ç©ºæ ¼
  if (hasPublisher || hasJournalMeta || hasThesisOrConf || hasLawOrGov || hasNewspaper || hasDOI || hasAcademicPlatform || hasEbookPlatform) {
    const authorYearSpaceOK = /[\u4e00-\u9fa5A-Za-zï¼ãƒ»Â·ï¼\u00A0]\s+ï¼ˆ\d{4}ï¼‰/.test(s);
    return authorYearSpaceOK;
  }


  // ===== ç¶²è·¯é¡ =====
  const hasLink = /(https?:\/\/|å–è‡ª|Available at|ç¶²å€)/i.test(s);
  if (hasLink) {
    // ç¶²è·¯è¦ç¯„ï¼šå…è¨±ã€Œä½œè€…ï¼ˆYYYYå¹´MæœˆDæ—¥ï¼‰ã€æˆ–ã€Œï¼ˆç„¡æ—¥æœŸï¼‰+ æ“·å–/å–è‡ªã€
    const hasZhDate = /ï¼ˆ\s*\d{4}\s*å¹´\s*\d{1,2}\s*æœˆ\s*\d{1,2}\s*æ—¥\s*ï¼‰/.test(s);
    const hasNoDateWithRetrieval = /ï¼ˆ\s*ç„¡æ—¥æœŸ\s*ï¼‰/.test(s) && /(æ“·å–æ—¥æœŸ|å–è‡ª|Retrieved\s+from)/.test(s);
    const authorBeforeParensHasSpace = /[\u4e00-\u9fa5A-Za-zï¼ãƒ»Â·ï¼\u00A0]\s+ï¼ˆ\s*(?:\d{4}\s*å¹´|ç„¡æ—¥æœŸ)/.test(s);
    return (hasZhDate || hasNoDateWithRetrieval) && authorBeforeParensHasSpace;
  }

  // ===== ä¿åº•ï¼šæœ‰å¹´ä»½ä¸”å…§æ–‡ï¼ˆå»æ‰ç¶²å€ï¼‰å¤ é•·ä¹Ÿçµ¦éï¼ˆèˆ‡èˆŠç‰ˆä¸€è‡´ï¼‰=====
  if (_hasYear(s) && _textWithoutUrls(s).replace(/[ï¼Œã€ï¼›ã€‚.,]/g, '').length >= 6) return true;

  return false;
}

function _classifyReference(item) {
  const s = String(item || '').trim();

  const hasEbookPlatform =
    /(é›»å­æ›¸|e-?book)/i.test(s) ||
    /(hyread|ebookdrm|overdrive|read\.moo\.com|books\.google\.com\/books)/i.test(s);

  // èˆ‡ _isQualifiedRef ä¸€è‡´çš„ã€Œå‡ºç‰ˆç¤¾/å‡ºç‰ˆå‹æ…‹ã€è­˜åˆ¥ï¼ˆé¿å…è¢«æ­¸ç‚º webï¼‰
  const hasPublisher =
    /(å‡ºç‰ˆç¤¾|Press\b|Publishing|å‡ºç‰ˆ|æ–‡åŒ–|æ›¸å±€|åœ–æ›¸|Author\s*\.$).{0,12}$/.test(s) ||
    /(éº¥æµ©æ–¯|éº¥å…‹æ–¯|é æµ|å¤©ä¸‹æ–‡åŒ–|è¯ç¶“|ä¸‰æ°‘|äº”å—|é«˜å¯¶|æ™‚å ±æ–‡åŒ–|å•†å‘¨|è¦ªå­å¤©ä¸‹|è¯åˆæ–‡å­¸|æ˜¥å¤©|æœ¨é¦¬æ–‡åŒ–|å¤§å¡Šæ–‡åŒ–|å…¸è—è—è¡“).{0,12}$/.test(s);

  const hasJournalMeta =
    /(\bVol\.?\s*\d+|\bNo\.?\s*\d+|\bpp?\.?\s*\d+[-â€“]\d+|ç¬¬\s*\d+\s*å·|ç¬¬\s*\d+\s*æœŸ|é \s*\d+[-â€“]\d+)/i.test(s) ||
    /(Journal|æœŸåˆŠ|å­¸å ±|é€šè¨Š|è©•è«–|æœƒåˆŠ).{0,40}\d{4}/.test(s);

  const hasThesisOrConf = /(ç¢©å£«è«–æ–‡|åšå£«è«–æ–‡|å­¸ä½è«–æ–‡|Master'?s|Ph\.?D\.?|dissertation|thesis|Proceedings|ç ”è¨æœƒ|æœƒè­°è«–æ–‡)/i.test(s);
  const hasLawOrGov     = /(æ³•è¦|æ¢ä¾‹|è¾¦æ³•|å‡½é‡‹|æ•™è‚²éƒ¨|è¡›ç¦éƒ¨|ä¸»è¨ˆç¸½è™•|è¡Œæ”¿é™¢|å…§æ”¿éƒ¨|å„ç¸£å¸‚æ”¿åºœ)/.test(s);
  const hasNewspaper    = /(æ—¥å ±|é›»å­å ±|è¯åˆå ±|è‡ªç”±æ™‚å ±|ä¸­åœ‹æ™‚å ±|ç¶“æ¿Ÿæ—¥å ±|è˜‹æœæ—¥å ±|å¤©ä¸‹é›œèªŒ|ä»Šå‘¨åˆŠ)/.test(s);
  const hasDOI          = /(doi\.org|doi:)/i.test(s);
  const hasAcademicPlatform =
    /(ScienceDirect|Wiley|Springer|Elsevier|Taylor & Francis|SAGE|ACM Digital Library|IEEE Xplore|Nature|Cell Press|Oxford Academic|Cambridge Core)/i.test(s);

  if (hasPublisher || hasJournalMeta || hasThesisOrConf || hasLawOrGov || hasNewspaper || hasDOI || hasAcademicPlatform || hasEbookPlatform) {
  return 'nonweb';
  }

  const hasLink = /(https?:\/\/|å–è‡ª|Available at|ç¶²å€)/i.test(s);
  if (hasLink) return 'web';

  // å…¶é¤˜ä¿å®ˆæ­¸é¡ nonwebï¼ˆè·Ÿä½ åŸé‚è¼¯ä¸€è‡´ï¼‰
  return 'nonweb';
}

// å–å¾—ã€Œåˆ°æ—¥ã€çš„ä¸­æ–‡æ—¥æœŸï¼›æŠ“ä¸åˆ°å‚³å› null
function extractFullZhDate(s){
  const m = /ï¼ˆ\s*(\d{4})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥\s*ï¼‰/.exec(s);
  return m ? `${+m[1]}å¹´${+m[2]}æœˆ${+m[3]}æ—¥` : null;
}

// ç”¢ç”Ÿã€Œç¤ºç¯„ç”¨ã€çš„æ­£ç¢ºæ—¥æœŸç‰‡æ®µï¼ˆä¸€å®šåˆ°æ—¥ï¼›æŠ“ä¸åˆ°å°±æç¤ºè£œæ—¥ï¼‰
function makeZhDateForExample(sourceText){
  const full = extractFullZhDate(sourceText);
  if (full) return `ï¼ˆ${full}ï¼‰`;
  const ym = /ï¼ˆ\s*(\d{4})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*ï¼‰/.exec(sourceText);
  const y  = /ï¼ˆ\s*(\d{4})\s*ï¼‰/.exec(sourceText);
  if (ym) return `ï¼ˆ${ym[1]}å¹´${ym[2]}æœˆã€Œè«‹è£œæ—¥æœŸã€æ—¥ï¼‰`;
  if (y)  return `ï¼ˆ${y[1]}å¹´ã€Œè«‹è£œæœˆä»½èˆ‡æ—¥æœŸã€ï¼‰`;
  return 'ï¼ˆã€Œè«‹è£œå®Œæ•´å¹´æœˆæ—¥ã€ï¼‰';
}

// å»æ‰ã€Šã€‹ã€ˆã€‰ï¼›è‹¥ç‚º blog ä¸”æœªæ¨™è¨»å°±åœ¨æ¨™é¡Œå¾Œè£œï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½
function sanitizeTitleAndSource(str){
  let out = String(str || '').replace(/[ã€Šã€‹ã€ˆã€‰]/g, '');
  const isBlog = /(éƒ¨è½æ ¼|blog)/i.test(out) ||
                 /(blogspot|wordpress|pixnet|medium\.com|pinkoi\.com\/tw\/|blogs?\.)/i.test(out);
  const hasBlogTag = /ï¼»\s*éƒ¨è½æ ¼æ–‡ç« \s*ï¼½/.test(out);
  if (isBlog && !hasBlogTag) {
    // åœ¨æœ€å¾Œä¸€å€‹å…¨å½¢å¥é»å‰è£œä¸Šæ¨™ç±¤ï¼ˆæ²’æœ‰å¥é»å°±ç›´æ¥åŠ åœ¨çµå°¾ï¼‰
    if (/ã€‚/.test(out)) out = out.replace(/ã€‚(?!.*ã€‚)/, 'ï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½ã€‚');
    else out += 'ï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½';
  }
  return out;
}

/* ===== ä¿®æ­£ç¤ºä¾‹ç”¢ç”Ÿå™¨ï¼ˆå«ç²—é«”å‘ˆç¾ï¼‰ ===== */
function buildRefFixExample(rawText) {
  if (!rawText) return "";

  let s = String(rawText).trim();

  // â‘  ç§»é™¤ã€Šã€‹ã€Šã€‹ã€ˆã€‰ç¬¦è™Ÿ
  s = s.replace(/[ã€Šã€‹ã€ˆã€‰]/g, "");

  // â‘¡ è‹¥ç‚ºéƒ¨è½æ ¼æ–‡ç« ï¼ŒåŠ ä¸Šï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½
  const isBlog =
    /(éƒ¨è½æ ¼|blog|wordpress|pixnet|medium\.com|pinkoi\.com\/tw\/|blogs?\.)/i.test(s);
  if (isBlog && !/ï¼»\s*éƒ¨è½æ ¼æ–‡ç« \s*ï¼½/.test(s)) {
    s = s.replace(/(ã€‚|ï¼)/, "ï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½$1");
  }

  // â‘¢ è‹¥æ˜¯ç¶²é æ–‡ä½†ç¼ºå®Œæ•´å¹´æœˆæ—¥ â†’ æ”¹ç‚ºã€Œï¼ˆç„¡æ—¥æœŸï¼‰æ“·å–æ—¥æœŸã€
  if (/(http|https):\/\//.test(s) && !/\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/.test(s)) {
    s = s.replace(/ï¼ˆ\d{4}å¹´\d{1,2}æœˆ?ï¼‰?/, "ï¼ˆç„¡æ—¥æœŸï¼‰");
    if (!/æ“·å–æ—¥æœŸ/.test(s)) {
      s += "æ“·å–æ—¥æœŸï¼Œå–è‡ªç¶²å€ã€‚";
    }
  }

  // â‘£ å»ºç«‹ç¤ºä¾‹å‰çš„æ¨™æº–åŒ–ï¼ˆæ¸…ç©ºå¤šé¤˜ç©ºç™½ï¼‰
  s = s.replace(/\s+/g, " ").trim();

  // â‘¤ è®“ç•«é¢ä¸Šé¡¯ç¤ºç²—é«”ï¼ˆæ›¸åã€æœŸåˆŠåã€å·æœŸç­‰ï¼‰
  s = boldExampleFields(s);

  return s;
}

/* ===== å°‡æœŸåˆŠåèˆ‡å·æœŸåŠ ç²—ï¼ˆåƒ…ç•«é¢é¡¯ç¤ºç”¨ï¼‰ ===== */
function boldExampleFields(text) {
  let s = String(text || "");

  // æœŸåˆŠæˆ–æ›¸åå¸¸è¦‹é—œéµå­—ï¼Œä¾‹å¦‚ã€Œå­¸å ±ã€ã€ŒæœŸåˆŠã€ã€Œå­£åˆŠã€ã€Œé›œèªŒã€ã€Œç‰¹åˆŠã€ç­‰
  s = s.replace(
    /ã€‚([^ã€‚ï¼Œâ€œâ€]+?(?:æœŸåˆŠ|å­¸å ±|é›œèªŒ|é€šè¨Š|è©•è«–|æœƒåˆŠ|ç‰¹åˆŠ|å­£åˆŠ|æœˆåˆŠ|é€±åˆŠ|å­£å ±|å¹´å ±)[^ï¼Œã€‚]*)ï¼Œ/,
    (m, name) => `ã€‚<b>${name.trim()}</b>ï¼Œ`
  );

  // å·æœŸï¼šä¾‹å¦‚ 45(2)ã€121ã€ç¬¬52æœŸã€ç¬¬12å·
  s = s.replace(
    /([ï¼Œã€]\s*)(\d+\s*\(\s*\d+\s*\))/,
    (m, sep, v) => `${sep}<b>${v.replace(/\s+/g, "")}</b>`
  );
  s = s.replace(
    /([ï¼Œã€]\s*)(\d{1,4})(?=\s*[ï¼Œã€])/,
    (m, sep, v) => `${sep}<b>${v}</b>`
  );
  s = s.replace(/(ç¬¬\s*\d+\s*å·|ç¬¬\s*\d+\s*æœŸ)/g, (m) =>
    `<b>${m.replace(/\s+/g, "")}</b>`
  );

  return s;
}

/* ===== è‹¥è¤‡è£½ç¤ºä¾‹åˆ°å‰ªè²¼ç°¿ï¼šè½‰ç‚ºç´”æ–‡å­—ï¼ˆç²—é«”â†’(ç²—é«”)ï¼‰ ===== */
function stripHtmlForClipboard(htmlText) {
  return String(htmlText || "")
    .replace(/<b>(.*?)<\/b>/g, "$1")
    .replace(/<\/?[^>]+>/g, "");
}

/* ===== æç¤ºå¼è¦å‰‡ï¼šåœ¨ _qualifyRefStrict() è£¡åŠ å…¥ ===== */
// åœ¨ _qualifyRefStrict() çµå°¾å‰ (const ok = reasons.length === 0;) ä¸Šæ–¹åŠ å…¥ï¼š
/*
const maybeHasJournal = /(å­¸å ±|æœŸåˆŠ|é›œèªŒ|ç‰¹åˆŠ|å­£åˆŠ|æœˆåˆŠ|é€±åˆŠ)/.test(t);
if (maybeHasJournal) {
  reasons.push('ã€æç¤ºã€‘æ›¸åã€æœŸåˆŠåã€å·æˆ–æœŸæ‡‰ä»¥ç²—é«”å‘ˆç¾ï¼ˆPDF è§£æç„¡æ³•è‡ªå‹•åˆ¤æ–·ï¼Œè«‹äººå·¥ç¢ºèªï¼‰ã€‚');
}
*/


// å°‡å–®ä¸€åƒè€ƒæ–‡ç»åšç´°éƒ¨ç¨½æ ¸ï¼Œå›å‚³å¯åºåˆ—åŒ–ç‰©ä»¶
function auditReference(text, idx) {
  const s = String(text || '').trim();

  // å…ˆå»º reasonsï¼Œå¾Œé¢æ‰ push
  const reasons = [];

  // å„å­æª¢æŸ¥ï¼ˆèˆ‡ä½ çš„ç¾æœ‰è¦å‰‡å°é½Šï¼‰
  const hasYear =
    /[ï¼ˆ(]\s*(\d{4}|ç„¡æ—¥æœŸ|n\.?d\.?)(?:\s*[å¹´\/\.\-]\s*\d{1,2}(?:\s*[æœˆ\/\.\-]\s*\d{1,2}(?:\s*æ—¥)?)?)?\s*[)ï¼‰]/i.test(s) ||
    /\b(19|20)\d{2}å¹´/.test(s); // æ”¯æ´ (2018å¹´12æœˆ18æ—¥)

  const isOrgAuthor = /(?:æ”¿åºœ|éƒ¨|ç½²|è™•|æœƒ|åŸºé‡‘æœƒ|ç ”ç©¶é™¢|å­¸æœƒ|å§”å“¡æœƒ|å­¸æ ¡|å¤§å­¸|é«˜ä¸­|åœ‹ä¸­|åœ‹å°|å…¬å¸|è‚¡ä»½æœ‰é™å…¬å¸|é›†åœ˜|åŸºé‡‘)/.test(s.split(/[ã€‚ï¼]/)[0] || '');

  const hasAuthorYearSpace = isOrgAuthor ? true : _hasAuthorYearWithParen(s);

  const hasUrlOrDoi = /(https?:\/\/|doi\.org|doi:)/i.test(s);

  // æ›¸/æœŸåˆŠ/æœƒè­°/æ³•è¦/å ±ç´™ç­‰ä¾†æº cueï¼ˆä½ çš„ _isQualifiedRef äº¦æœƒç”¨åˆ°ï¼‰
  const hasPublisher = /(å‡ºç‰ˆç¤¾|Press\b|Publishing|å‡ºç‰ˆ|å°åŒ—å¸‚|æ–°åŒ—å¸‚|é«˜é›„å¸‚).{0,10}$/.test(s);
  const hasJournalLike =
    /ã€‚\s*[^ï¼Œã€‚]{2,30}ï¼Œ\s*(ç¬¬?\s*\d+\s*å·)?\s*(ç¬¬?\s*\d+\s*æœŸ|\(\s*\d+\s*\))?[^ã€‚]*(\d+\s*[-â€“]\s*\d+|pp?\.\s*\d+)/.test(s) ||
    /ã€‚\s*[^ï¼Œã€‚]{2,30}\s*[ï¼ˆ(]\s*\d+\s*[)ï¼‰]\s*[ã€‚ï¼]?/.test(s);
  const hasThesisOrConf = /(ç¢©å£«è«–æ–‡|åšå£«è«–æ–‡|å­¸ä½è«–æ–‡|Master'?s|Ph\.?D\.?|dissertation|thesis|Proceedings|ç ”è¨æœƒ|æœƒè­°è«–æ–‡)/i.test(s);
  const hasLawOrGov     = /(æ³•è¦|æ¢ä¾‹|è¾¦æ³•|å‡½é‡‹|æ•™è‚²éƒ¨|è¡›ç¦éƒ¨|ä¸»è¨ˆç¸½è™•|è¡Œæ”¿é™¢|å…§æ”¿éƒ¨|å„ç¸£å¸‚æ”¿åºœ)/.test(s);
  const hasNewspaper    = /(æ—¥å ±|é›»å­å ±|è¯åˆå ±|è‡ªç”±æ™‚å ±|ä¸­åœ‹æ™‚å ±|ç¶“æ¿Ÿæ—¥å ±|è˜‹æœæ—¥å ±|å¤©ä¸‹é›œèªŒ|ä»Šå‘¨åˆŠ)/.test(s);
  const hasAcademicPlatform =
    /(ScienceDirect|Wiley|Springer|Elsevier|Taylor & Francis|SAGE|ACM Digital Library|IEEE Xplore|Nature|Cell Press|Oxford Academic|Cambridge Core)/i.test(s);

  const hasSourceCue = hasPublisher || hasJournalLike || hasThesisOrConf || hasLawOrGov || hasNewspaper || hasAcademicPlatform || hasUrlOrDoi;

  // ã€Œç²—é«”ç·šç´¢ã€ï¼šæ›¸å/æœŸåˆŠåç­‰ï¼ˆä¿å®ˆï¼šä»æ²¿ç”¨ä¾†æº cue ä½œç‚ºæ›¿ä»£ï¼‰
  const hasBoldCue = hasPublisher || hasJournalLike || hasThesisOrConf || hasNewspaper;

  // Web/Nonweb åˆ†é¡ï¼ˆæ²¿ç”¨ä½ ç¾æœ‰é‚è¼¯ï¼‰
  const kind = _classifyReference(s);

  // ç¶œåˆæ˜¯å¦åˆæ ¼ï¼ˆåš´æ ¼ç‰ˆï¼‰
  const qualified =
    hasYear &&
    hasAuthorYearSpace &&     // å€‹äººä½œè€…éœ€ç©ºæ ¼ï¼›æ©Ÿæ§‹ä½œè€…é€šé isOrgAuthor å³æ”¾è¡Œæ­¤æª¢
    hasSourceCue &&
    hasBoldCue;

// ç¶²è·¯/å¹³å°/é›»å­æœŸåˆŠ/æ–°è â†’ ä¸€å®šè¦ã€Œå¹´æœˆæ—¥ã€æˆ–ã€Œï¼ˆç„¡æ—¥æœŸï¼‰ï¼‹æ“·å–æ—¥æœŸã€
{
  const fullDateOK = _hasZhDateInParens(s);
  const noDateRetr = _hasNoDateWithRetrieval(s);
  if (kind === 'web' && !(fullDateOK || noDateRetr)) {
    reasons.push({
      code: 'WEB_DATE_INCOMPLETE',
      message: 'ç¶²è·¯/é›»å­æœŸåˆŠ/æ–°è/å¹³å°æ–‡éœ€ç”¨å®Œæ•´å¹´æœˆæ—¥ï¼ˆYYYYå¹´MæœˆDæ—¥ï¼‰ï¼›è‹¥ç„¡æ—¥æœŸï¼Œæ”¹ç”¨ã€Œï¼ˆç„¡æ—¥æœŸï¼‰æ“·å–æ—¥æœŸï¼Œå–è‡ªç¶²å€ã€ã€‚',
      suggestion: 'ä¿®æ­£ç¯„ä¾‹ï¼š' + buildRefFixExample(s),
      severity: 'error'
    });
  }
}

   // A. ç¦ç”¨ã€Šã€‹ã€Šã€‹èˆ‡ã€ˆã€‰
if (/[ã€Šã€‹ã€ˆã€‰]/.test(s)) {
  reasons.push({
    code: 'BRACKETS_FORBIDDEN',
    message: 'åƒè€ƒæ–‡ç»ä¸­çš„æ›¸åã€ç¯‡åã€æœŸåˆŠã€å‡ºç‰ˆç¤¾èˆ‡ä¾†æºï¼Œä¸éœ€ä½¿ç”¨ã€Šã€‹ã€Šã€‹æˆ–ã€ˆã€‰æ‹¬è™Ÿã€‚',
    suggestion: 'ä¿®æ­£ç¯„ä¾‹ï¼š' + buildRefFixExample(s),
    severity: 'error'
  });
}

// B. éƒ¨è½æ ¼æ–‡ç« è¦æœ‰ï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½
const looksBlog = /(éƒ¨è½æ ¼|blog)/i.test(s) || /(blogspot|wordpress|pixnet|medium\.com|pinkoi\.com\/tw\/|blogs?\.)/i.test(s);
const hasBlogTag = /ï¼»\s*éƒ¨è½æ ¼æ–‡ç« \s*ï¼½/.test(s);
if (looksBlog && !hasBlogTag) {
  reasons.push({
    code: 'BLOG_TAG_MISSING',
    message: 'éƒ¨è½æ ¼æ–‡ç« éœ€åœ¨æ¨™é¡Œå¾ŒåŠ ï¼»éƒ¨è½æ ¼æ–‡ç« ï¼½ã€‚',
    suggestion: 'ä¿®æ­£ç¯„ä¾‹ï¼š' + buildRefFixExample(s),
    severity: 'error'
  });
}

  
    // åŸå› èˆ‡å»ºè­°
  
  if (!hasYear) {
    reasons.push({
      code: 'YEAR_MISSING',
      message: 'æœªåµæ¸¬åˆ°å¹´ä»½ï¼ˆæˆ–æ ¼å¼ä¸ç¬¦ï¼‰ã€‚',
      suggestion: 'å¹´ä»½å»ºè­°ç”¨åŠå½¢æ‹¬è™Ÿï¼š (2002)ã€‚äº¦æ”¯æ´ (2018å¹´12æœˆ18æ—¥)ã€‚',
      severity: 'error'
    });
  }
  if (!hasAuthorYearSpace) {
    reasons.push({
      code: 'AUTHOR_YEAR_SPACE',
      message: 'å€‹äººä½œè€…èˆ‡å¹´ä»½ä¹‹é–“é ˆæœ‰ 1 å€‹ç©ºç™½ã€‚',
      suggestion: 'ä¾‹ï¼šç‹å°æ˜ (2020)ã€‚è‹¥ç‚ºæ©Ÿæ§‹ä½œè€…ï¼ˆæ•™è‚²éƒ¨ã€æŸåŸºé‡‘æœƒç­‰ï¼‰å¯ä¸éœ€æ­¤è¦å‰‡ã€‚',
      severity: 'error'
    });
  }
  if (!hasSourceCue) {
    reasons.push({
      code: 'SOURCE_CUE_MISSING',
      message: 'æœªåµæ¸¬åˆ°ä¾†æº/å‡ºç‰ˆè¨Šæ¯ï¼ˆå‡ºç‰ˆç¤¾ã€æœŸåˆŠã€æœƒè­°ã€æ³•è¦ã€å ±ç´™ã€å­¸è¡“å¹³å°æˆ– URL/DOIï¼‰ã€‚',
      suggestion: 'æ›¸ç±ï¼šè£œã€Œæ›¸åã€å‡ºç‰ˆåœ°ã€å‡ºç‰ˆç¤¾ã€ï¼›æœŸåˆŠï¼šè£œã€ŒæœŸåˆŠåã€å·(æœŸ)ã€é ç¢¼ã€ï¼›ç¶²é ï¼šè‡³å°‘è¦æœ‰ç¶²å€æˆ– DOIã€‚',
      severity: 'error'
    });
  }
  if (!hasBoldCue) {
    reasons.push({
      code: 'BOLD_CUE_MISSING',
      message: 'æ›¸åï¼æœŸåˆŠåç­‰æ‡‰ä»¥ç²—é«”è¡¨ç¤ºï¼Œä½†æœªåµæ¸¬åˆ°ç›¸é—œæ¨£å¼æˆ–å‡ºç‰ˆç·šç´¢ã€‚',
      suggestion: 'è«‹å°‡æ›¸åã€æœŸåˆŠåã€å·æœŸè³‡è¨ŠåŠ ç²—ï¼ˆBoldï¼‰ï¼Œä¾‹å¦‚å•†æ¥­å‘¨åˆŠã€ç¬¬5å·(2æœŸ)éœ€ä»¥ç²—é«”é¡¯ç¤ºã€‚',
      severity: 'warn'
    });
  }

  // å¤ªçŸ­åˆæ²’æœ‰ä»»ä½•ç·šç´¢çš„å…œåº•
  if (_textWithoutUrls(s).replace(/[ï¼Œã€ï¼›ã€‚.,]/g, '').length < 8 && reasons.length === 0) {
    reasons.push({
      code: 'TOO_WEAK',
      message: 'æ–‡å­—éçŸ­ä¸”ç¼ºä¹æœ‰æ•ˆç·šç´¢ï¼Œé›£ä»¥åˆ¤å®šã€‚',
      suggestion: 'è£œå…¨ä½œè€…ã€å¹´ä»½ã€é¡Œåèˆ‡ä¾†æºã€‚',
      severity: 'warn'
    });
  }

  return {
    index: idx,
    text: s,
    qualified,
    checks: {
      hasYear, hasAuthorYearSpace, hasSourceCue, hasBoldCue, isOrgAuthor, hasUrlOrDoi, kind
    },
    reasons
  };
}

/* ===== åœ–è¡¨æª¢æŸ¥å‡ç´šï¼šå·¥å…·å¸¸æ•¸èˆ‡å‡½å¼ï¼ˆæ–°å¢ï¼‰ ===== */

// æ”¯æ´æ›´å¤šåœ–è¡¨æ¨™è™Ÿæ¨£å¼ï¼ˆå…¨å½¢ç©ºç™½ã€æ··åˆç©ºç™½ã€å„å¼æ¨™é»ï¼‰
const CN_NUM = '[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ]+';
const AR_NUM = '\\d+';
const FIGTAB_LABEL = new RegExp(
  '(^|\\n|[\\s\\u3000])' + '(åœ–|è¡¨)' + '[\\s\\u3000]*' +
  '(' + AR_NUM + '|' + CN_NUM + ')' + '[\\s\\u3000]*[ï¼š:ã€ï¼\\.]',
  'g'
);

// ä¾†æºè©å½™
const SOURCE_LABEL = /(è³‡æ–™ä¾†æº[:ï¼š]|åœ–ç‰‡ä¾†æº[:ï¼š]|å‡ºè™•[:ï¼š]|ä¾†æº[:ï¼š])/;

// åœ–/è¡¨é™„è¿‘è¦–çª—
const WINDOW_BEFORE = 0;
const WINDOW_AFTER  = 400;
const WINDOW_EXTRA  = 200;

// è‡ªè£½/è‡ªç¹ªç­‰è‡ªæˆ‘ä¾†æºï¼ˆå…æ¯”å°åƒè€ƒæ–‡ç»ï¼‰
const SELF_MADE = /(ä½œè€…è‡ª(è£½|ç¹ª|æ”|æ•´ç†)|è‡ªè£½|è‡ªè¡Œ(ç¹ªè£½|æ•´ç†|æ”å½±)|ç ”ç©¶è€…è‡ªè£½|è‡ªè¡Œè£½ä½œ)/;

// æ”¯æ´æ›´å¤šåœ–è¡¨æ¨™è™Ÿæ¨£å¼ï¼ˆå…¨å½¢ç©ºç™½ã€æ··åˆç©ºç™½ã€å„å¼æ¨™é»ï¼‰

// ä¾†æºè©å½™ï¼ˆæ“´å……ï¼‰

// åœ–/è¡¨é™„è¿‘è¦–çª—ï¼ˆè·¨é å®¹éŒ¯æ‹‰å¤§ï¼‰
       // åš´æ ¼åªçœ‹ä¸‹æ–¹
     // å‘å¾Œ 400 å­—
     // å†å‘å¾Œå»¶ä¼¸ï¼ˆé¿å…æ›è¡Œ/è·¨é ï¼‰

// è‡ªè£½/è‡ªç¹ªç­‰è‡ªæˆ‘ä¾†æºï¼ˆå…æ¯”å°åƒè€ƒæ–‡ç»ï¼‰


/** å–å‡ºã€Œå°±è¿‘çš„ä¾†æºè¡Œã€ï¼šåªåœ¨åœ–/è¡¨ *ä¸‹æ–¹* è¦–çª—å…§æ‰¾ä¾†æºè©å½™ */
function _extractNearbySource(fullText, startIdx) {
  const from = Math.max(0, startIdx - WINDOW_BEFORE);
  const to   = Math.min(fullText.length, startIdx + WINDOW_AFTER + WINDOW_EXTRA);
  const slice = fullText.slice(from, to);

  // åªå–ã€Œåœ–è¡¨ä¹‹å¾Œã€çš„å…§å®¹
  const after = slice.slice(Math.min(slice.length, startIdx - from));

  // æ‰¾ç¬¬ä¸€å€‹ä¾†æºè©å½™
  const m = after.match(SOURCE_LABEL);
  if (!m) return null;

  // ä¾†æºè©å½™èµ·é»åœ¨ after çš„å“ªè£¡ï¼Ÿ
  const pos = after.search(SOURCE_LABEL);
  if (pos < 0) return null;

  // æŠ“è©²è¡Œåˆ°è¡Œå°¾ï¼ˆæˆ–ä¸‹ä¸€å€‹æ–·è¡Œï¼‰
  const tail = after.slice(pos);
  const line = tail.split(/\r?\n/)[0].trim();

  // æ‹¿æ‰æ¨™ç±¤ï¼ˆè³‡æ–™ä¾†æºï¼šï¼‰ä¿ç•™å…§å®¹
  const content = line.replace(SOURCE_LABEL, '').trim();

  return {
    label: line,              // å«ã€Œè³‡æ–™ä¾†æºï¼šã€æ•´è¡Œ
    content,                  // å»æ‰æ¨™ç±¤çš„å…§å®¹
    hasSelfMade: SELF_MADE.test(line)
  };
}

/** æª¢æŸ¥ã€Œå°±è¿‘ç‰‡æ®µã€æ˜¯å¦å­˜åœ¨ä½œè€…â€“å¹´ä»½åˆ¶ï¼ˆè¦–ç‚ºå…§åµŒä¾†æºï¼‰ */
function _hasInlineCiteNearby(fullText, startIdx) {
  const from = Math.max(0, startIdx - 80);
  const to   = Math.min(fullText.length, startIdx + 200);
  const slice = fullText.slice(from, to);
  // ï¼ˆç‹å°æ˜ï¼Œ2023ï¼‰æˆ– ç‹å°æ˜ï¼ˆ2023ï¼‰æˆ– ç„¡æ—¥æœŸ/n.d.
  const INLINE = /(ï¼ˆ[^ï¼Œ\n]{1,12}ï¼Œ\s*(\d{4}|ç„¡æ—¥æœŸ)ï¼‰|[^\sï¼Œã€]{1,12}ï¼ˆ\s*(\d{4}|n\.?d\.?)ï¼‰)/;
  return INLINE.test(slice);
}

/** åˆ¤æ–·ä¾†æºè¡Œçœ‹èµ·ä¾†åƒã€Œå®Œæ•´åƒè€ƒæ–‡ç»ã€ */
function _looksLikeFullReference(line) {
  const s = line || '';
  const hasYear = _hasYear(s);
  const hasMeta = /(å‡ºç‰ˆç¤¾|Publishing|Press|ç¬¬\s*\d+\s*å·|ç¬¬\s*\d+\s*æœŸ|é \s*\d+|Vol\.?|No\.?|pp?\.?|doi\.org|https?:\/\/)/i.test(s);
  return hasYear && hasMeta;
}

/** å˜—è©¦æŠŠä¾†æºè¡Œï¼ˆå·²å»é™¤ã€Œè³‡æ–™ä¾†æºï¼šã€ï¼‰å°æ‡‰åˆ°ã€Œé™¸ã€åƒè€ƒæ–‡ç»ã€æ¸…å–® */
function _matchSourceToRefs(srcContent, refEntries) {
  if (!srcContent) return { matched: false, hit: null };
  const skey = _normRefKey(srcContent);
  for (const r of refEntries) {
    const rkey = _normRefKey(r);
    // äº’ç‚ºåŒ…å«å³å¯è¦–ç‚ºå°ä¸Šï¼ˆé¿å…æ¥µåš´æ ¼å®Œå…¨ä¸€è‡´ï¼‰
    if (skey.includes(rkey) || rkey.includes(skey)) {
      return { matched: true, hit: r };
    }
  }
  return { matched: false, hit: null };
}

/* ===== æ–‡å­—è¦å‰‡ï¼ˆåªæœ‰ç¬¬11ã€12é …å«å¾®èª¿ï¼‰ ===== */
function runTextRules(pageTexts){
  const pages = pageTexts.length - 1 || 1;
  const fullText = pageTexts.slice(1).join('\n\n[[PAGE_SPLIT]]\n\n');

  // å…ˆæ‰¾å‡ºã€Œé™¸ã€åƒè€ƒæ–‡ç»ã€çš„èµ·é»ï¼Œæ¥è‘—åˆ‡å‡ºåªåŒ…å«ã€Œåƒè€ƒæ–‡ç»ä¹‹å‰ã€çš„æ­£æ–‡æ–‡å­—
  const refIdx = _findRefStart(fullText);
  const bodyText = (refIdx >= 0) ? fullText.slice(0, refIdx) : fullText;


  // å…­æ®µè½
  const sec=RULES.sixSections;
  const idx=sec.map(s=>fullText.indexOf(s)); const hasAll=idx.every(i=>i>=0); const inOrder=hasAll && idx.join(',')===idx.slice().sort((a,b)=>a-b).join(',');
  addRow('å…­å¤§æ®µè½ä¾åº',hasAll&&inOrder,hasAll?(inOrder?'é †åºæ­£ç¢º':'æ‰¾åˆ°å„æ®µè½ä½†é †åºéŒ¯èª¤'):'æœ‰æ®µè½ç¼ºå¤±','è«‹è£œé½Šä¸¦æŒ‰è¦å®šé †åºæ’åˆ—ï¼š'+sec.join(' â†’ '));

    // ä½œè€…-å¹´ä»½ï¼ˆåªç®—ã€Œåƒè€ƒæ–‡ç»ã€ä¹‹å‰çš„æ­£æ–‡ï¼‰
  // ï¼ï¼æ–°å¢ï¼šæ”¯æ´å¤šä½œè€…ï¼ˆä¸­æ–‡ç”¨ã€Œã€ã€æˆ–ã€Œå’Œã€ï¼Œè‹±æ–‡ç”¨ â€œ,â€ / â€œandâ€ / â€œ&â€ï¼‰ã€ä»¥åŠã€Œç­‰ / et al.ã€ï¼ï¼

  // 1) ä¸­æ–‡æ‹¬è™Ÿå…§ï¼š ï¼ˆä½œè€…ã€ä½œè€…ï¼Œå¹´ä»½ï¼‰ / ï¼ˆä½œè€… ç­‰ï¼Œå¹´ä»½ï¼‰ / ï¼ˆæ©Ÿæ§‹ï¼Œç„¡æ—¥æœŸï¼‰
  const citeParenZhSingle =
    /ï¼ˆ[^ï¼Œ\n()]{1,40}(?:ç­‰)?ï¼Œ\s*(\d{4}|ç„¡æ—¥æœŸ|n\.?d\.?)ï¼‰/g;
  const citeParenZhMulti =
    /ï¼ˆ[^ï¼Œ\n()]{1,20}(?:ã€|å’Œ)[^ï¼Œ\n()]{1,20}(?:(?:ã€|å’Œ)[^ï¼Œ\n()]{1,20}){0,6}ï¼Œ\s*(\d{4}|ç„¡æ—¥æœŸ|n\.?d\.?)ï¼‰/g;

  // 2) è‹±æ–‡æ‹¬è™Ÿå…§ï¼š (Author, Author, 2022) / (Author & Author, 2022) / (Author et al., 2022) / (Author, n.d.)
  const citeParenEnSingle =
    /\(\s*[A-Z][A-Za-z.\s'\-]{0,40}(?:et al\.)?\s*,\s*(\d{4}|n\.?d\.)\s*\)/g;
  const citeParenEnMulti =
    /\(\s*[A-Z][A-Za-z.\s'\-]{0,40}(?:\s*(?:,|and|&)\s*[A-Z][A-Za-z.\s'\-]{0,40}){1,6}\s*,\s*(\d{4}|n\.?d\.)\s*\)/g;

  // 3) ä¸­æ–‡ä½œè€…åœ¨å‰ï¼š ä½œè€…ã€ä½œè€…ï¼ˆå¹´ä»½ï¼‰ / ä½œè€… ç­‰ï¼ˆå¹´ä»½ï¼‰
  const citeLeadZhSingle =
    /[^\sï¼Œã€‚ã€]{1,20}(?:ç­‰)?ï¼ˆ\s*(\d{4}|ç„¡æ—¥æœŸ|n\.?d\.?)\s*ï¼‰/g;
  const citeLeadZhMulti =
    /[^\sï¼Œã€‚ã€]{1,20}(?:ã€|å’Œ)[^\sï¼Œã€‚ã€]{1,20}(?:(?:ã€|å’Œ)[^\sï¼Œã€‚ã€]{1,20}){0,6}ï¼ˆ\s*(\d{4}|ç„¡æ—¥æœŸ|n\.?d\.?)\s*ï¼‰/g;

  // 4) è‹±æ–‡ä½œè€…åœ¨å‰ï¼š Author, Author (2022) / Author & Author (n.d.) / Author et al. (2022)
  const citeLeadEnSingle =
    /[A-Z][A-Za-z.\s'\-]{0,40}(?:et al\.)?\s*\(\s*(\d{4}|n\.?d\.)\s*\)/g;
  const citeLeadEnMulti =
    /[A-Z][A-Za-z.\s'\-]{0,40}(?:\s*(?:,|and|&)\s*[A-Z][A-Za-z.\s'\-]{0,40}){1,6}\s*\(\s*(\d{4}|n\.?d\.)\s*\)/g;

  // çµ±ä¸€è¨ˆæ•¸ï¼ˆé¿å…é‡è¤‡ç›¸åŠ ï¼‰
  const countMatches = (re) => (bodyText.match(re)?.length || 0);
  const hasCite =
    countMatches(citeParenZhSingle) +
    countMatches(citeParenZhMulti)  +
    countMatches(citeParenEnSingle) +
    countMatches(citeParenEnMulti)  +
    countMatches(citeLeadZhSingle)  +
    countMatches(citeLeadZhMulti)   +
    countMatches(citeLeadEnSingle)  +
    countMatches(citeLeadEnMulti);

  addRow(
    'å…§æ–‡å¼•è¨»æ¡ ä½œè€…-å¹´ä»½',
    hasCite > 0,
    hasCite ? `æª¢å‡º ${hasCite} è™•ï¼ˆåƒ…çµ±è¨ˆæ­£æ–‡ï¼Œä¸å«åƒè€ƒæ–‡ç»ï¼‰` : 'æœªæª¢å‡ºå¼•è¨»æ¨£å¼',
    'è«‹ä½¿ç”¨ï¼ˆå§“åï¼Œå¹´ä»½ï¼‰æˆ– å§“åï¼ˆå¹´ä»½ï¼‰ï¼›ä¸‰äººä»¥ä¸Šå¯ç”¨ã€Œå§“Aã€å§“Bã€å§“Cï¼ˆå¹´ä»½ï¼‰ã€æˆ–ã€Œç­‰ / et al.ã€ã€‚è‹±æ–‡å¯ç”¨ and / & / et al. èˆ‡ (n.d.)ã€‚'
  );

  // ç›´æ¥å¼•æ–‡é•·åº¦
  const quotesRaw=[...(fullText.match(/ã€Œ[^ã€]{1,200}ã€/g)||[]),...(fullText.match(/â€œ[^â€]{1,200}â€/g)||[])];
  const clean=s=>s.replace(PUNCT,''); const isDirect=q=>clean(q).length>=RULES.minQuoteCharsForDirect;
  const directQuotes=quotesRaw.filter(q=>isDirect(q)), over=directQuotes.filter(q=>clean(q).length>RULES.quoteMaxChars);
  addRow(`ç›´æ¥å¼•æ–‡ â‰¤ ${RULES.quoteMaxChars} å­—ï¼ˆä¸å«æ¨™é»èˆ‡ç©ºç™½ï¼‰`,over.length===0,over.length?`è¶…æ¨™è™•ï¼š${over.length} ä¾‹`:(directQuotes.length?`OKï¼ˆåµæ¸¬ ${directQuotes.length} ä¾‹ï¼‰`:'OKï¼ˆæœªåµæ¸¬å¼•è™Ÿç‰‡æ®µï¼‰'),'å¼•è™Ÿå…§æ·¨å­—æ•¸â‰¥10æ‰è¦–ç‚ºç›´æ¥å¼•æ–‡ã€‚');

  // 8) ä¸å¾—å«æ ¡å/å§“å â€”â€” â˜…ä¿®æ­£ï¼šè·¨é æ™‚åªæª¢æŸ¥éŒ¨é»å‰åŠæ®µ
  const schoolHits=[]; const schoolPages=new Set();
  for(let p=1;p<=pages;p++){
    let t=pageTexts[p]||'';
    const pageStartOffset = fullText.indexOf(pageTexts[p]);
    if(refIdx>=0 && pageStartOffset>=refIdx) continue;
    if(refIdx>=0 && pageStartOffset < refIdx && (pageStartOffset + t.length) > refIdx){
      t = t.slice(0, refIdx - pageStartOffset);
    }
    for(const re of SCHOOL_PATTERNS){
      const m=t.match(re);
      if(m&&m.length){schoolHits.push(...m); schoolPages.add(p);}
    }
  }
  addRow('ä¸å¾—å«æ ¡å/å§“å',schoolHits.length===0,
    schoolHits.length?`åµæ¸¬åˆ°ç–‘ä¼¼æ ¡åï¼š${[...new Set(schoolHits)].join('ã€')}ï½œé æ¬¡ï¼š${[...schoolPages].join(', ')}`:'æœªç™¼ç¾',
    'è«‹å»è­˜åˆ¥åŒ–ï¼ˆä»¥ XXX å–ä»£å®Œæ•´æ ¡åï¼‰ã€‚');

  // 12) åƒè€ƒæ–‡ç»åˆ‡æ¢ + å››å±¤çµ±è¨ˆ â€”â€” â˜…ä¿®æ­£ï¼šç§»é™¤æ¨™é¡Œè¡Œ
  const refTextRaw   = refIdx >= 0 ? fullText.slice(refIdx).replace(/^(?:é™¸[ã€ï¼Œ.]?\s*)?(?:åƒè€ƒæ–‡ç»|åƒè€ƒè³‡æ–™|References)\s*[\r\n]+/i, '') : '';
  const refTextFull  = _preCleanRefText(refTextRaw);
  const MAX_REF_CHECK = Infinity;  // å…¨æª¢æŸ¥ï¼šä¸é™åˆ¶ç­†æ•¸
  let refEntries = refIdx >= 0
    ? _parseReferenceEntries(_preCleanRefText(refTextFull)).slice(0, MAX_REF_CHECK)
    : [];

  refEntries         = _dedupReferences(refEntries);

  const A_total = refEntries.length;
  const B_hasYear = refEntries.filter(s => _hasYear(s)).length;
  const C_hasLink = refEntries.filter(s => /(https?:\/\/|doi\.org|doi:|å–è‡ª|Available at|ç¶²å€)/i.test(s)).length;

  const classified = refEntries.map(s => ({ text: s, kind: _classifyReference(s) }));
  const nonwebCount = classified.filter(x => x.kind === 'nonweb').length;
  const webCount    = classified.filter(x => x.kind === 'web').length;

  const qualifiedCount   = refEntries.filter(_isQualifiedRef).length;
  const unqualifiedCount = Math.max(0, A_total - qualifiedCount);

// === åš´æ ¼é€æ¢å¯©æŸ¥ï¼ˆæ–°å¢ï¼‰ ===
const _auditList = refEntries.map((s, i) => {
  const r = _qualifyRefStrict(s);
  return { idx: i + 1, ...r };
});

const strictPass = _auditList.filter(x => x.ok).length;
const strictFail = _auditList.length - strictPass;

// ä¾› summary ä½¿ç”¨çš„æ¬¡ç´šçµ±è¨ˆï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„ A/B/C å®šç¾©ï¼‰
const hasYearCount = refEntries.filter(_hasYear).length;
const hasLinkCount = refEntries.filter(s => /(https?:\/\/|doi\.org|DOI[:ï¼š])/i.test(s)).length;

// === å°è£ JSON çµ¦ AI ï¼ˆæ–°å¢ï¼‰===
window.__refAudit = {
  stats: {
    total: _auditList.length,
    pass: strictPass,
    fail: strictFail,
    nonweb: _auditList.filter(x => x.kind === 'nonweb').length,
    web: _auditList.filter(x => x.kind === 'web').length
  },
  items: _auditList.map(it => ({
    idx: it.idx,
    text: it.text,
    qualified: it.ok,
    kind: it.kind,
    rule_hits: it.rule_hits,
    reasons: it.reasons
  }))
};

// === é€æ¢ç´°ç¯€ UIï¼ˆæ–°å¢ï¼‰===
const listHtml = _auditList.map(x => {
  return `<li data-ok="${x.ok ? '1' : '0'}">
    <b>#${x.idx}</b> ${_escapeHtml(x.text)} 
    ${x.ok ? 'âœ… <span class="ok">åˆæ ¼</span>' 
           : 'âŒ <span class="bad">ä¸åˆæ ¼</span>ï¼š' + x.reasons.map(_escapeHtml).join('ã€')}
  </li>`;
}).join('');

const detailHtml = `
  <details class="hint" style="margin-top:6px">
    <summary>é€æ¢æª¢æŸ¥ï¼ˆé»æˆ‘å±•é–‹ï¼‰</summary>
    <ol style="padding-left:22px;margin-top:6px">${listHtml}</ol>
    <div style="margin-top:8px">
      <button id="btnCopyRefAudit" class="btn btn-sm">ğŸ“‹ è¤‡è£½ä¸åˆæ ¼æ¸…å–®çµ¦ AI</button>
    </div>
  </details>
`;

// === è¦†å¯«ç¬¬ 12 é …çš„ evidence æ–‡æ¡ˆï¼ˆä»¥åš´æ ¼çµæœç‚ºä¸»ï¼‰ï¼Œå…¶é¤˜ A/B/C ä¿ç•™ ===
const evidence12_strict = 
  `ç¸½ç­†æ•¸ï¼š${_auditList.length}ï½œåˆæ ¼ï¼š${strictPass}ï½œä¸åˆæ ¼ï¼š${strictFail}` +
  `ï½œç´”ç¶²è·¯ä¾†æºï¼š${webCount}` +
  `ï½œï¼ˆA.ç¸½æ•¸ï¼š${_auditList.length}ï½œB.å«å¹´ä»½ï¼š${hasYearCount}ï½œC.å«ç¶²å€/DOIï¼š${hasLinkCount}ï¼‰`;

const sampleRefs = refEntries.slice(0, 3).map((s, i) => `${i + 1}. ${_escapeHtml(s)}`).join('<br/>');
const evidence12x = evidence12_strict + `<br/>å‰ 3 ç­†ï¼š<br/>${sampleRefs}` + detailHtml;

// === å‘¼å«ä½ ç¾æœ‰çš„ addRow ===
addRow('åƒè€ƒæ–‡ç» â‰¥ 3', _auditList.length >= 3, evidence12x,
  'ä»¥æ•´ç­†æ¢ç›®è¨ˆæ•¸ï¼ˆæ¨™é¡Œï¼‹å‡ºç‰ˆè³‡è¨Šï¼‹ç¶²å€è‹¥æ›è¡Œè¦–ç‚ºåŒä¸€æ¢ï¼‰ã€‚è‹¥ã€Œä¸åˆæ ¼ã€å­˜åœ¨ï¼Œè«‹è£œé½Šå‡ºç‰ˆè³‡è¨Šæˆ–æ–°å¢å…·å‡ºç‰ˆè­‰æ“šçš„ä¾†æºï¼Œä½¿åˆæ ¼æ•¸é”æ¨™ã€‚'
);

// === ç”¢ç”Ÿç¨½æ ¸ JSON èˆ‡è¤‡è£½æŒ‰éˆ• ===
const refAudit = refEntries.map((t, i) => auditReference(t, i + 1));
const evidence13JsonObj = {
  summary: {
    total: A_total,
    qualified: qualifiedCount,
    unqualified: unqualifiedCount,
    webCount
  },
  items: refAudit
};
const evidence13Json = JSON.stringify(evidence13JsonObj, null, 2);

// é™„åŠ ï¼šJSON èˆ‡è¤‡è£½æŒ‰éˆ•ï¼ˆä¸å½±éŸ¿æ—¢æœ‰è¡¨æ ¼ï¼‰
const jsonBox = document.createElement('div');
jsonBox.style.marginTop = '6px';
jsonBox.innerHTML = `
  <details>
    <summary class="mono" style="cursor:pointer">é¡¯ç¤ºåƒè€ƒæ–‡ç»è©³ç´°å ±å‘Šï¼ˆçµ¦ AI/é™¤éŒ¯ç”¨ï¼‰</summary>
    <div style="margin:8px 0">
      <button id="btnCopyRefJson" class="pill">è¤‡è£½æ–‡ç»è©³ç´°å ±å‘Š</button>
      <button id="btnCopyRefBad" class="pill">è¤‡è£½ã€Œä¸åˆæ ¼ã€æ–‡ç»æ¸…å–®çµ¦ AI</button>
    </div>
    <pre id="refAuditJson" style="white-space:pre-wrap;overflow:auto;max-height:280px">${evidence13Json}</pre>
  </details>
`;
// æŠŠ JSON é¢æ¿æ’åˆ°ã€ŒæŒ‰éˆ•ç¾¤ã€èˆ‡ <pre id="jsonPreview"> ä¹‹é–“
const rc = document.getElementById('resultCard');
const anchor = document.getElementById('jsonPreview');
rc.insertBefore(jsonBox, anchor);

// è¤‡è£½ JSON æŒ‰éˆ•
jsonBox.querySelector('#btnCopyRefJson').addEventListener('click', () => {
  navigator.clipboard.writeText(evidence13Json).then(() => alert('å·²è¤‡è£½ JSON'));
});

// è¤‡è£½ä¸åˆæ ¼æ¸…å–®æŒ‰éˆ•
jsonBox.querySelector('#btnCopyRefBad').addEventListener('click', () => {
  const bad = refAudit.filter(x => !x.qualified);
  const payload = bad.map(x =>
    `#${x.index}\n${x.text}\nåŸå› ï¼š\n- ${x.reasons.map(r => `${r.message}ï¼ˆå»ºè­°ï¼š${r.suggestion}ï¼‰`).join('\n- ')}`
  ).join('\n\n');
  const prompt = [
    'è«‹é€ç­†æŒ‡å‡ºä¸‹åˆ—åƒè€ƒæ–‡ç»çš„éŒ¯èª¤ä¸¦æä¾›ä¿®æ­£å¾Œç¯„ä¾‹ï¼ˆç¬¦åˆå°ç£é«˜ä¸­è·å°è«–æ–‡è¦ç¯„ï¼‰ã€‚',
    'è¦å‰‡é‡é»ï¼šå€‹äººä½œè€…éœ€ã€Œä½œè€…âµ(å¹´ä»½)ã€ã€æ›¸å/æœŸåˆŠå/å·(æœŸ)/é ç¢¼ã€å‡ºç‰ˆ/ä¾†æºç·šç´¢ï¼ˆå‡ºç‰ˆç¤¾ã€æœŸåˆŠè³‡è¨Šæˆ–ç¶²å€/DOIï¼‰ã€‚',
    '---',
    payload
  ].join('\n');
  navigator.clipboard.writeText(prompt).then(() => alert('å·²è¤‡è£½ã€Œä¸åˆæ ¼ã€æ¸…å–®èˆ‡èªªæ˜çµ¦ AI'));
});

    // åœ–è¡¨
  /* ===== åœ–è¡¨éœ€æœ‰æ¨™è™Ÿ/æ¨™é¡Œèˆ‡ä¾†æº â€”â€” å‡ç´šç‰ˆï¼ˆä¸­æ–‡æ•¸å­—ã€å…§åµŒå¼•æ³¨ã€å°ä½æ¯”å°ã€è·¨é å®¹éŒ¯ï¼‰ ===== */
  (() => {
    const entries = [];

    // é€ä¸€æ‰¾ã€Œåœ–/è¡¨ + ç·¨è™Ÿã€
    let m;
    while ((m = FIGTAB_LABEL.exec(fullText)) !== null) {
      const whole = m[0];
      const kind  = m[2];        // åœ– or è¡¨
      const idx   = m.index;

      const near = _extractNearbySource(fullText, idx);    // {label, content, hasSelfMade} | null
      const hasInline = _hasInlineCiteNearby(fullText, idx);

      const hasSourceLine = !!near;
      const isSelfMade    = !!(near && near.hasSelfMade);
      const inlineOK      = hasInline;

      let looksFullRef = false, refMatched = false, refHit = null;
      if (hasSourceLine && !isSelfMade) {
        looksFullRef = _looksLikeFullReference(near.content);
        if (looksFullRef) {
          const mres = _matchSourceToRefs(near.content, refEntries);
          refMatched = mres.matched; refHit = mres.hit;
        }
      }

      entries.push({
        kind,
        label: whole.trim(),
        index: idx,
        hasSourceLine,
        sourceLine: near?.label || '',
        sourceContent: near?.content || '',
        isSelfMade,
        inlineOK,
        looksFullRef,
        refMatched,
        refHit
      });
    }

    const totalFT = entries.length;
    const withAnySource = entries.filter(it => it.hasSourceLine || it.inlineOK || it.isSelfMade).length;
    const lackSource = totalFT > 0 && (withAnySource < totalFT);

    const anySourceTokens = (fullText.match(SOURCE_LABEL) || []).length > 0;
    const lackLabel = (totalFT === 0 && anySourceTokens);

    const figPass = totalFT === 0 ? true : (!lackSource && !lackLabel);

    const tableInlineOK    = entries.filter(it => it.kind === 'è¡¨' && it.inlineOK).length;
    const figureInlineOK   = entries.filter(it => it.kind === 'åœ–' && it.inlineOK).length;
    const sourceLineCount  = entries.filter(it => it.hasSourceLine).length;
    const selfMadeCount    = entries.filter(it => it.isSelfMade).length;
    const fullRefCount     = entries.filter(it => it.looksFullRef).length;
    const fullRefMatched   = entries.filter(it => it.looksFullRef && it.refMatched).length;
    const fullRefUnmatch   = entries.filter(it => it.looksFullRef && !it.refMatched).length;

    const figureCount      = entries.filter(it => it.kind === 'åœ–').length;
    const tableCount       = entries.filter(it => it.kind === 'è¡¨').length;
    const tableImageInline = entries.filter(it => it.kind === 'è¡¨' && it.hasSourceLine && /åœ–ç‰‡ä¾†æº[:ï¼š]/.test(it.sourceLine)).length;

    const parts = [
      `æª¢å‡ºåœ–/è¡¨ï¼š${totalFT} é …`,
      `å°±è¿‘ä¾†æºè¡Œï¼š${sourceLineCount} é …`,
      `è¡¨å…§å·²å¼•æ³¨ï¼š${tableInlineOK} é …`,
      `åœ–å…§å·²å¼•æ³¨ï¼š${figureInlineOK} é …`,
      `è‡ªè£½/è‡ªç¹ªï¼š${selfMadeCount} é …`,
      `åˆ¤å®šç¼ºä¾†æºï¼š${lackSource ? 'æ˜¯' : 'å¦'}`,
      `åˆ¤å®šç¼ºæ¨™è™Ÿï¼š${lackLabel ? 'æ˜¯' : 'å¦'}`
    ];

    let suggest = 'åœ–æˆ–è¡¨ä¸Šæ–¹ç½®å·¦æ¨™è™Ÿ+æ¨™é¡Œï¼›ä¸‹æ–¹æ¨™ç¤ºã€Œè³‡æ–™ä¾†æºï¼šâ€¦ã€ã€‚è‹¥æ–¼åœ–/è¡¨å…§å·²ï¼ˆä½œè€…ï¼Œå¹´ä»½ï¼‰å¼•æ³¨ï¼Œå¯è¦–ç‚ºå·²æä¾›ä¾†æºã€‚';
    if (fullRefUnmatch > 0) {
      const samples = entries
        .filter(it => it.looksFullRef && !it.refMatched)
        .slice(0, 3)
        .map(it => `ã€Œ${it.sourceContent.slice(0, 60)}â€¦ã€`)
        .join('ï¼›');
      suggest += ` æª¢æ¸¬åˆ°æœ‰å®Œæ•´åƒè€ƒæ–‡ç»å»æœªå‡ºç¾åœ¨ã€Œé™¸ã€åƒè€ƒæ–‡ç»ã€ï¼š${samples}ã€‚è«‹æŠŠé€™äº›æ–‡ç»è£œé€²ã€Œé™¸ã€åƒè€ƒæ–‡ç»ã€ã€‚`;
    }

    addRow(
      'åœ–è¡¨éœ€æœ‰æ¨™è™Ÿ/æ¨™é¡Œèˆ‡ä¾†æº',
      figPass,
      parts.join('ï½œ') + '<br/>' +
        (`åœ–ï¼š${figureCount} é …ï½œè¡¨ï¼š${tableCount} é …`) + '<br/>' +
        (`è¡¨å…§åœ–ç‰‡å¼•æ³¨ï¼š${tableImageInline} é …`),
      suggest
    );
  })();

  // ä¸€è‡´æ€§
  // === åƒè€ƒæ–‡ç»èˆ‡å…§æ–‡å¼•è¨»ä¸€è‡´æ€§ï¼ˆå‡ç´šç‰ˆï¼‰ ===
// 1) æ”¶é›†ã€Œæ­£æ–‡ä¸­çš„ã€å„å¼å¼•è¨»
const citePatterns = [
  // ä¸­æ–‡ï¼šæ‹¬è™Ÿå…§å–®/å¤šä½œè€…ã€æˆ–å«ã€Œç­‰/ç„¡æ—¥æœŸ/n.d.ã€
  /ï¼ˆ[^\n()ï¼Œ]{1,20}(?:ã€|å’Œ)[^\n()ï¼Œ]{1,20}(?:(?:ã€|å’Œ)[^\n()ï¼Œ]{1,20}){0,6}ï¼Œ\s*(\d{4}|ç„¡æ—¥æœŸ|n\.?d\.?)ï¼‰/g, // å¤šä½œè€…
  /ï¼ˆ[^\n()ï¼Œ]{1,40}(?:ç­‰)?ï¼Œ\s*(\d{4}|ç„¡æ—¥æœŸ|n\.?d\.?)ï¼‰/g,                                                // å–®ä½œè€…/ç­‰
  // ä¸­æ–‡ï¼šä½œè€…åœ¨å‰
  /[^\sï¼Œã€‚ã€]{1,20}(?:ã€[^\sï¼Œã€‚ã€]{1,20}){0,6}ï¼ˆ\s*(\d{4}|ç„¡æ—¥æœŸ|n\.?d\.?)\s*ï¼‰/g,
  // è‹±æ–‡ï¼šæ‹¬è™Ÿå…§/ä½œè€…åœ¨å‰ï¼Œå« and/&/et al. èˆ‡ n.d.
  /\(\s*[A-Z][A-Za-z.\s'\-]{0,40}(?:\s*(?:,|and|&)\s*[A-Z][A-Za-z.\s'\-]{0,40}){0,6}(?:\s*et al\.)?\s*,\s*(\d{4}|n\.?d\.)\s*\)/g,
  /[A-Z][A-Za-z.\s'\-]{0,40}(?:\s*(?:,|and|&)\s*[A-Z][A-Za-z.\s'\-]{0,40}){0,6}(?:\s*et al\.)?\s*\(\s*(\d{4}|n\.?d\.)\s*\)/g
];

const citationHits = [];
for (const re of citePatterns) {
  const m = bodyText.match(re);
  if (m) citationHits.push(...m);
}

// æŠŠæ¯å€‹å‘½ä¸­çš„ã€Œä½œè€…ç¾¤ + å¹´ä»½ã€è®Šæˆå¯æ¯”å°çš„ keyï¼ˆåªç•™ä½œè€…å­—æ¯/ä¸­æ–‡å­— + å¹´ä»½/n.d./ç„¡æ—¥æœŸï¼‰
// å…§æ–‡å‘½ä¸­çš„ä½œè€…-å¹´ä»½ â†’ çµ±ä¸€æˆå¹´ä»½ key
// â€”â€” æ–°å¢ï¼šæŠŠå¸¸è¦‹ç•°é«”å­—/é›œè¨Šçµ±ä¸€ï¼ˆä½œè€…åå­—ç”¨ï¼‰
// æ›´å¼·çš„é›¶å¯¬å­— / é›œè¨Šæ¸…ç†
function _stripZW(s) {
  return String(s || '')
    .replace(/[\u200B-\u200D\uFEFF]/g, '') // é›¶å¯¬å­—
    .replace(/\u00A0/g, ' ')               // ä¸æ›è¡Œç©ºç™½ â†’ ä¸€èˆ¬ç©ºç™½
    .trim();
}

// ä½œè€…æ­£è¦åŒ–ï¼šæ¸…é™¤æ¨™é»ã€æŠŠå…¨å½¢ç©ºç™½/é»è™Ÿå»æ‰ï¼Œåƒ…ä¿ç•™ä¸­è‹±æ•¸
function _canonAuthorName(raw) {
  if (!raw) return '';
  let s = _stripZW(raw);

  // å¸¸è¦‹å…¨å½¢æ‹¬è™Ÿ/é»è™Ÿæ”¹æˆç©ºç™½ï¼Œé¿å…è¢«ç•¶ä½œä½œè€…å­—çš„ä¸€éƒ¨åˆ†
  s = s.replace(/[ã€Šã€‹ã€ˆã€‰ã€Œã€ã€ã€ã€ã€‘\[\]ï¼ˆï¼‰()ï¼Œã€ï¼ã€‚ãƒ»ãƒ»â€§â€¢Â·]/g, ' ');

  // åªä¿ç•™ï¼šæ¼¢å­—ã€å­—æ¯ã€æ•¸å­—ï¼ˆåˆä½µå¤šé‡ç©ºç™½ï¼‰
  s = s.replace(/[^\p{sc=Han}\p{Alphabetic}\p{Number}]+/gu, ' ')
       .replace(/\s+/g, ' ')
       .trim()
       .toLowerCase();
  return s;
}

// ç”Ÿæˆã€Œå¼•è¨»ã€çš„æ¯”å° keyï¼šä½œè€…(ç¬¬ä¸€å€‹) + å¹´ä»½(å››ä½)
function normCiteKey(text) {
  const s = _stripZW(text);

  // å–ï¼ˆä½œè€…ï¼Œå¹´ä»½ï¼‰å…§æ–‡
  const m = s.match(/ï¼ˆ([^ï¼Œ,]+)[ï¼Œ,]\s*([12]\d{3})\s*ï¼‰/); // æŠ“ç¬¬ä¸€å€‹ä½œè€… & 4ä½å¹´
  if (!m) return null;

  const authorRaw = m[1];
  const year = m[2];

  const author = _canonAuthorName(authorRaw);
  if (!author || !year) return null;

  // è‹±æ–‡ä½œè€…å–é¦–å­—æ¯ï¼›ä¸­æ–‡æ©Ÿé—œ/ä¸­æ–‡åå–å…¨å
  const authorKey = /^[a-z]+$/.test(author) ? author[0] : author;
  return `${authorKey}#${year}`;
}

// ç”Ÿæˆã€Œåƒè€ƒæ–‡ç»é …ç›®ã€çš„æ¯”å° keyï¼šç¬¬ä¸€ä½œè€…(æˆ–æ©Ÿæ§‹) + å¹´ä»½(å››ä½)
function normRefKeyForCite(refLine) {
  const s = _stripZW(refLine);

  // å–ç¬¬ä¸€å€‹ä½œè€…/æ©Ÿæ§‹ï¼ˆå¥é¦–åˆ°ç¬¬ä¸€å€‹æ‹¬è™Ÿå‰ï¼‰
  const mAuthor = s.match(/^([^ï¼ˆ(]+?)\s*ï¼ˆ/);
  if (!mAuthor) return null;
  const authorRaw = mAuthor[1];

  // å–æ‹¬è™Ÿå…§å¹´ä»½ï¼ˆå…è¨±æœ‰å¹´/æœˆ/æ—¥ï¼‰
  const mYear = s.match(/ï¼ˆ\s*(ç„¡æ—¥æœŸ|n\.?d\.?|([12]\d{3})(?:å¹´\d{1,2}æœˆ\d{1,2}æ—¥)?)\s*ï¼‰/i);
  let year = '';
  if (mYear) {
    if (/ç„¡æ—¥æœŸ|n\.?d\.?/i.test(mYear[1])) year = 'nd';
    else year = (mYear[2] || '').slice(0, 4);
  }
  if (!year) {
    // å¾Œå‚™ï¼šæŠ“å››ä½æ•¸å¹´
    const y2 = s.match(/([12]\d{3})/);
    year = y2 ? y2[1] : '';
  }
  if (!year) return null;

  const author = _canonAuthorName(authorRaw);
  const authorKey = /^[a-z]+$/.test(author) ? author[0] : author;
  return `${authorKey}#${year}`;
}

const citeKeys = citationHits.map(normCiteKey);

const refKeys = refEntries.map(normRefKeyForCite);

// 3) äº¤å‰æ¯”å°
let linked = 0;
for (const k of citeKeys) {
  if (refKeys.includes(k)) linked++;
}
const unlinkedInText = Math.max(0, citeKeys.length - linked);

// åå‘ï¼šæ–‡ç»åœ¨æ¸…å–®è£¡ï¼Œä½†æ­£æ–‡æ²’å‡ºç¾
const reverseUnlinked = refKeys.filter(k => !citeKeys.includes(k)).length;

// === åƒè€ƒæ–‡ç»èˆ‡å…§æ–‡å¼•è¨»ä¸€è‡´æ€§ï¼ˆæ“´å……ï¼šåˆ—å‡ºæœªå°æ‡‰æ¸…å–® + å¯«å…¥ JSONï¼‰ ===
{
  // 1) å…ˆç…§èˆŠè¨ˆç®—çµ±è¨ˆ
  let linked = 0;
  for (const k of citeKeys) {
    if (refKeys.includes(k)) linked++;
  }
  const unlinkedInText = Math.max(0, citeKeys.length - linked);
  const reverseUnlinked = refKeys.filter(k => !citeKeys.includes(k)).length;

  // 2) ç”¢ç”Ÿã€Œæ¸…å–®ã€
  // 2-1 å…§æ–‡å‘½ä¸­çš„å¼•æ–‡è£¡ï¼Œå“ªäº›æ²’æœ‰å°åˆ°åƒè€ƒæ–‡ç»
  const unmatchedCitations = [];
  for (const hit of citationHits) {
    const k = normCiteKey(hit);
    if (!refKeys.includes(k)) unmatchedCitations.push(hit);
  }
  // å»é‡ï¼›ä¿ç•™å‰ 30 ç­†
  const uniqUnmatchedCites = Array.from(new Set(unmatchedCitations)).slice(0, 30);

  // 2-2 åƒè€ƒæ–‡ç»æ¸…å–®è£¡ï¼Œå“ªäº›æ²’æœ‰å‡ºç¾åœ¨å…§æ–‡ï¼ˆåŒæ™‚é™„ä¸Šç´¢å¼•ï¼‰
  const unreferencedRefs = refEntries
    .map((text, i) => ({ index: i + 1, text, key: refKeys[i] }))
    .filter(x => !citeKeys.includes(x.key))
    .slice(0, 50); // æœ€å¤šåˆ— 50 ç­†

  // 3) æ˜¯å¦é€šéï¼ˆç¶­æŒä½ åŸè¦å‰‡ï¼šå…§æ–‡â†’æ–‡ç»è¦ 0ï¼Œæ–‡ç»â†’å…§æ–‡å…è¨± <=1ï¼‰
  const passConsistency = (unlinkedInText === 0 && reverseUnlinked <= 1);

  // 4) çµ„å‡º evidence ç‰©ä»¶ï¼ˆå¯«å…¥ JSONï¼‰
  const evidenceObj = {
    note: `å¼•è¨»å…± ${citeKeys.length}ï¼›å°æ‡‰ ${linked}ï¼›æœªå°æ‡‰ï¼ˆå…§æ–‡â†’æ–‡ç»ï¼‰${unlinkedInText}ï¼›ç–‘ä¼¼æœªè¢«å¼•ç”¨ï¼ˆæ–‡ç»â†’å…§æ–‡ï¼‰${reverseUnlinked}`,
    stats: {
      total_citations: citeKeys.length,
      linked,
      unmatched_in_text: unlinkedInText,
      unreferenced_refs: reverseUnlinked
    },
    unmatched_citations: uniqUnmatchedCites,   // æœƒæ”¾åŸå§‹å‘½ä¸­çš„æ¨£å¼å­—ä¸²ï¼Œå¦‚ï¼šï¼ˆç‹å°æ˜ï¼Œ2021ï¼‰
    unreferenced_refs: unreferencedRefs        // ç‰©ä»¶ï¼š{index, text}
  };

  // 5) æŠŠ evidence ç‰©ä»¶ä¸Ÿçµ¦ addRowï¼ˆJSON æœƒå¸¶åˆ° #jsonPreviewï¼‰
  addRow(
    'åƒè€ƒæ–‡ç»èˆ‡å…§æ–‡å¼•è¨»ä¸€è‡´æ€§',
    passConsistency,
    evidenceObj,
    'å…§æ–‡å‡ºç¾ä¹‹å¼•ç”¨éœ€åœ¨åƒè€ƒæ–‡ç»å‡ºç¾ï¼›æœªå¼•ç”¨è€…ä¸å¾—åˆ—å…¥åƒè€ƒæ–‡ç»ã€‚'
  );

  // 6) é¡¯ç¤ºä¸€å€‹ã€Œå­è¡Œã€ï¼šæŠŠæœªå°æ‡‰æ¸…å–®ç›´è¦ºåˆ—çµ¦è€å¸«/å­¸ç”Ÿçœ‹ï¼ˆåªåœ¨æœ‰é …ç›®æ™‚å‡ºç¾ï¼‰
  if (uniqUnmatchedCites.length || unreferencedRefs.length) {
    const sub = document.createElement('tr');
    const citeList = uniqUnmatchedCites
      .slice(0, 10) // ç•«é¢æœ€å¤šé¡¯ç¤º 10 ç­†ï¼ˆå®Œæ•´æ¸…å–®åœ¨ JSONï¼‰
      .map(s => `<li class="mono">${_escapeHtml(s)}</li>`).join('') || '<li class="mono">ï¼ˆç„¡ï¼‰</li>';

    const refList = unreferencedRefs
      .slice(0, 10)
      .map(x => `<li class="mono">#${x.index} ${_escapeHtml(x.text)}</li>`).join('') || '<li class="mono">ï¼ˆç„¡ï¼‰</li>';

    sub.innerHTML = `
      <td></td>
      <td colspan="3">
        <div class="hint"><b>â†³ æœªå°æ‡‰å¼•æ–‡ï¼æœªè¢«å¼•ç”¨æ–‡ç»</b></div>
        <div style="display:flex;gap:24px;flex-wrap:wrap;margin-top:6px">
          <div style="min-width:280px">
            <div class="hint">å…§æ–‡å¼•æ–‡æœªå°æ‡‰åˆ°åƒè€ƒæ–‡ç»ï¼ˆå‰ 10 ç­†ï¼‰ï¼š</div>
            <ol style="margin:6px 0 0 20px">${citeList}</ol>
          </div>
          <div style="min-width:280px">
            <div class="hint">åƒè€ƒæ–‡ç»ç–‘ä¼¼æœªè¢«å¼•ç”¨ï¼ˆå‰ 10 ç­†ï¼‰ï¼š</div>
            <ol style="margin:6px 0 0 20px">${refList}</ol>
          </div>
        </div>
        <div class="hint" style="margin-top:6px">
          å®Œæ•´æ¸…å–®å·²å¯«å…¥æœ¬æ¬¡æª¢æŸ¥ JSONï¼ˆæ¬„ä½ï¼š<code>unmatched_citations</code>ã€<code>unreferenced_refs</code>ï¼‰ã€‚
        </div>
      </td>`;
    tbody.appendChild(sub);
  }
}

  // ä¾†æºä¸å¯å…¨ç‚ºç¶²è·¯
  const nonAllWebPass = (A_total > 0) && (webCount < A_total);
  const evidence16 = [
    `åˆ†é¡ â†’ éç¶²è·¯ ${nonwebCount}ï½œç´”ç¶²è·¯ ${webCount}ï½œç¸½æ•¸ ${A_total}`,
    `ï¼ˆæª¢æŸ¥ç¸½æ•¸é‡ï¼š${A_total}ï½œåˆæ ¼ï¼š${qualifiedCount}ï½œä¸åˆæ ¼ï¼š${unqualifiedCount}ï¼‰`
  ].join('ï½œ');
  addRow(
  'åƒè€ƒæ–‡ç»ä¾†æºä¸å¯å…¨ç‚ºç¶²è·¯',
   nonAllWebPass,
   evidence16,
   nonAllWebPass
    ? 'è‡³å°‘ä¿ç•™ 1 ç­†éç´”ç¶²è·¯ä¾†æºï¼ˆæ›¸ç±/æœŸåˆŠ/è«–æ–‡/å ±ç´™/æœƒè­°/æ³•è¦ç­‰ï¼‰ã€‚'
    : `è‡³å°‘ä¿ç•™ 1 ç­†éç´”ç¶²è·¯ä¾†æºï¼ˆæ›¸ç±/æœŸåˆŠ/è«–æ–‡/å ±ç´™/æœƒè­°/æ³•è¦ç­‰ï¼‰ã€‚
       <div class="hint" style="margin-top:4px;">
         ğŸ’¡ <b>èªªæ˜ï¼š</b>è«‹è‡³å°‘åŒ…å« 1 ç­†æ›¸ç±ã€æœŸåˆŠã€å­¸ä½è«–æ–‡ã€å ±ç´™æˆ–æ³•è¦ç­‰éç¶²è·¯ä¾†æºã€‚
         è‹¥å…¨ç‚ºç¶²ç«™ã€æ–°èæˆ–éƒ¨è½æ ¼ç­‰ç¶²è·¯è³‡æºï¼Œå°‡ä¸ç¬¦åˆæ¯”è³½è¦å®šã€‚
       </div>`
);

  // å­—é«” mirror
  syncBasicFontRuleMirror();

  // å¤–éƒ¨æª¢ç´¢åŠ©æ‰‹
  const extEvidence=buildExternalSearchEvidence(fileBase||'å°è«–æ–‡ç¯‡å');
  addRow('ä½œå“æ˜¯å¦å·²æ–¼æ ¡å¤–ç™¼è¡¨/å¾—çï¼ˆéœ€äººå·¥/GPTï¼‰',true,extEvidence,'ä½¿ç”¨ä¸‹æ–¹ã€Œå¤–éƒ¨æª¢ç´¢åŠ©æ‰‹ã€æˆ–ã€Œè¤‡è£½æŸ¥æ ¸æç¤ºã€è‡³ AI å°åŠ©æ‰‹é€²è¡Œç¢ºèªã€‚');
  setTimeout(()=>initExternalSearchAssist(fileBase||'å°è«–æ–‡ç¯‡å'),0);
}

/* ===== å¤–éƒ¨æª¢ç´¢åŠ©æ‰‹ï¼ˆä¿ç•™åŸæ¨£ï¼‰ ===== */
function buildExternalSearchEvidence(baseTitle){
  const t=(baseTitle||'å°è«–æ–‡ç¯‡å').trim(), mk=s=>encodeURIComponent(s);
  const items=[
    {label:'Google Scholarï¼ˆç¹ä¸­ï¼‰',href:`https://scholar.google.com/scholar?hl=zh-TW&q=${mk(t)}`,q:`${t}`},
    {label:'Googleï¼šé¡Œå + å°è«–æ–‡ å¾—ç',href:`https://www.google.com/search?q=${mk(t+' å°è«–æ–‡ å¾—ç')}`,q:`${t} å°è«–æ–‡ å¾—ç`},
    {label:'Googleï¼šé¡Œå + å°ˆé¡Œè£½ä½œ æ¯”è³½ æ­·å±† ä½œå“',href:`https://www.google.com/search?q=${mk(t+' å°ˆé¡Œè£½ä½œ æ¯”è³½ æ­·å±† ä½œå“')}`,q:`${t} å°ˆé¡Œè£½ä½œ æ¯”è³½ æ­·å±† ä½œå“`},
    {label:'Googleï¼šé¡Œå + site:shs.edu.tw',href:`https://www.google.com/search?q=${mk(t+' site:shs.edu.tw')}`,q:`${t} site:shs.edu.tw`},
    {label:'Googleï¼šé¡Œå + site:edu.tw å°è«–æ–‡',href:`https://www.google.com/search?q=${mk(t+' site:edu.tw å°è«–æ–‡')}`,q:`${t} site:edu.tw å°è«–æ–‡`}
  ];
  const links=items.map((it,i)=>`<li class="mono">#${i+1} ${it.label}ï¼š<a data-extlink href="${it.href}" target="_blank" rel="noopener">${it.q}</a></li>`).join('');
  return `<div id="extSearchPanel" class="extsearch"><div class="row"><button id="btnOpenAllSearch">ä¸€éµé–‹å•Ÿæ‰€æœ‰æœå°‹</button><button id="btnCopyGptPrompt" class="primary">è¤‡è£½æŸ¥æ ¸æç¤ºï¼ˆçµ¦ AIå°åŠ©æ‰‹ï¼‰</button></div><div class="hint" style="margin-top:6px">ä»¥ä¸‹ç‚ºè‡ªå‹•ç”Ÿæˆçš„æŸ¥è©¢ï¼ˆå³å°‡æª¢ç´¢çš„å…§å®¹ï¼‰ï¼š</div><ul style="margin-top:6px">${links}</ul></div>`;
}
function initExternalSearchAssist(baseTitle){
  const panel=document.getElementById('extSearchPanel'); if(!panel)return;
  const btnOpen=panel.querySelector('#btnOpenAllSearch'), btnCopy=panel.querySelector('#btnCopyGptPrompt');
  btnOpen?.addEventListener('click',()=>{panel.querySelectorAll('a[data-extlink]').forEach(a=>window.open(a.href,'_blank','noopener'));});
  btnCopy?.addEventListener('click',async()=>{
    const t=(baseTitle||'å°è«–æ–‡ç¯‡å').trim();
    const qsEls=panel.querySelectorAll('a[data-extlink]'); const qs=Array.from(qsEls).map((a,i)=>`(${i+1}) ${a.textContent} -> ${a.href}`).join('\n');
    const summary=(typeof lastSummaryJSON==='object'&&lastSummaryJSON)?JSON.stringify(lastSummaryJSON,null,2):(document.getElementById('jsonPreview')?.textContent||'');
    const prompt=`è«‹å”åŠ©é€²è¡Œã€Œæ ¡å¤–ç™¼è¡¨ï¼å¾—çã€å¤–éƒ¨æª¢ç´¢ç¢ºèªï¼š
é¡Œå/æª”åï¼š${t}

è«‹åˆ°ä»¥ä¸‹ä¾†æºæª¢ç´¢ä¸¦å½™æ•´å‰ 10 ç­†çµæœï¼ˆæ¨™é¡Œã€ä¾†æºã€å¹´ä»½ã€é€£çµï¼‰ï¼ŒåŒæ™‚åˆ¤æ–·æ˜¯å¦ç–‘ä¼¼ç›¸åŒé¡Œåä¹‹å…¬é–‹ç™¼è¡¨æˆ–å¾—çç´€éŒ„ï¼š
1) Google Scholarï¼ˆç¹ä¸­ï¼‰
2) Google é—œéµå­—ï¼šé¡Œå +ã€Œå°è«–æ–‡ å¾—çã€ã€é¡Œå +ã€Œå°ˆé¡Œè£½ä½œ æ¯”è³½ æ­·å±† ä½œå“ã€
3) Google é™ç«™ï¼šsite:shs.edu.twã€site:edu.tw å°è«–æ–‡

è«‹ç”¨è¡¨æ ¼ï¼‹æ¢åˆ—è¼¸å‡ºï¼›æœ€å¾Œçµ¦ã€Œæ˜¯å¦æŸ¥åˆ°ç–‘ä¼¼ç›¸åŒé¡Œåã€çµè«–èˆ‡ç†ç”±ï¼Œä¸¦é™„ä¸Šå¯¦éš›ä½¿ç”¨çš„æŸ¥è©¢å­—ä¸²æ¸…å–®ã€‚

ï¼ˆé™„ï¼šæœ¬æ¬¡æª¢æŸ¥æ‘˜è¦ JSONï¼‰
${summary||'(è‹¥ç©ºç™½å¯å¿½ç•¥)'}

ï¼ˆæŸ¥è©¢å­—ä¸²èˆ‡é€£çµé è¦½ï¼‰
${qs}`;
    try{await navigator.clipboard.writeText(prompt);alert('å·²è¤‡è£½æŸ¥æ ¸æç¤ºï¼Œè«‹é»ã€Œæ‰“é–‹AIåŠ©æ‰‹ã€ä¸¦è²¼ä¸Šã€‚');}catch{alert('è¤‡è£½å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚')}
  });
}

/* ===== å·¥å…· & å ±å‘Š ===== */
function missingRange(okPages,total){const ok=new Set(okPages);const miss=[];for(let i=1;i<=total;i++){if(!ok.has(i))miss.push(i)}return miss.length?miss.join(', '):'â€”'}
// å°å·¥å…·ï¼šæŠŠ evidence ç‰©ä»¶è½‰æˆå¥½çœ‹çš„ HTML
function renderEvidence(evd){
  try{
    if (evd == null) return '';
    if (typeof evd === 'string') return evd;
    if (typeof evd !== 'object') return String(evd);

    const note = evd.note ? `<div>${_escapeHtml(evd.note)}</div>` : '';
    const pretty = _escapeHtml(JSON.stringify(evd, null, 2));
    return `${note}
      <details style="margin-top:6px">
        <summary class="mono" style="cursor:pointer">é¡¯ç¤ºå®Œæ•´ evidence JSON</summary>
        <pre class="mono" style="white-space:pre-wrap;max-height:280px;overflow:auto">${pretty}</pre>
      </details>`;
  }catch(e){
    return String(evd);
  }
}

// âœ… æ–°ç‰ˆ addRowï¼šæ”¯æ´ç‰©ä»¶ evidenceã€å±•é–‹ JSONã€é¿å… [object Object]
function addRow(rule,pass,evidence,suggestion){
  const tr=document.createElement('tr');
  const badge=pass?'<span class="ok">é€šé</span>':'<span class="bad">æœªé€šé</span>';
  const evdHtml = renderEvidence(evidence);
  tr.innerHTML=`<td><span class="num">${++_ruleCounter}</span>${rule}</td><td>${badge}</td><td>${evdHtml}</td><td>${suggestion||''}</td>`;
  tbody.appendChild(tr);

  // ä»¥ä¸‹æ˜¯åŸæœ¬çš„è¦å‰‡å°æ‡‰è¡¨ï¼ˆåŸå°ä¸å‹•ä¿ç•™ï¼‰
  const map={
    'é æ•¸ 4â€“10':{rule_id:'file.pages',category:'æª”æ¡ˆè¦æ ¼',severity:'critical'},
    'é¦–é ç¯‡åéœ€ç½®ä¸­ä¸”è½åœ¨è·ä¸Šç·£ 2 å…¬åˆ†å…§':{rule_id:'header.topmargin_firstpage',category:'é é¦–',severity:'critical'},
    'é¦–é é ç¢¼éœ€ç½®ä¸­ä¸”è½åœ¨è·ä¸‹ç·£ 2 å…¬åˆ†å…§':{rule_id:'footer.bottommargin_firstpage',category:'é ç¢¼',severity:'critical'},
    'æª”æ¡ˆåç¨±èˆ‡é é¦–ç¯‡åä¸€è‡´ï¼ˆä¸ç¬¦åˆ¤å®šæ·˜æ±°ï¼‰':{rule_id:'filename.title_consistency',category:'å‘½å',severity:'critical'},
    'æ¯é éœ€æœ‰ç½®ä¸­é ç¢¼ï¼ˆåº•ç«¯å¸¶ï¼‰':{rule_id:'footer.pagenum',category:'é ç¢¼',severity:'critical'},
    'å››å‘¨é‚Šç•Œ â‰¥ 2 å…¬åˆ†ï¼ˆæ­£æ–‡å€æ¨ä¼°ï¼‰':{rule_id:'layout.margins',category:'ç‰ˆé¢',severity:'major'},
    'ä¸å¾—æœ‰å°é¢é ï¼ˆ4â€“10é ï¼‰':{rule_id:'file.coverpage',category:'æª”æ¡ˆè¦æ ¼',severity:'critical'},
    'ä¸å¾—å«æ ¡å/å§“å':{rule_id:'privacy.no_school_or_name',category:'éš±ç§',severity:'critical'},
    'å…­å¤§æ®µè½ä¾åº':{rule_id:'structure.sections_order',category:'çµæ§‹',severity:'critical'},
    'å…§æ–‡å¼•è¨»æ¡ ä½œè€…-å¹´ä»½':{rule_id:'references.citation_style',category:'åƒè€ƒæ–‡ç»',severity:'major'},
    [`ç›´æ¥å¼•æ–‡ â‰¤ ${RULES.quoteMaxChars} å­—ï¼ˆä¸å«æ¨™é»èˆ‡ç©ºç™½ï¼‰`]:{rule_id:'quotes.limit',category:'å¼•æ–‡',severity:'major'},
    'åœ–è¡¨éœ€æœ‰æ¨™è™Ÿ/æ¨™é¡Œèˆ‡ä¾†æº':{rule_id:'figures.tables',category:'åœ–è¡¨',severity:'major'},
    'åƒè€ƒæ–‡ç» â‰¥ 3':{rule_id:'references.count',category:'åƒè€ƒæ–‡ç»',severity:'critical'},
    'åƒè€ƒæ–‡ç»èˆ‡å…§æ–‡å¼•è¨»ä¸€è‡´æ€§':{rule_id:'references.consistency',category:'åƒè€ƒæ–‡ç»',severity:'critical'},
    'åƒè€ƒæ–‡ç»ä¾†æºä¸å¯å…¨ç‚ºç¶²è·¯':{rule_id:'references.non_all_web',category:'åƒè€ƒæ–‡ç»',severity:'critical'},
    'å­—é«”/å­—å‹è¦ç¯„ï¼ˆéœ€äººå·¥ç¢ºèªï¼‰':{rule_id:'style.font',category:'ç‰ˆé¢',severity:'major'},
    'ä½œå“æ˜¯å¦å·²æ–¼æ ¡å¤–ç™¼è¡¨/å¾—çï¼ˆéœ€äººå·¥/GPTï¼‰':{rule_id:'external.duplicate_check',category:'äººå·¥æª¢æŸ¥',severity:'minor'},
    'é æ•¸ 4â€“10ï¼ˆDOCXï¼‰':{rule_id:'file.pages.docx',category:'æª”æ¡ˆè¦æ ¼',severity:'minor'},
    'Cloud Run å­—é«”å­—å‹æª¢æŸ¥':{rule_id:'fontcheck.cloudrun',category:'å­—é«”å­—å‹',severity:'major'}
  };

  const meta=map[rule]||{rule_id:'misc',category:'å…¶ä»–',severity:'minor'};
  _rowsBuffer.push({
    rule_id:meta.rule_id,
    category:meta.category,
    severity:meta.severity,
    pass,
    evidence:(typeof evidence==='string'?{note:evidence}:(evidence||null)),
    suggestion:suggestion||null
  });
}

function buildAndShowSummaryJSON({fileName='paper',pages=0,passFailRows=[]}={}){
  const weight=x=>x.severity==='critical'?2:(x.severity==='major'?1:0.5);
  const max=passFailRows.reduce((a,x)=>a+weight(x),0)||1; const score=Math.round(passFailRows.reduce((a,x)=>a+(x.pass?weight(x):0),0)/max*100);
  const hasCriticalFail=passFailRows.some(x=>!x.pass && x.severity==='critical'); const status=hasCriticalFail?'revise':'pass';
  const summary={meta:{report_id:(crypto.randomUUID?.()||String(Math.random()).slice(2)),generated_at:new Date().toISOString(),file:{name:fileName,pages,type:fileExt},rules_version:'v1.4'},
    summary:{score,totals:{checks:passFailRows.length,pass:passFailRows.filter(x=>x.pass).length,fail:passFailRows.filter(x=>!x.pass).length},status},
    checks:passFailRows.map(x=>({rule_id:x.rule_id,category:x.category,severity:x.severity,pass:x.pass,evidence:x.evidence||null,suggestion:x.suggestion||null}))};
  lastSummaryJSON=summary; jsonPreview.textContent=JSON.stringify(summary,null,2);
}
function syncBasicFontRuleMirror(){
  if(_fontCheckMirror){
    addRow('å­—é«”/å­—å‹è¦ç¯„ï¼ˆéœ€äººå·¥ç¢ºèªï¼‰',_fontCheckMirror.pass, `ï¼ˆåŒæ­¥é€²éšæª¢æŸ¥ï¼‰${_fontCheckMirror.evidence||''}`, _fontCheckMirror.suggestion||'');
  }else{
    addRow('å­—é«”/å­—å‹è¦ç¯„ï¼ˆéœ€äººå·¥ç¢ºèªï¼‰',true,'å»ºè­°ï¼šä¸­æ–‡æ–°ç´°æ˜é«” 12ptï¼›è‹±æ–‡ Times New Roman 12ptï¼›é»‘è‰²å­—é«”ã€‚','è‹¥éœ€ç²¾ç¢ºæª¢æŸ¥è«‹ä½¿ç”¨ã€Œå­—é«”å­—å‹é€²éšæª¢æŸ¥ã€ã€‚');
  }
}

// å°‡ YYYYã€YYYYå¹´Mæœˆã€YYYYå¹´MæœˆDæ—¥ è½‰æˆã€ŒYYYYå¹´MæœˆDæ—¥ã€ï¼Œå¦å‰‡å›å‚³ null
function asFullZhDate(y, m, d){
  const yy = Number(y), mm = Number(m), dd = Number(d);
  if (!yy || !mm || !dd) return null;
  return `${yy}å¹´${mm}æœˆ${dd}æ—¥`;
}

/* ===== ä¸‹è¼‰/è¤‡è£½ ===== */
downloadHtmlBtn.addEventListener('click',()=>{
  const html='<!doctype html><meta charset="utf-8"><title>å°è«–æ–‡æª¢æŸ¥å ±å‘Š</title>'+document.querySelector('#resultCard').outerHTML;
  const blob=new Blob([html],{type:'text/html;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='paper-check-report.html';a.click();URL.revokeObjectURL(a.href);
});
copyBtn.addEventListener('click',async()=>{if(!lastSummaryJSON){alert('å°šæœªç”¢ç”Ÿæª¢æŸ¥æ‘˜è¦ã€‚');return;}await navigator.clipboard.writeText(JSON.stringify(lastSummaryJSON,null,2));alert('å·²è¤‡è£½æª¢æŸ¥æ‘˜è¦ JSONï¼Œå‰å¾€ AIåŠ©æ‰‹ å¾Œç›´æ¥è²¼ä¸Šå³å¯ã€‚')});
downloadJsonBtn.addEventListener('click',()=>{if(!lastSummaryJSON){alert('å°šæœªç”¢ç”Ÿæª¢æŸ¥æ‘˜è¦ã€‚');return;}const blob=new Blob([JSON.stringify(lastSummaryJSON,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download((lastSummaryJSON.meta?.file?.name||'paper')+'.summary.json');a.click();URL.revokeObjectURL(a.href);});

/* ===== GAS è¨ˆæ•¸ï¼ˆGET ç‰ˆï¼‰ ===== */
async function bumpCounterEveryTime(){
  if (!ENABLE_COUNTER) return;
  try{
    // æ”¹ç”¨ GETï¼šé¿å…é æª¢ï¼ˆOPTIONSï¼‰
    const url = GAS_WEB_APP_URL + (GAS_WEB_APP_URL.includes('?') ? '&' : '?') +
                'action=increment&ts=' + Date.now();
    const res = await fetch(url, { method: 'GET', cache: 'no-store' });
    console.log('counter increment', res.status);
  }catch(e){
    console.warn('counter increment failed', e);
  }
}

async function fetchCounter() {
  if (!ENABLE_COUNTER) return;
  try {
    const url = GAS_WEB_APP_URL + '?action=get&site=essayguard&ts=' + Date.now();
    const res = await fetch(url, { cache: 'no-store' });
    const data = await res.json().catch(() => ({}));
    counterEl.textContent = data.count ?? '0';
  } catch (e) {
    console.warn('counter get failed', e);
    counterEl.textContent = '0';
  }
}

/* ===== å¿«å–æ¸…ç†ï¼ˆé¿å… SW èˆŠæª”ï¼‰ ===== */
(async () => {
  try {
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) { await r.unregister(); }
    }
    if (window.caches?.keys) {
      const keys = await caches.keys();
      for (const k of keys) { await caches.delete(k); }
    }
  } catch (e) {}
})();

// é€æ¢æª¢æŸ¥ï¼šæŠŠä¸åˆæ ¼æ¸…å–®è¤‡è£½çµ¦ AI
document.addEventListener('click', (ev) => {
  const t = ev.target;
  if (!t || t.id !== 'btnCopyRefAudit') return;

  const audit = window.__refAudit || {};
  const items = Array.isArray(audit.items) ? audit.items : [];
  const bad = items.filter(x => !x.ok).map(x => ({
    idx: x.idx,
    text: x.text,
    reasons: x.reasons
  }));

  const payload = {
    references: {
      count: audit.stats?.total || 0,
      pass: audit.stats?.pass || 0,
      fail: audit.stats?.fail || 0,
      nonweb: audit.stats?.nonweb || 0,
      web: audit.stats?.web || 0,
      not_ok: bad
    }
  };

  const txt = JSON.stringify(payload, null, 2);
  navigator.clipboard.writeText(txt)
    .then(() => alert('âœ… å·²è¤‡è£½ã€Œä¸åˆæ ¼åƒè€ƒæ–‡ç»æ¸…å–®ã€åˆ°å‰ªè²¼ç°¿ï¼Œå¯ç›´æ¥è²¼çµ¦ AI å°åŠ©æ‰‹ã€‚'))
    .catch(() => alert('âš ï¸ ç„¡æ³•å­˜å–å‰ªè²¼ç°¿ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™ã€‚'));
});

/* ===== å–®ç¨ GPT æª¢æŸ¥ï¼ˆå°å‘å¤–éƒ¨/ç¨ç«‹é ï¼‰ ===== */
window.gptCheckBtn?.addEventListener('click', () => {
  const target = 'https://chatgpt.com/g/g-68c6d9e700c88191872154808e0e0e7b-gao-zhong-zhi-xiao-lun-wen-ge-shi-zi-jian-xi-tong';
  window.open(target, '_blank', 'noopener');
});

</script>
</body>
</html>